<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precast Production</title>
    <meta name="theme-color" content="#0f172a" />
    <!-- Favicons (small, quick set) -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@14.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; color: black !important; margin: 0 !important; padding: 0 !important; }
            html { background: white !important; }
            @page { size: portrait; margin: 5mm; }

            /* Delivery Note Print Layout */
            .dn-print-wrapper {
                padding-left: 10mm !important;
                padding-right: 10mm !important;
                min-height: 255mm !important;
                box-sizing: border-box !important;
                display: flex !important;
                flex-direction: column !important;
            }
            .dn-footer, .dn-footer * {
                color: #111 !important;
                font-weight: 700 !important;
                opacity: 1 !important;
                visibility: visible !important;
            }
            .dn-footer {
                display: block !important;
                position: relative !important;
                margin-top: auto !important;
                bottom: auto !important;
                left: auto !important;
                right: auto !important;
                width: 100% !important;
                page-break-inside: avoid !important;
                page-break-before: auto !important;
                margin-bottom: 0 !important;
            }
            .dn-footer h3, .dn-footer p {
                color: #111 !important;
                opacity: 1 !important;
            }
            .dn-title {
                border: none !important;
                box-shadow: none !important;
                background: transparent !important;
            }
            /* Table header/footer for print */
            thead { display: table-header-group; }
            tfoot { display: table-footer-group; }
            
            /* Allow content to flow across pages - EXCEPT delivery note */
            html, body { 
                height: auto !important; 
                overflow: visible !important;
                max-height: none !important;
            }
            
            /* Production Plan / Weekly Report - Enable multi-page printing */
            .print-container:not(.dn-print-wrapper) {
                max-height: none !important;
                height: auto !important;
                overflow: visible !important;
            }
            
            *, *::before, *::after {
                background-image: none !important;
                background: white !important;
                box-shadow: none !important;
                text-shadow: none !important;
            }
            .bg-white, div, section, main { background: white !important; background-color: white !important; }
            
            /* Production Plan / Weekly Report Print Styles */
            .weekly-report-header { page-break-after: avoid !important; margin-bottom: 2mm !important; }
            .weekly-report-header h1 { font-size: 16px !important; margin-bottom: 0.5mm !important; }
            .weekly-report-header h2 { font-size: 13px !important; margin-bottom: 0.5mm !important; }
            .weekly-report-header p { font-size: 10px !important; margin: 0 !important; }
            .weekly-project-section { 
                page-break-inside: auto !important;
                overflow: visible !important;
                height: auto !important;
                max-height: none !important;
                margin-bottom: 1mm !important;
                padding: 0 !important;
            }
            .project-header { 
                page-break-after: avoid !important; 
                padding: 1mm 2mm !important; 
                font-size: 10px !important;
                margin-bottom: 0.5mm !important;
                line-height: 1.1 !important;
            }
            .date-header { 
                page-break-after: avoid !important; 
                padding: 0.5mm 2mm !important; 
                font-size: 9px !important;
                margin-bottom: 0.5mm !important;
                line-height: 1.1 !important;
            }
            .weekly-report-table { 
                page-break-inside: auto !important; 
                font-size: 10px !important;
                overflow: visible !important;
                height: auto !important;
                margin-bottom: 1mm !important;
                border-spacing: 0 !important;
            }
            .weekly-report-table thead { display: table-header-group !important; }
            .weekly-report-table tbody { display: table-row-group !important; }
            .weekly-report-table tr { page-break-inside: avoid !important; page-break-after: auto !important; }
            .weekly-report-table th { 
                padding: 1mm 1.5mm !important; 
                font-size: 9px !important; 
                line-height: 1.1 !important;
                vertical-align: bottom !important;
            }
            .weekly-report-table td { 
                padding: 2mm 2mm !important; 
                font-size: 11px !important; 
                line-height: 1.1 !important;
                vertical-align: middle !important;
            }
            
            /* Ensure containers don't restrict height */
            .max-h-screen, [class*="max-h-"] { max-height: none !important; }
            .h-screen, [class*="h-screen"] { height: auto !important; }
            
            /* Project Summary - Fit on ONE page using scale */
            .project-summary-print {
                transform: scale(0.65) !important;
                transform-origin: top left !important;
                width: 154% !important;
                max-height: none !important;
                overflow: visible !important;
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
            }
        }
        /* Force Input Visibility */
        input, select, textarea { color: #0f172a !important; } 
        /* mobile helpers */
        .responsive-table { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .table-min-640 { min-width: 640px; }
        .table-min-800 { min-width: 800px; }
        @media (max-width: 640px) {
            .login-card { padding: 1.25rem !important; }
            .touch-btn { padding: .85rem 1rem !important; font-size: 1rem !important; }
            .no-print { display: none !important; }
        }

        /* App visual polish: consistent button styles & sidebar nav */
        .btn-primary { background-color: #2563eb; color: white; padding: .5rem 1rem; border-radius: .5rem; font-weight: 700; box-shadow: 0 6px 18px rgba(37,99,235,0.12); display: inline-flex; gap: .5rem; align-items: center; border: none; cursor: pointer; }
        .btn-primary:hover { background-color: #1e40af; }
        .btn-secondary { background-color: #059669; color: white; padding: .4rem .75rem; border-radius: .4rem; font-weight: 700; box-shadow: 0 4px 12px rgba(5,150,105,0.08); display: inline-flex; gap: .5rem; align-items: center; border: none; cursor: pointer; }
        .btn-secondary:hover { background-color: #047857; }
        .btn-outline { background: white; border: 1px solid rgba(148,163,184,1); color: #0f172a; padding: .4rem .75rem; border-radius: .4rem; font-weight: 700; display: inline-flex; gap: .5rem; align-items: center; cursor: pointer; }
        .btn-outline:hover { background: #f8fafc; }

        /* Slightly stronger sidebar nav accent for current view */
        .nav-item { width:100%; display:flex; align-items:center; gap: .75rem; padding: .75rem 1rem; border-radius: .75rem; color: #cbd5e1; transition: all .12s ease; }
        .nav-item:hover { background: rgba(255,255,255,0.03); }
        .nav-item.active { background: #0ea5e9; color: white; box-shadow: 0 6px 16px rgba(14,165,233,0.12); border-left: 4px solid rgba(125,211,252,1); }
        .nav-item .icon { width: 22px; height: 22px; color: rgba(203,213,225,1); }

        /* Tighter table header and card radius */
        .card { border-radius: 12px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-8 text-center">
                            <h1 className="text-2xl font-bold text-red-600 mb-4">Something went wrong.</h1>
                            <p className="text-slate-600 mb-4">{this.state.error?.message}</p>
                            <button onClick={() => window.location.reload()} className="bg-blue-600 text-white px-4 py-2 rounded">Reload Application</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- ICONS ---
        const Icon = ({ name, size=18, className="" }) => {
            const map = {
                hammer: "fa-hammer", truck: "fa-truck", fileText: "fa-file-lines", 
                folderPlus: "fa-folder-plus", plus: "fa-plus", upload: "fa-upload", 
                search: "fa-search", pencil: "fa-pen", trash: "fa-trash", 
                check: "fa-check", x: "fa-xmark", calendar: "fa-calendar-days", 
                filter: "fa-filter", print: "fa-print", save: "fa-floppy-disk", 
                spinner: "fa-spinner fa-spin", history: "fa-clock-rotate-left", 
                clipboard: "fa-clipboard-list", building: "fa-building", 
                fileExcel: "fa-file-excel", arrowRight: "fa-arrow-right", box: "fa-box-open",
                paste: "fa-paste", shield: "fa-shield-halved", hashtag: "fa-hashtag",
                bars: "fa-bars", list: "fa-list", info: "fa-circle-info"
            };
            return <i className={`fa-solid ${map[name] || 'fa-circle'} ${className}`} style={{fontSize: size}}></i>;
        };

        // --- APPWRITE CONFIG & FIREBASE SHIM ---
        const client = new Appwrite.Client();
        
        // TODO: Replace with your Appwrite details
        const ENDPOINT = 'https://nyc.cloud.appwrite.io/v1'; 
        const PROJECT_ID = '69356b960013d2a9d1d8';
        const DATABASE_ID = '69356e45002e114f104d'; // NOTE: If your Database ID is different, update this line
        
        client.setEndpoint(ENDPOINT).setProject(PROJECT_ID);
        const databases = new Appwrite.Databases(client);
        const account = new Appwrite.Account(client);

        // --- SHIM CLASSES ---
        const processDoc = (d) => {
            const data = { ...d };
            // Auto-parse known complex fields from JSON string to Object
            ['items', 'permissions'].forEach(field => {
                if (data[field] && typeof data[field] === 'string') {
                    try { data[field] = JSON.parse(data[field]); } catch (e) { console.warn('JSON parse error', field); }
                }
            });
            return { exists: true, data: () => data, id: d.$id, ...data };
        };

        const prepareData = (data) => {
            const payload = { ...data };
            // Auto-stringify known complex fields
            ['items', 'permissions'].forEach(field => {
                if (payload[field] && typeof payload[field] === 'object') {
                    payload[field] = JSON.stringify(payload[field]);
                }
            });
            // Ensure volume is always a number
            if ('volume' in payload) {
                const vol = parseFloat(payload.volume);
                payload.volume = isNaN(vol) ? 0 : vol;
            }
            return payload;
        };

        class DocRef {
            constructor(coll, id) { this.coll = coll; this.id = id; }
            async get() {
                try {
                    const d = await databases.getDocument(DATABASE_ID, this.coll, this.id);
                    return processDoc(d);
                } catch { return { exists: false, data: () => null, id: this.id }; }
            }
            async set(data, opts) {
                const payload = prepareData(data);
                try { 
                    await databases.updateDocument(DATABASE_ID, this.coll, this.id, payload); 
                }
                catch { 
                    // Create without explicit permissions - use collection-level permissions
                    await databases.createDocument(DATABASE_ID, this.coll, this.id, payload, []); 
                }
            }
            async update(data) { 
                const payload = prepareData(data);
                await databases.updateDocument(DATABASE_ID, this.coll, this.id, payload); 
            }
            async delete() { await databases.deleteDocument(DATABASE_ID, this.coll, this.id); }
            onSnapshot(callback) {
                const fetch = () => {
                    databases.getDocument(DATABASE_ID, this.coll, this.id)
                        .then(d => callback(processDoc(d)))
                        .catch(e => console.error('onSnapshot error:', e));
                };
                fetch();
                return client.subscribe(`databases.${DATABASE_ID}.collections.${this.coll}.documents.${this.id}`, fetch);
            }
        }

        class CollectionRef {
            constructor(name) { this.name = name; this.queries = []; }
            where(field, op, val) {
                if(op === '==') this.queries.push(Appwrite.Query.equal(field, val));
                return this;
            }
            orderBy(field, dir) {
                this.queries.push(dir === 'desc' ? Appwrite.Query.orderDesc(field) : Appwrite.Query.orderAsc(field));
                return this;
            }
            limit(n) { this.queries.push(Appwrite.Query.limit(n)); return this; }
            doc(id) { return new DocRef(this.name, id); }
            async add(data) {
                const payload = prepareData(data);
                const doc = await databases.createDocument(DATABASE_ID, this.name, 'unique()', payload, []);
                return { id: doc.$id };
            }
            async get() {
                const res = await databases.listDocuments(DATABASE_ID, this.name, this.queries);
                return { docs: res.documents.map(d => processDoc(d)), size: res.total };
            }
            onSnapshot(nextOrOptions, errorFn) {
                // Support both callback styles: onSnapshot(callback) and onSnapshot({next, error})
                const next = typeof nextOrOptions === 'function' ? nextOrOptions : nextOrOptions.next;
                const error = typeof nextOrOptions === 'function' ? errorFn : nextOrOptions.error;
                
                const fetch = () => {
                    databases.listDocuments(DATABASE_ID, this.name, this.queries)
                        .then(res => {
                            console.log(`onSnapshot fetch for ${this.name}:`, res.documents.length, 'documents');
                            next({ docs: res.documents.map(d => processDoc(d)) });
                        })
                        .catch(e => { 
                            console.error(`onSnapshot error for ${this.name}:`, e);
                            if(error) error(e); 
                        });
                };
                fetch();
                return client.subscribe(`databases.${DATABASE_ID}.collections.${this.name}.documents`, fetch);
            }
        }

        const db = {
            collection: (name) => new CollectionRef(name),
            batch: () => ({
                ops: [],
                set(ref, data, opts) { this.ops.push(() => ref.set(data, opts)); },
                update(ref, data) { this.ops.push(() => ref.update(data)); },
                delete(ref) { this.ops.push(() => ref.delete()); },
                commit() { return Promise.all(this.ops.map(op => op())); }
            })
        };

        const auth = {
            currentUser: null,
            createUserWithEmailAndPassword: async (email, password, name) => {
                const userId = 'unique()';
                // Create user and auto-login
                await account.create(userId, email, password, name);
                // Try to create session, if one already exists from registration, delete it first
                try {
                    await account.createEmailPasswordSession(email, password);
                } catch (e) {
                    if (e.type === 'user_session_already_exists') {
                        // Session already exists, just get the account
                        const u = await account.get();
                        auth.currentUser = { ...u, uid: u.$id, email: u.email };
                        return auth.currentUser;
                    }
                    throw e;
                }
                const u = await account.get();
                auth.currentUser = { ...u, uid: u.$id, email: u.email };
                return auth.currentUser;
            },
            signInWithEmailAndPassword: async (email, password) => {
                try {
                    console.log('Attempting login with:', email);
                    // Try to delete any existing session first
                    try {
                        await account.deleteSession('current');
                        console.log('Existing session deleted');
                    } catch (e) {
                        // No existing session, that's fine
                        console.log('No existing session to delete');
                    }
                    // Now create new session
                    await account.createEmailPasswordSession(email, password);
                    console.log('Session created successfully');
                } catch (e) {
                    console.error('Login error:', e);
                    throw e;
                }
                const u = await account.get();
                auth.currentUser = { ...u, uid: u.$id, email: u.email };
                // Trigger onAuthStateChanged callbacks
                if (auth._listeners) {
                    auth._listeners.forEach(cb => cb(auth.currentUser));
                }
                return auth.currentUser;
            },
            signOut: async () => { 
                try {
                    await account.deleteSession('current'); 
                } catch (e) {
                    console.log('Error deleting session:', e);
                }
                auth.currentUser = null;
                // Trigger onAuthStateChanged callbacks
                if (auth._listeners) {
                    auth._listeners.forEach(cb => cb(null));
                }
            },
            _listeners: [],
            onAuthStateChanged: (cb) => {
                // Store callback for later triggering
                auth._listeners.push(cb);
                
                // Immediately check current session
                account.get().then(u => {
                    auth.currentUser = { ...u, uid: u.$id, email: u.email };
                    cb(auth.currentUser);
                }).catch(() => {
                    auth.currentUser = null;
                    cb(null);
                });
                
                // Return unsubscribe function
                return () => {
                    const index = auth._listeners.indexOf(cb);
                    if (index > -1) auth._listeners.splice(index, 1);
                };
            },
            setPersistence: () => Promise.resolve(),
            sendPasswordResetEmail: async (email) => {
                await account.createRecovery(email, window.location.href);
            }
        };
        
        // Mock firebase global for compatibility
        const firebase = { 
            auth: { Auth: { Persistence: { SESSION: 'session' } } },
            apps: [] 
        };

        // --- HELPERS ---
        const getNext7Days = (dayOffset = 0) => { 
            const d=[]; 
            for(let i=0;i<7;i++){ 
                const x=new Date(); 
                x.setDate(x.getDate() + dayOffset + i); 
                const y = x.getFullYear();
                const m = String(x.getMonth() + 1).padStart(2, '0');
                const day = String(x.getDate()).padStart(2, '0');
                d.push(`${y}-${m}-${day}`); 
            } 
            return d; 
        };
        
        const formatDate = (d) => {
            if (!d) return '-';
            const date = new Date(d);
            if (isNaN(date.getTime())) return d; 
            return date.toLocaleDateString('en-GB').replace(/\//g, '-');
        };

        const cleanDim = (v) => String(v||'').includes('202')?'-':v;
        
        const normalizeDate = (val) => {
            if (val === null || val === undefined) return '';
            const raw = String(val).trim();
            if (!raw) return '';

            // Excel serial numbers (days since 1899-12-30 on Windows)
            if (/^\d+$/.test(raw)) {
                const days = parseInt(raw, 10);
                // guard against non-sensical ranges
                if (days > 59 && days < 100000) {
                    const excelEpoch = Date.UTC(1899, 11, 30); // 1899-12-30
                    const ms = days * 24 * 60 * 60 * 1000;
                    const d = new Date(excelEpoch + ms);
                    const y = d.getUTCFullYear();
                    const m = String(d.getUTCMonth() + 1).padStart(2, '0');
                    const dd = String(d.getUTCDate()).padStart(2, '0');
                    return `${y}-${m}-${dd}`;
                }
            }

            // Normalize separators
            const s = raw.replace(/[\.\/]/g, '-').replace(/\s+/g, ' ').trim();

            // Month name formats (e.g., 1-Sep-2025 or Sep-1-2025)
            const months = { jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,sept:9,oct:10,nov:11,dec:12 };
            let m;
            m = s.match(/^(\d{1,2})[- ]([A-Za-z]{3,5})[- ](\d{2,4})$/);
            if (m) {
                const day = parseInt(m[1], 10);
                const mon = months[m[2].toLowerCase()] || 0;
                const year = parseInt(m[3].length === 2 ? ('20' + m[3]) : m[3], 10);
                if (mon) return `${year}-${String(mon).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            }
            m = s.match(/^([A-Za-z]{3,5})[- ](\d{1,2})[- ](\d{2,4})$/);
            if (m) {
                const mon = months[m[1].toLowerCase()] || 0;
                const day = parseInt(m[2], 10);
                const year = parseInt(m[3].length === 2 ? ('20' + m[3]) : m[3], 10);
                if (mon) return `${year}-${String(mon).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            }

            // ISO-like Y-M-D
            m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
            if (m) {
                const year = parseInt(m[1], 10);
                const month = parseInt(m[2], 10);
                const day = parseInt(m[3], 10);
                return `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            }

            // Ambiguous D-M-Y or M-D-Y: prefer M-D-Y when both <= 12 (so 9-01-2025 => Sep 01)
            m = s.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);
            if (m) {
                const a = parseInt(m[1], 10);
                const b = parseInt(m[2], 10);
                const y = parseInt(m[3], 10);
                let month, day;
                if (a > 12 && b <= 12) { day = a; month = b; }
                else if (b > 12 && a <= 12) { day = b; month = a; }
                else { month = a; day = b; }
                return `${y}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            }

            // Fallback to native parser
            const date = new Date(s);
            if (!isNaN(date.getTime())) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            // Unknown format: return as-is to let UI show raw value
            return raw;
        };

        const checkMetaMatch = (el, text) => {
            if (!text) return true;
            const s = text.toLowerCase().trim();
            const type = String(el.type || '').toLowerCase();
            const cluster = String(el.cluster || '').toLowerCase();
            const villa = String(el.villa || '').toLowerCase();
            return type.includes(s) || cluster.includes(s) || villa.includes(s);
        };

        // --- BACKUP HELPER ---
        const performBackup = async () => {
            const collections = ['projects', 'elements', 'delivery_notes', 'users', 'recycle', 'logs', 'invitations'];
            const data = {};
            const failed = [];
            for (const col of collections) {
                try {
                    const snap = await db.collection(col).get();
                    data[col] = snap.docs.map(d => ({ _id: d.id, ...d.data() }));
                } catch (e) {
                    console.warn(`Backup skipped ${col}: ${e.message}`);
                    failed.push(col);
                }
            }
            const blob = new Blob([JSON.stringify({ timestamp: new Date().toISOString(), version: '2.1', data, failed }, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `naran_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            return { count: Object.values(data).reduce((acc, arr) => acc + arr.length, 0), failed };
        };

        // --- PDF DOWNLOAD HELPER ---
        const downloadPDF = (elementId, filename) => {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const opt = {
                margin: 5,
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, logging: false },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Clone the element to modify styles for PDF generation without affecting the UI
            const clone = element.cloneNode(true);
            
            // Fix visibility for elements hidden on screen but visible in print
            // Tailwind 'print:block' class usually indicates it should be shown in print
            const hiddenPrint = clone.querySelectorAll('.hidden');
            hiddenPrint.forEach(el => {
                if (el.classList.contains('print:block')) {
                    el.classList.remove('hidden');
                    el.classList.add('block');
                }
            });
            
            // Remove no-print elements
            const noPrint = clone.querySelectorAll('.no-print');
            noPrint.forEach(el => el.remove());

            html2pdf().set(opt).from(clone).save();
        };

        // ==================================================================================
        // 2.4. DELIVERY NOTE TEMPLATE (Extracted for Reuse)
        // ==================================================================================
        const DeliveryNoteTemplate = ({ note, onClose, onPrint, isPopup, hideControls }) => {
            const [topMargin, setTopMargin] = useState(8);
            const [bottomMargin, setBottomMargin] = useState(8);
            const [showLayoutControls, setShowLayoutControls] = useState(false);

            try {
                if (!note) return <div className="p-8 text-red-600 font-bold">Error: No data available for this Delivery Note.</div>;
                
                // Defensive data handling to prevent crashes
                const items = Array.isArray(note.items) ? note.items.filter(i => i && typeof i === 'object') : [];
                const totalQty = items.reduce((a,b)=>a + (parseInt(b.qty||1,10)||0),0);
                const totalVol = items.reduce((a,b)=>a + (parseFloat(b.volume||0) * (parseInt(b.qty||1,10)||0)), 0);
                const totalWeight = (isNaN(totalVol) ? 0 : totalVol) * 2400;
    
            return (
                <div className={`bg-white print:min-h-[100vh] print:p-6 print:m-0 print:w-full text-black font-sans text-xs relative dn-print-wrapper`} style={{paddingTop: `${topMargin}px`, paddingBottom: `${bottomMargin}px`, paddingLeft: '32px', paddingRight: '32px'}}>
                    {!hideControls && <div className="no-print fixed top-4 right-4 flex flex-col gap-2">
                        <div className="flex gap-2">
                            {onPrint && <button onClick={onPrint} className="bg-blue-600 text-white px-4 py-2 rounded shadow-lg hover:bg-blue-700 font-bold flex items-center gap-2">
                                <Icon name="print"/> Print
                            </button>}
                            <button onClick={() => setShowLayoutControls(!showLayoutControls)} className="bg-emerald-600 text-white px-4 py-2 rounded shadow-lg hover:bg-emerald-700 font-bold flex items-center gap-2">
                                <Icon name="bars"/> Layout
                            </button>
                            <button onClick={onClose} className="bg-gray-800 text-white px-4 py-2 rounded shadow-lg hover:bg-gray-700 font-bold">
                                {isPopup ? 'Close Window' : 'Close Preview'}
                            </button>
                        </div>
                        {showLayoutControls && (
                            <div className="bg-white border border-gray-300 rounded-lg shadow-xl p-4 text-sm">
                                <h3 className="font-bold mb-3 text-gray-800">Adjust Print Layout</h3>
                                <div className="space-y-3">
                                    <div>
                                        <label className="block text-gray-700 mb-1 font-semibold">Top Margin: {topMargin}px</label>
                                        <input type="range" min="0" max="50" value={topMargin} onChange={(e) => setTopMargin(Number(e.target.value))} className="w-full" />
                                    </div>
                                    <div>
                                        <label className="block text-gray-700 mb-1 font-semibold">Bottom Margin: {bottomMargin}px</label>
                                        <input type="range" min="0" max="50" value={bottomMargin} onChange={(e) => setBottomMargin(Number(e.target.value))} className="w-full" />
                                    </div>
                                    <button onClick={() => { setTopMargin(2); setBottomMargin(2); }} className="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded text-xs font-semibold">
                                        Reset to Minimal
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>}
                    <div className="flex-1">
                        <div className="flex justify-between items-center mb-2 border-b-2 border-black pb-2">
                            <div className="flex items-center gap-3">
                                <img src="logo.svg" alt="Naran Precast Logo" className="h-10 w-auto" />
                                <h1 className="text-base font-extrabold uppercase tracking-wide whitespace-nowrap" style={{color: 'rgb(14, 40, 65)'}}>NARAN PRECAST CONCRETE CO.</h1>
                            </div>
                            <h2 className="dn-title text-xl font-extrabold uppercase tracking-wider whitespace-nowrap" style={{color: 'rgb(14, 40, 65)'}}>DELIVERY NOTE</h2>
                        </div>
                        <div className="flex justify-between items-start mb-4 text-xs font-bold text-slate-900">
                            <div className="space-y-1">
                                <p className="flex"><span className="w-16">To:</span> <span className="font-normal">{note.address}</span></p>
                                <p className="flex"><span className="w-16">Contact:</span> <span className="font-normal">{note.contactNo || '-'}</span></p>
                                <p className="flex"><span className="w-16">Project:</span> <span className="font-normal">{note.isMultiProject ? 'Multiple Projects (See Items)' : (note.projectNumber ? `${note.projectNumber} - ${note.projectName}` : (note.projectName || note.project))}</span></p>
                            </div>
                            <div className="text-right space-y-2">
                                <p>Date: <span className="font-normal ml-2">{formatDate(note.date)}</span></p>
                                <div className="inline-grid grid-cols-2 gap-x-6 text-right align-top">
                                    <div>
                                        <div className="text-[11px] uppercase font-bold tracking-wide" style={{color: 'rgb(14, 40, 65)'}}>Delivery Note</div>
                                        <div className="font-mono font-extrabold text-xl tracking-wider" style={{color: 'rgb(14, 40, 65)'}}>{note.dnNumber || '-'}</div>
                                    </div>
                                    <div>
                                        <div className="text-[11px] uppercase text-slate-500 font-bold tracking-wide">REFERENCE#</div>
                                        <div className="font-bold text-slate-800 text-sm">{note.refNo || '-'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <table className="w-full text-[10px] border border-black border-collapse mb-4"><thead><tr className="bg-gray-50"><th className="border border-black p-1 text-center w-10">S.No</th>{note.isMultiProject && <th className="border border-black p-1 text-left">Project</th>}<th className="border border-black p-1 text-left">Element ID</th>{note.showCluster && <th className="border border-black p-1 text-left">Cluster</th>}{note.showVilla && <th className="border border-black p-1 text-left">Villa</th>}<th className="border border-black p-1 text-left">Type</th><th className="border border-black p-1 text-center w-12">Qty</th><th className="border border-black p-1 text-right w-24">Vol (m³)</th></tr></thead><tbody>{items.map((item,i)=>(<tr key={i}><td className="border border-black p-1 text-center">{i+1}</td>{note.isMultiProject && <td className="border border-black p-1">{item.projectNumber||'-'}</td>}<td className="border border-black p-1 font-bold">{item.elementId||'-'}</td>{note.showCluster && <td className="border border-black p-1">{item.cluster||'-'}</td>}{note.showVilla && <td className="border border-black p-1">{item.villa||'-'}</td>}<td className="border border-black p-1 uppercase">{item.type||'-'}</td><td className="border border-black p-1 text-center">{item.qty ? parseInt(item.qty,10) : 1}</td><td className="border border-black p-1 text-right">{parseFloat(item.volume||0).toFixed(3)}</td></tr>))}
                        <tr className="font-bold bg-gray-50"><td colSpan={(note.isMultiProject ? 4 : 3) + (note.showCluster ? 1 : 0) + (note.showVilla ? 1 : 0)} className="border border-black p-1 text-right">Total:</td><td className="border border-black p-1 text-center">{totalQty}</td><td className="border border-black p-1 text-right">{totalVol.toFixed(3)}</td></tr>
                        {note.showWeight !== false && <tr className="font-bold bg-white"><td colSpan={(note.isMultiProject ? 6 : 5) + (note.showCluster ? 1 : 0) + (note.showVilla ? 1 : 0)} className="border border-black p-1 text-right text-[9px] italic">Approx. Total Weight (@2400kg/m³): {totalWeight.toLocaleString(undefined, {maximumFractionDigits: 0})} kg</td></tr>}</tbody></table>
                        <div className="mb-4 text-[9px] text-slate-600 italic border p-2 rounded">Received the above items in good condition and as per specifications. Any discrepancies must be reported within 24 hours.</div>
                        <div className="grid grid-cols-2 gap-8 text-[9px] font-bold mb-6"><div className="space-y-3"><div className="flex items-end"><span className="w-36 flex-shrink-0">Logistics Incharge:</span> <div className="flex-1 border-b border-black border-dotted"></div></div><div className="flex items-end"><span className="w-24 flex-shrink-0">QC Signature:</span> <div className="flex-1 border-b border-black border-dotted"></div></div><div className="flex items-end"><span className="w-24 flex-shrink-0">QC Name:</span> <div className="flex-1 border-b border-black border-dotted"></div></div><div className="flex items-end"><span className="w-24 flex-shrink-0">Transport Co:</span> <div className="flex-1 border-b border-black border-dotted font-mono pl-2">{note.transportCo}</div></div><div className="flex items-end"><span className="w-24 flex-shrink-0">Driver Name:</span> <div className="flex-1 border-b border-black border-dotted font-mono pl-2">{note.driverName}</div></div><div className="flex items-end"><span className="w-24 flex-shrink-0">Vehicle No:</span> <div className="flex-1 border-b border-black border-dotted font-mono pl-2">{note.vehicleNo}</div></div><div className="flex items-end"><span className="w-24 flex-shrink-0">Mobile No:</span> <div className="flex-1 border-b border-black border-dotted"></div></div><div className="flex items-end"><span className="w-24 flex-shrink-0">Date:</span> <div className="flex-1 border-b border-black border-dotted"></div></div><div className="flex items-end"><span className="w-24 flex-shrink-0">Loading Time:</span> <div className="flex-1 border-b border-black border-dotted"></div></div></div><div className="space-y-3 flex flex-col"><div className="flex items-end"><span className="w-24 flex-shrink-0">Security Name:</span> <div className="flex-1 border-b border-black border-dotted"></div></div><div className="flex items-end"><span className="w-24 flex-shrink-0">Security Sign:</span> <div className="flex-1 border-b border-black border-dotted"></div></div><div className="flex items-end"><span className="w-24 flex-shrink-0">Receiver Name:</span> <div className="flex-1 border-b border-black border-dotted"></div></div><div className="flex items-end"><span className="w-24 flex-shrink-0">Receiver Sign:</span> <div className="flex-1 border-b border-black border-dotted"></div></div><div className="flex items-end"><span className="w-24 flex-shrink-0">Company Name:</span> <div className="flex-1 border-b border-black border-dotted"></div></div><div className="flex items-end"><span className="w-24 flex-shrink-0">Date:</span> <div className="flex-1 border-b border-black border-dotted"></div></div><div className="flex-1 flex items-end justify-end mt-4"><div className="text-center"><div className="text-[10px] font-bold uppercase text-blue-900">NARAN PRECAST CONCRETE CO.</div></div></div></div></div>
                    </div>
                    <div className="border-t-2 border-black pt-2 mt-8 text-center dn-footer" style={{pageBreakInside: 'avoid', color: '#000'}}>
                        <h3 className="font-bold text-[10px] uppercase" style={{color: '#000'}}>NARAN PRECAST CONCRETE CO. <span className="font-normal normal-case ml-1">Part of Naran Group</span></h3>
                        <p className="text-[9px]" style={{color: '#000'}}>Tel: +971 67484753 | Fax: +971 67484759 | E-mail: naranpcc@naranpcc.ae | Web: naranpcc.ae</p>
                    </div>
                </div>
            );
            } catch (e) {
                console.error("DN Render Error", e);
                return <div className="p-8 text-red-600 font-bold flex flex-col gap-4 items-start"><span>Error rendering Delivery Note: {e.message}</span><button onClick={onClose} className="px-4 py-2 bg-slate-200 rounded hover:bg-slate-300 text-slate-800">Close</button></div>;
            }
        };

        // ==================================================================================
        // 2.5. WELCOME SCREEN
        // ==================================================================================
        const WelcomeScreen = ({ onEnter }) => {
            const [progress, setProgress] = useState(0);
            const [loaded, setLoaded] = useState(false);

            useEffect(() => {
                const duration = 2000; // 2 seconds
                const interval = 50;
                const step = 100 / (duration / interval);
                
                const timer = setInterval(() => {
                    setProgress(prev => {
                        const next = prev + step;
                        if (next >= 100) {
                            clearInterval(timer);
                            setLoaded(true);
                            // Automatically redirect to login after loading completes
                            setTimeout(() => {
                                onEnter();
                            }, 300);
                            return 100;
                        }
                        return next;
                    });
                }, interval);
                return () => clearInterval(timer);
            }, [onEnter]);

            return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-slate-900 text-white p-4 fade-in relative overflow-hidden">
                    <div className="absolute inset-0 overflow-hidden opacity-20 pointer-events-none">
                        <div className="absolute -top-[20%] -left-[10%] w-[50%] h-[50%] bg-blue-600 rounded-full blur-[120px]"></div>
                        <div className="absolute top-[40%] -right-[10%] w-[40%] h-[40%] bg-emerald-600 rounded-full blur-[100px]"></div>
                    </div>
                        <div className="z-10 text-center max-w-4xl fade-in">
                            {/* Removed logo/icon for cleaner look */}
                            <h1 className="text-3xl md:text-5xl font-extrabold tracking-tight mb-4 text-white drop-shadow-lg"></h1>Welcome To
                            <h1 className="text-4xl md:text-6xl font-extrabold tracking-tight mb-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400">Naran Precast</h1>
                            <p className="text-lg text-blue-200 font-semibold mb-8">Efficient Concrete Production Management</p>
                            {!loaded ? (
                            <div className="mt-12 w-64 mx-auto">
                                <div className="flex justify-between text-xs font-bold text-blue-300 mb-2 font-mono">
                                    <span>LOADING SYSTEM</span>
                                    <span>{Math.min(100, Math.round(progress))}%</span>
                                </div>
                                <div className="w-full bg-slate-800 rounded-full h-1.5 overflow-hidden border border-slate-700 shadow-inner">
                                    <div className="bg-gradient-to-r from-blue-500 to-emerald-400 h-full transition-all duration-75 ease-out" style={{width: `${progress}%`}}></div>
                                </div>
                                <p className="text-slate-500 text-[10px] mt-3 font-mono animate-pulse">Initializing secure environment...</p>
                            </div>
                        ) : (
                            <div className="mt-12 w-64 mx-auto">
                                <div className="flex justify-between text-xs font-bold text-emerald-300 mb-2 font-mono">
                                    <span>READY</span>
                                    <span>100%</span>
                                </div>
                                <div className="w-full bg-slate-800 rounded-full h-1.5 overflow-hidden border border-slate-700 shadow-inner">
                                    <div className="bg-gradient-to-r from-blue-500 to-emerald-400 h-full transition-all duration-75 ease-out" style={{width: '100%'}}></div>
                                </div>
                                <p className="text-emerald-400 text-[10px] mt-3 font-mono animate-pulse">Redirecting...</p>
                            </div>
                        )}
                    </div>
                    <div className="absolute bottom-8 text-slate-500 text-xs font-mono">System v2.2 &copy; {new Date().getFullYear()} Naran Group</div>
                </div>
            );
        };

        // ==================================================================================
        // 3. LOGIN COmPONENT
        // ==================================================================================
        const Login = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [isRegistering, setIsRegistering] = useState(false);

            // Load saved email on component mount
            useEffect(() => {
                const savedEmail = localStorage.getItem('kesha_saved_email');
                if (savedEmail) {
                    setEmail(savedEmail);
                }
            }, []);

            const handleAuth = async (e) => {
                e.preventDefault(); setError(''); setLoading(true);
                const cleanEmail = email.trim().toLowerCase();
                try { 
                    if (isRegistering) {
                        // Registration mode
                        if (!name.trim()) {
                            throw new Error("Please enter your name");
                        }
                        if (password.length < 8) {
                            throw new Error("Password must be at least 8 characters");
                        }
                        await auth.createUserWithEmailAndPassword(cleanEmail, password, name.trim());
                        localStorage.setItem('kesha_saved_email', cleanEmail);
                        sessionStorage.setItem('kesha_session_active', '1');
                    } else {
                        // Login mode
                        sessionStorage.setItem('kesha_session_active', '1');
                        await auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);
                        await auth.signInWithEmailAndPassword(cleanEmail, password);
                        localStorage.setItem('kesha_saved_email', cleanEmail);
                    }
                } 
                catch (err) { 
                    console.error(err); 
                    let msg = err.message || (isRegistering ? "Registration failed." : "Login failed.");
                    if (msg === "Failed to fetch") {
                        msg = `Connection Error: Access blocked. Please add '${window.location.hostname}' to Appwrite Platforms (no https://).`;
                    }
                    if (err.type === 'user_invalid_credentials') {
                        msg = "Invalid email or password. Please try again.";
                    }
                    if (err.type === 'user_already_exists') {
                        msg = "An account with this email already exists. Please login instead.";
                    }
                    // Show technical details if available
                    if (err.code || err.type) {
                        msg += ` (Debug: ${err.code || 'N/A'} - ${err.type || 'N/A'})`;
                    }
                    setError(msg); 
                    sessionStorage.removeItem('kesha_session_active');
                }
                setLoading(false);
            };

            // Add password reset handler
            const handleForgotPassword = async () => {
                if (!email) {
                    setError("Please enter your email above first.");
                    return;
                }
                try {
                    await auth.sendPasswordResetEmail(email.trim().toLowerCase());
                    alert("Password reset email sent! Please check your inbox.");
                } catch (err) {
                    setError("Failed to send reset email. Please check your email address.");
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-900 via-slate-900 to-emerald-900 p-4">
                    <div className="bg-white/90 rounded-3xl shadow-2xl p-10 w-full max-w-md fade-in border border-slate-100 backdrop-blur-md">
                        <div className="text-center mb-8">
                            <h1 className="text-2xl md:text-3xl font-extrabold text-blue-900 leading-tight mb-2 tracking-tight">{isRegistering ? 'Create Account' : 'Sign in to Precast Workflow'}</h1>
                            <p className="text-slate-500 text-sm mb-2 font-medium">{isRegistering ? 'Register a new account' : 'Please login to continue.'}</p>
                        </div>
                        {error && (
                            <div className="bg-red-100 text-red-700 p-3 rounded-lg text-sm mb-4 font-medium border border-red-200 flex items-center gap-2 animate-shake">
                                <Icon name="x" size={16}/>
                                <span>{error}</span>
                            </div>
                        )}
                        <form onSubmit={handleAuth} className="space-y-6">
                            {isRegistering && (
                                <div>
                                    <label className="block text-xs font-bold text-slate-600 uppercase mb-2">Full Name</label>
                                    <div className="relative">
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-blue-400"><Icon name="user" size={18}/></span>
                                        <input type="text" value={name} onChange={e => setName(e.target.value)} className="w-full pl-10 pr-3 py-3 border-2 border-slate-200 rounded-lg text-slate-900 font-semibold focus:border-blue-500 outline-none transition placeholder:text-slate-400" placeholder="John Doe" required />
                                    </div>
                                </div>
                            )}
                            <div>
                                <label className="block text-xs font-bold text-slate-600 uppercase mb-2">Email</label>
                                <div className="relative">
                                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-blue-400"><Icon name="envelope" size={18}/></span>
                                    <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full pl-10 pr-3 py-3 border-2 border-slate-200 rounded-lg text-slate-900 font-semibold focus:border-blue-500 outline-none transition placeholder:text-slate-400" placeholder="user@naran.com" required />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-600 uppercase mb-2">Password</label>
                                <div className="relative">
                                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-blue-400"><Icon name="lock" size={18}/></span>
                                    <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full pl-10 pr-3 py-3 border-2 border-slate-200 rounded-lg text-slate-900 font-semibold focus:border-blue-500 outline-none transition placeholder:text-slate-400" placeholder={isRegistering ? "Min. 8 characters" : "Password"} required />
                                </div>
                                {!isRegistering && (
                                    <div className="flex justify-end mt-2">
                                        <button type="button" className="text-xs text-blue-600 hover:underline font-semibold" onClick={handleForgotPassword}>Forgot password?</button>
                                    </div>
                                )}
                            </div>
                            <button type="submit" disabled={loading} className="w-full btn-primary justify-center disabled:opacity-50 disabled:cursor-not-allowed text-lg py-3 mt-2 shadow-md hover:scale-[1.03] transition-transform duration-150">
                                {loading ? <Icon name="spinner"/> : (isRegistering ? 'Create Account' : 'Secure Login')}
                            </button>
                        </form>
                        <div className="mt-6 text-center">
                            <button type="button" onClick={() => { setIsRegistering(!isRegistering); setError(''); }} className="text-sm text-blue-600 hover:underline font-semibold">
                                {isRegistering ? 'Already have an account? Sign in' : 'Need an account? Register here'}
                            </button>
                        </div>
                        <div className="mt-8 text-center text-xs text-slate-400">&copy; {new Date().getFullYear()} Naran Group. All rights reserved.</div>
                    </div>
                </div>
            );
        };

        // ==================================================================================
        // 4. ImPORTERS & LOGS
        // ==================================================================================
        const ImportWizard = ({ projects, onClose, onImportComplete, userRole }) => {
            const canEditLocal = (userRole === 'admin' || userRole === 'editor');
            const [step, setStep] = useState(1); const [file, setFile] = useState(null); const [workbook, setWorkbook] = useState(null); const [selectedSheet, setSelectedSheet] = useState(''); const [sheetData, setSheetData] = useState([]); const [headerRowIndex, setHeaderRowIndex] = useState(null); const [targetProj, setTargetProj] = useState(''); const [previewCount, setPreviewCount] = useState(0); const fileRef = useRef(null);
            const handleFile = (e) => { const f = e.target.files[0]; if(f) { setFile(f); const r = new FileReader(); r.onload = (evt) => { const wb = XLSX.read(evt.target.result, {type:'binary'}); setWorkbook(wb); const likelySheet = wb.SheetNames.find(n => !['config', 'master'].includes(n.toLowerCase())) || wb.SheetNames[0]; setSelectedSheet(likelySheet); setStep(2); }; r.readAsBinaryString(f); } };
            useEffect(() => { if(workbook && selectedSheet) { const ws = workbook.Sheets[selectedSheet]; const data = XLSX.utils.sheet_to_json(ws, {header: 1}); setSheetData(data.slice(0, 25)); setHeaderRowIndex(null); } }, [selectedSheet, workbook]);
            const handleRowClick = (index) => { setHeaderRowIndex(index); const ws = workbook.Sheets[selectedSheet]; const data = XLSX.utils.sheet_to_json(ws, {range: index}); const valid = data.filter(row => { const keys = Object.keys(row); return keys.some(k => k.toUpperCase().includes('ID')); }); setPreviewCount(valid.length); };
            const executeImport = async () => { if(!canEditLocal) { alert('Permission denied: read-only account.'); return; } if(!targetProj) { alert("Select a Project!"); return; } const proj = projects.find(p => p.projectId === targetProj); if(!proj) { alert("Project not found"); return; } const ws = workbook.Sheets[selectedSheet]; const data = XLSX.utils.sheet_to_json(ws, {range: headerRowIndex}); const batch = db.batch(); let count = 0; data.forEach(row => { const keys = Object.keys(row); const idKey = keys.find(k => k.toUpperCase().includes('ELEmENT') || k.toUpperCase() === 'ID'); const typeKey = keys.find(k => k.toUpperCase().includes('TYPE') || k.toUpperCase().includes('DESC')); const lKey = keys.find(k => k.toUpperCase() === 'LENGTH' || k.toUpperCase() === 'L'); const wKey = keys.find(k => k.toUpperCase() === 'WIDTH' || k.toUpperCase() === 'W'); const vKey = keys.find(k => k.toUpperCase().includes('VOL')); if(idKey && row[idKey]) { const eid = String(row[idKey]); const docId = `${targetProj}_${eid}`.replace(/\//g, "_"); let volumeValue = 0; if(vKey && row[vKey] !== undefined && row[vKey] !== null && row[vKey] !== '') { const parsed = parseFloat(row[vKey]); volumeValue = isNaN(parsed) ? 0 : parsed; } batch.set(db.collection('elements').doc(docId), { elementId: eid, projectNumber: String(targetProj), projectName: proj.name, type: typeKey ? String(row[typeKey]) : 'Unknown', length: lKey ? String(row[lKey]) : '', widthHeight: wKey ? String(row[wKey]) : '', volume: volumeValue, status: 'Scheduled', castingDate: '', deliveryDate: '' }, {merge: true}); count++; } }); await batch.commit(); alert(`Success! Imported ${count} elements into ${proj.name}.`); onImportComplete("Imported File: " + count + " items"); };
            return ( <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm"> <div className="bg-white w-full max-w-4xl h-[90vh] rounded-xl shadow-2xl flex flex-col overflow-hidden"> <div className="p-4 bg-slate-900 text-white flex justify-between items-center"><h3 className="font-bold text-lg"><Icon name="fileExcel" className="mr-2"/> Import Wizard</h3><button onClick={onClose}><Icon name="x"/></button></div> <div className="flex-1 p-6 overflow-y-auto"> {step === 1 && (<div className="h-full flex flex-col items-center justify-center space-y-4"><div className="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center"><Icon name="upload" size={32}/></div><h2 className="text-xl font-bold">Upload your Excel File</h2><button onClick={() => fileRef.current.click()} className="btn-secondary">Select File</button><input type="file" ref={fileRef} onChange={handleFile} className="hidden" accept=".xlsx" /></div>)} {step === 2 && ( <div className="space-y-6"> <div className="grid grid-cols-2 gap-6"> <div><label className="block text-xs font-bold text-slate-500 mb-1">1. Select Sheet containing Data</label><select className="w-full p-2 border border-blue-300 rounded font-bold" value={selectedSheet} onChange={e=>setSelectedSheet(e.target.value)}>{workbook.SheetNames.map(s => <option key={s} value={s}>{s}</option>)}</select></div> <div><label className="block text-xs font-bold text-slate-500 mb-1">2. Select Target Project</label><select className="w-full p-2 border border-blue-300 rounded font-bold" value={targetProj} onChange={e=>setTargetProj(e.target.value)}><option value="">-- Select Project --</option>{projects.map(p => <option key={p.projectId} value={p.projectId}>{p.projectId} - {p.name}</option>)}</select></div> </div> <div><p className="block text-sm font-bold text-slate-700 mb-2 bg-yellow-50 p-2 border border-yellow-200 rounded">3. CLICK the Row number below that contains the HEADERS (e.g. "Element ID", "Type")</p><div className="border rounded overflow-x-auto max-h-96"><table className="w-full text-xs text-left border-collapse"><tbody>{sheetData.map((row, idx) => (<tr key={idx} onClick={() => handleRowClick(idx)} className={`cursor-pointer border-b ${headerRowIndex === idx ? 'bg-blue-600 text-white font-bold' : 'hover:bg-blue-50'}`}><td className="p-2 border-r bg-slate-100 text-slate-500 font-mono w-10 text-center">{idx + 1}</td>{row.map((cell, cIdx) => (<td key={cIdx} className="p-2 border-r truncate max-w-[100px]">{cell}</td>))}</tr>))}</tbody></table></div></div> </div> )} </div> <div className="p-4 border-t bg-slate-50 flex justify-between items-center">{headerRowIndex !== null ? (<div className="text-emerald-700 font-bold flex items-center gap-2"><Icon name="check"/> Ready to import {previewCount} items starting from Row {headerRowIndex + 1}</div>) : <div></div>}{step === 2 && (<button onClick={executeImport} disabled={headerRowIndex === null || !targetProj} className="btn-primary disabled:opacity-50 disabled:cursor-not-allowed">Start Import <Icon name="arrowRight" className="ml-2"/></button>)}</div> </div> </div> );
        };

        /* --- COPY-PASTE ImPORTER (FIXED: UNDEFINED ERROR) --- */
        const PasteImporter = ({ projects, onClose, onImportComplete, userRole }) => {
            const canEditLocal = (userRole === 'admin' || userRole === 'editor');
            const [text, setText] = useState('');
            const [targetProj, setTargetProj] = useState('');
            const [previewData, setPreviewData] = useState([]);
            const [step, setStep] = useState(1);

            const handleProcessText = () => {
                if(!text.trim()) { alert("Please paste data first."); return; }
                if(!targetProj) { alert("Please select a project first."); return; }
                
                const rows = text.trim().split('\n').map(row => row.split('\t'));
                let headerIdx = 0;
                const foundHeader = rows.some((row, idx) => {
                    const str = row.join(' ').toUpperCase();
                    if(str.includes('ELEMENT') || str.includes('TYPE') || str.includes('CLUSTER') || str.includes('VILLA')) { headerIdx = idx; return true; }
                    return false;
                });

                if (!foundHeader) { alert("Could not find headers. Please copy the header row."); return; }

                const headers = rows[headerIdx].map(h => h.trim().toUpperCase());
                const dataRows = rows.slice(headerIdx + 1).filter(row => row.some(cell => cell && String(cell).trim()));
                const idTracker = {}; 

                const mapped = dataRows.map(row => {
                    const obj = {
                        elementId: '',
                        type: '',
                        cluster: '',
                        villa: '',
                        volume: '',
                        length: '',
                        widthHeight: '',
                        dwgDate: '',
                        castingDate: '',
                        deliveryDate: '',
                        notes: ''
                    };
                    
                    headers.forEach((h, i) => {
                        const val = row[i] ? String(row[i]).trim() : '';
                        if(!val) return;
                        
                        // Map columns based on header names from your Excel
                        if(h.includes('TYPE') || h.includes('DESC')) obj.type = val;
                        else if(h.includes('ELEMENT') && h.includes('ID')) obj.elementId = val;
                        else if(h === 'ELEMENT ID' || h === 'ELEMENTID') obj.elementId = val;
                        else if(h.includes('CLUST')) obj.cluster = val;
                        else if(h.includes('VILLA')) obj.villa = val;
                        else if(h.includes('VOLUME') || h.includes('VOL')) obj.volume = val;
                        else if(h.includes('LENG')) obj.length = val;
                        else if(h.includes('WIDTH') || h.includes('HEIG')) obj.widthHeight = val;
                        else if(h.includes('DWG')) obj.dwgDate = val;
                        else if(h.includes('CASTING DATE')) obj.castingDate = val;
                        else if(h.includes('DELIVERED DATE') || h.includes('DELIVERY DATE')) obj.deliveryDate = val;
                        else if(h.includes('REMARK')) obj.notes = val;
                    });
                    
                    // If elementId still empty, try first or second column
                    if(!obj.elementId) {
                        if(row[1] && String(row[1]).trim()) obj.elementId = String(row[1]).trim();
                        else if(row[0] && String(row[0]).trim()) obj.elementId = String(row[0]).trim();
                    }
                    
                    return obj;
                }).filter(o => o.elementId && o.elementId !== '');

                const finalData = mapped.map(item => {
                    const baseId = String(item.elementId).trim();
                    if (idTracker[baseId]) { 
                        idTracker[baseId]++; 
                        item.elementId = `${baseId}-${idTracker[baseId]}`; 
                    } else { 
                        idTracker[baseId] = 1; 
                    }
                    
                    // Normalize dates
                    const cDate = normalizeDate(item.castingDate);
                    const dDate = normalizeDate(item.deliveryDate);
                    const dwgDate = normalizeDate(item.dwgDate);
                    
                    // Determine status based on dates
                    let status = 'Scheduled';
                    if (dDate) status = 'Shipped'; 
                    else if (cDate) status = 'Stockyard';
                    
                    return { 
                        ...item, 
                        castingDate: cDate, 
                        deliveryDate: dDate, 
                        dwgDate: dwgDate, 
                        status,
                        volume: item.volume || '0',
                        type: item.type || 'Unknown',
                        cluster: item.cluster || '',
                        villa: item.villa || '',
                        notes: item.notes || ''
                    };
                });

                setPreviewData(finalData);
                if(finalData.length > 0) setStep(2); else alert("No valid data found.");
            };

            const executeImport = async () => {
                if (!canEditLocal) { alert('Permission denied: read-only account.'); return; }
                const proj = projects.find(p => String(p.projectId) === String(targetProj));
                if (!proj) { alert(`Error: Project not found.`); return; }
                
                // Check for existing elements
                try {
                    const docIds = previewData.map(item => `${targetProj}_${item.elementId}`.replace(/\//g, "_"));
                    const existingChecks = await Promise.all(docIds.map(id => db.collection('elements').doc(id).get()));
                    const existingElements = [];
                    existingChecks.forEach((doc, idx) => {
                        if (doc.exists) existingElements.push(previewData[idx].elementId);
                    });
                    
                    if (existingElements.length > 0) {
                        const confirmMsg = `⚠️ WARNING: ${existingElements.length} element(s) already exist and will be UPDATED:\n\n${existingElements.slice(0, 10).join(', ')}${existingElements.length > 10 ? `\n... and ${existingElements.length - 10} more` : ''}\n\nDo you want to continue and overwrite existing data?`;
                        if (!confirm(confirmMsg)) return;
                    }
                    
                    const batch = db.batch();
                    let count = 0;
                    previewData.forEach(item => {
                        if (item.elementId) {
                            const docId = `${targetProj}_${item.elementId}`.replace(/\//g, "_");
                            batch.set(db.collection('elements').doc(docId), {
                                elementId: item.elementId,
                                projectNumber: String(targetProj),
                                projectName: proj.name,
                                type: item.type || 'Unknown',
                                cluster: item.cluster || '',
                                villa: item.villa || '',
                                length: item.length || '',
                                widthHeight: item.widthHeight || '',
                                volume: item.volume || '0',
                                dwgDate: item.dwgDate || '',
                                castingDate: item.castingDate || '',
                                deliveryDate: item.deliveryDate || '',
                                status: item.status || 'Scheduled',
                                notes: item.notes || '',
                                plannedDate: ''
                            }, {merge: true});
                            count++;
                        }
                    });
                    await batch.commit();
                    alert(`✅ Success! Imported ${count} items into ${proj.name}.`);
                    onImportComplete("Pasted Data: " + count + " items");
                    onClose();
                } catch(e) { console.error(e); alert("Database Error: " + e.message); }
            };

            return (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white w-full max-w-5xl h-[90vh] rounded-xl shadow-2xl flex flex-col overflow-hidden">
                        <div className="p-4 bg-slate-900 text-white flex justify-between items-center flex-shrink-0">
                            <h3 className="font-bold text-lg flex items-center"><Icon name="clipboard" className="mr-2"/> Import Wizard (Paste)</h3>
                            <button onClick={onClose}><Icon name="x"/></button>
                        </div>
                        <div className="flex-1 p-6 overflow-y-auto">
                            {step === 1 ? (
                                <div className="flex flex-col space-y-4 h-full">
                                    <div className="bg-blue-50 p-4 rounded border border-blue-200">
                                        <label className="block text-blue-800 font-bold mb-2">1. Select Target Project</label>
                                        <select className="w-full p-3 border-2 border-blue-300 rounded font-bold text-slate-800 bg-white" value={targetProj} onChange={e=>setTargetProj(e.target.value)}><option value="">-- Select Project --</option>{projects.map(p => <option key={p.projectId} value={p.projectId}>{p.projectId} - {p.name}</option>)}</select>
                                    </div>
                                    <div className="flex-1 flex flex-col">
                                        <label className="block text-slate-700 font-bold mb-2">2. Paste Excel Data (Include Headers)</label>
                                        <p className="text-xs text-slate-600 mb-2">Date format: use 01-Dec-2025</p>
                                        <textarea className="flex-1 w-full p-4 border-2 border-slate-400 rounded-lg text-slate-900 bg-white font-mono text-xs focus:ring-2 focus:ring-blue-500 shadow-inner h-64" placeholder="Copy columns from Excel (Element ID, Type, Length, Width, Volume, Cluster, Villa...) and paste here..." value={text} onChange={e => setText(e.target.value)}></textarea>
                                    </div>
                                    <button onClick={handleProcessText} className="w-full btn-primary text-white py-4 rounded-lg font-bold shadow-lg text-lg flex items-center justify-center gap-2">Next Step <Icon name="arrowRight"/></button>
                                </div>
                            ) : (
                                <div className="flex flex-col h-full">
                                    <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-xl text-slate-800">Preview Import</h3><span className="bg-emerald-100 text-emerald-800 px-3 py-1 rounded-full text-sm font-bold">Found {previewData.length} items</span></div>
                                    <div className="flex-1 border rounded overflow-auto bg-slate-50 mb-4">
                                        <table className="w-full text-xs text-left border-collapse">
                                            <thead className="bg-slate-200 sticky top-0 font-bold text-slate-900 shadow-sm"><tr><th className="p-2 border-b">ID</th><th className="p-2 border-b">Cluster</th><th className="p-2 border-b">Villa</th><th className="p-2 border-b">Type</th><th className="p-2 border-b">Dims</th><th className="p-2 border-b">Vol</th><th className="p-2 border-b">Dwg</th><th className="p-2 border-b">Cast</th><th className="p-2 border-b">Del</th><th className="p-2 border-b">Status</th></tr></thead>
                                            <tbody className="text-slate-900 bg-white">{previewData.map((row, i) => (<tr key={i} className="border-b hover:bg-blue-50"><td className="p-2 font-bold">{row.elementId}</td><td className="p-2">{row.cluster}</td><td className="p-2">{row.villa}</td><td className="p-2">{row.type}</td><td className="p-2">{row.length} x {row.widthHeight}</td><td className="p-2">{row.volume}</td><td className="p-2 text-purple-600">{row.dwgDate}</td><td className="p-2 text-blue-600">{row.castingDate}</td><td className="p-2 text-emerald-600">{row.deliveryDate}</td><td className="p-2"><span className="bg-gray-100 px-2 py-0.5 rounded font-bold">{row.status}</span></td></tr>))}</tbody>
                                        </table>
                                    </div>
                                    <div className="flex gap-4 flex-shrink-0"><button onClick={() => setStep(1)} className="bg-gray-200 hover:bg-gray-300 text-slate-800 px-6 py-3 rounded-lg font-bold transition">Back</button><button onClick={executeImport} className="btn-secondary text-white px-8 py-3 rounded-lg font-bold shadow-lg flex-1 transition">Confirm & Save</button></div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };


        // ==================================================================================
        // 5. mAIN VIEW COmPONENTS
        // ==================================================================================

        const DeliveryView = ({ projects, onCreateDN, onHistory, userRole, notes = [], onViewDN = () => {}, onAdd, userProfile }) => {
            const canEditLocal = (userRole === 'admin' || userRole === 'editor');
            const canCreateDN = canEditLocal || userProfile?.permissions?.canCreateDN || userProfile?.permissions?.canEditElements;
            const [idFilter, setIdFilter] = useState('');
            const [metaFilter, setMetaFilter] = useState('');
            const [projFilter, setProjFilter] = useState('');
            const [elements, setElements] = useState([]);
            const [loading, setLoading] = useState(true);
            
            // Load ALL elements (temporary fix until indexes are ready)
            useEffect(() => {
                setLoading(true);
                const unsub = db.collection('elements').orderBy('elementId').onSnapshot(s => {
                    const activeProjectNums = projects.filter(p => !p.archived).map(p => String(p.projectId));
                    const filtered = s.docs.map(d => ({id:d.id, ...d.data()})).filter(el => activeProjectNums.includes(String(el.projectNumber)));
                    setElements(filtered);
                    setLoading(false);
                });
                return () => unsub();
            }, [projects]);
            
            const filtered = useMemo(() => elements.filter(el => {
                if(projFilter && String(el.projectNumber) !== String(projFilter)) return false;
                if (idFilter && !String(el.elementId || '').toLowerCase().includes(idFilter.toLowerCase())) return false;
                if(metaFilter && !checkMetaMatch(el, metaFilter)) return false;
                return true; 
            }), [elements, projFilter, idFilter, metaFilter]);

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 h-full flex flex-col fade-in">
                    <div className="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50 rounded-t-xl">
                        <div className="flex gap-3 items-center">
                            <select onChange={e=>setProjFilter(e.target.value)} className="p-2 border rounded text-sm bg-white text-slate-900 font-bold"><option value="">All Projects</option>{projects.map(p=><option key={p.id} value={p.projectId}>{p.projectId} - {p.name}</option>)}</select>
                            {/* DUAL SEARCH */}
                            <div className="relative"><Icon name="hashtag" className="absolute left-3 top-2.5 text-slate-400" size={14}/><input placeholder="Search ID..." onChange={e=>setIdFilter(e.target.value)} className="pl-9 p-2 border rounded text-sm w-32 bg-white text-slate-900 font-bold"/></div>
                            <div className="relative"><Icon name="search" className="absolute left-3 top-2.5 text-slate-400" size={14}/><input placeholder="Villa, Cluster, Type..." onChange={e=>setMetaFilter(e.target.value)} className="pl-9 p-2 border rounded text-sm w-48 bg-white text-slate-900 font-bold"/></div>
                        </div>
                        <div className="flex gap-2"><button onClick={onHistory} className="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:from-purple-700 hover:to-blue-700 flex items-center gap-2 shadow-md transition"><Icon name="history"/> Delivery History</button><button onClick={onCreateDN} disabled={!canCreateDN} title={!canCreateDN ? "Permission Required" : ""} className="disabled:opacity-50 disabled:cursor-not-allowed bg-gradient-to-r from-slate-700 to-slate-900 text-white px-5 py-2 rounded-lg text-sm font-bold hover:from-slate-800 hover:to-black flex items-center gap-2 shadow-md transition"><Icon name="clipboard"/> Create Delivery Note</button></div>
                    </div>
                <div className="flex-1 overflow-x-auto overflow-y-auto">
                        <div className="responsive-table">
                            <table className="w-full table-min-640 text-sm text-left text-slate-800">
                            <thead className="bg-slate-100 text-slate-600 font-bold sticky top-0"><tr><th className="p-3">ID</th><th className="p-3">Project</th><th className="p-3 text-center">Cast Date</th><th className="p-3 text-center">Delivered</th><th className="p-3 text-center">Action</th></tr></thead>
                                <tbody className="divide-y divide-slate-100">{filtered.slice(0,100).map(el => (<tr key={el.id} className="hover:bg-slate-50"><td className="p-3 font-bold">{el.elementId}</td><td className="p-3 text-xs">{el.projectName}</td><td className="p-3 text-center text-emerald-700 font-mono text-xs">{formatDate(el.castingDate)}</td><td className="p-3 text-center font-mono text-xs">
                    {el.deliveryDate ? (
                        <div className="space-y-1">
                            <div>{formatDate(el.deliveryDate)}</div>
                            {(() => {
                                // try to find a matching delivery note (items contain element id or elementId)
                                const note = notes.find(n => Array.isArray(n.items) && n.items.some(it => it && (it.id === el.id || it.id === el.elementId || it.elementId === el.elementId)));
                                if (!note) return null;
                                return (
                                    <div className="text-[11px] mt-1">
                                        <span className="font-bold">DN:</span>
                                        <span className="ml-1 font-mono">{note.dnNumber}</span>
                                        <button onClick={() => onViewDN && onViewDN(note)} className="ml-2 text-blue-600 hover:text-blue-800 text-xs font-bold">View</button>
                                    </div>
                                );
                            })()}
                        </div>
                    ) : '-'}
                </td><td className="p-3 text-center">{el.status === 'Stockyard' && <span className="text-blue-600 text-xs font-bold">Ready</span>}{el.status === 'Shipped' && <span className="text-gray-400 text-xs">Shipped</span>}</td></tr>))}</tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const ProductionControlView = ({ projects, onUpdate, onDelete, userRole, userProfile, notes = [], onViewDN = () => {}, savedTab, setSavedTab, savedProjFilter, setSavedProjFilter }) => {
            const canEditLocal = (userRole === 'admin' || userRole === 'editor');
            const isAdminLocal = (userRole === 'admin');
            const [idFilter, setIdFilter] = useState(''); const [metaFilter, setMetaFilter] = useState('');
            const [projFilter, setProjFilter] = useState(savedProjFilter || '');
            const [tab, setTab] = useState(savedTab || 'casting'); const [actionModal, setActionModal] = useState(null); const [actionDate, setActionDate] = useState(new Date().toISOString().split('T')[0]);
            const [editingEl, setEditingEl] = useState(null);
            const [elements, setElements] = useState([]);
            const [loading, setLoading] = useState(true);
            // Pagination
            const canDelete = isAdminLocal || userProfile?.permissions?.canDeleteElements;

            const [currentPage, setCurrentPage] = useState(1); const itemsPerPage = 100;
            useEffect(() => setCurrentPage(1), [idFilter, metaFilter, projFilter, tab]);
            // Bulk selection state
            const [selectedElements, setSelectedElements] = useState([]);
            const [bulkDate, setBulkDate] = useState(new Date().toISOString().split('T')[0]);
            const [showBulkPanel, setShowBulkPanel] = useState(false);
            const [bulkQty, setBulkQty] = useState('');
            useEffect(() => { setSelectedElements([]); setShowBulkPanel(false); }, [tab, projFilter]);
            
            // Save tab and project filter state to parent
            useEffect(() => { if (setSavedTab) setSavedTab(tab); }, [tab, setSavedTab]);
            useEffect(() => { if (setSavedProjFilter) setSavedProjFilter(projFilter); }, [projFilter, setSavedProjFilter]);

            // Load elements only when a project is selected
            useEffect(() => {
                if (!projFilter) {
                    setElements([]);
                    setLoading(false);
                    return;
                }
                
                setLoading(true);
                const unsub = db.collection('elements')
                    .where('projectNumber', '==', String(projFilter))
                    .onSnapshot(s => {
                        const filtered = s.docs.map(d => ({id:d.id, ...d.data()}))
                            .sort((a, b) => (a.elementId || '').localeCompare(b.elementId || ''));
                        setElements(filtered);
                        setLoading(false);
                    }, (error) => {
                        console.error('Error loading elements:', error);
                        setLoading(false);
                    });
                return () => unsub();
            }, [projFilter]);

            // Client-side filtering
            const filtered = useMemo(() => elements.filter(el => {
                if (projFilter && String(el.projectNumber) !== String(projFilter)) return false;
                if (idFilter && !String(el.elementId || '').toLowerCase().includes(idFilter.toLowerCase())) return false;
                if (metaFilter && !checkMetaMatch(el, metaFilter)) return false;
                if (tab === 'casting') return !el.castingDate;
                if (tab === 'delivery') return el.castingDate && !el.deliveryDate;
                return true;
            }), [elements, projFilter, idFilter, metaFilter, tab]);

            // Statistics for Search DB
            const statistics = useMemo(() => {
                if (tab !== 'all') return null;
                const typeBreakdown = {};
                let totalVolume = 0;
                let castCount = 0;
                let castVolume = 0;
                let deliveredCount = 0;
                let deliveredVolume = 0;
                
                filtered.forEach(el => {
                    const vol = parseFloat(el.volume || 0);
                    const type = el.type || 'Unknown';
                    if (!typeBreakdown[type]) {
                        typeBreakdown[type] = { count: 0, volume: 0 };
                    }
                    typeBreakdown[type].count++;
                    typeBreakdown[type].volume += vol;
                    totalVolume += vol;
                    
                    // Count cast and delivered
                    if (el.castingDate) {
                        castCount++;
                        castVolume += vol;
                    }
                    if (el.deliveryDate) {
                        deliveredCount++;
                        deliveredVolume += vol;
                    }
                });
                return {
                    total: filtered.length,
                    totalVolume,
                    castCount,
                    castVolume,
                    deliveredCount,
                    deliveredVolume,
                    typeBreakdown: Object.entries(typeBreakdown)
                        .sort((a, b) => b[1].count - a[1].count)
                        .slice(0, 10) // Top 10 types
                };
            }, [filtered, tab]);

            const indexOfLastItem = currentPage * itemsPerPage; const indexOfFirstItem = indexOfLastItem - itemsPerPage;
            const currentItems = filtered.slice(indexOfFirstItem, indexOfLastItem); const totalPages = Math.ceil(filtered.length / itemsPerPage);
            const initiateAction = (id, type) => { setActionModal({ id, type }); setActionDate(new Date().toISOString().split('T')[0]); };
            const confirmAction = () => { const { id, type } = actionModal; if (type === 'delete') onDelete(id); else if (type === 'cast') onUpdate(id, { castingDate: actionDate, status: 'Stockyard' }, "Casting Updated"); else if (type === 'ship') onUpdate(id, { deliveryDate: actionDate, status: 'Shipped' }, "Delivery Updated"); setActionModal(null); };
            
            // Bulk selection handlers
            const toggleSelectElement = (id) => {
                setSelectedElements(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
            };
            const selectAllVisible = () => {
                const visibleIds = currentItems.map(el => el.id);
                setSelectedElements(visibleIds);
            };
            const selectNone = () => setSelectedElements([]);
            const handleBulkAction = async (action) => {
                if (!canEditLocal) { alert('Permission denied: read-only account.'); return; }
                
                let targetIds = [...selectedElements];
                if (targetIds.length === 0 && bulkQty) {
                    const qty = parseInt(bulkQty);
                    if (qty > 0) {
                        targetIds = filtered.slice(0, qty).map(el => el.id);
                        if (targetIds.length < qty) {
                            if (!confirm(`Only ${targetIds.length} elements available. Update all of them?`)) return;
                        }
                    }
                }

                if (targetIds.length === 0) { alert('Please select elements or enter a quantity.'); return; }
                if (!bulkDate) { alert('Please select a date.'); return; }
                const confirmMsg = action === 'cast' 
                    ? `Update casting date for ${targetIds.length} elements to ${formatDate(bulkDate)}?`
                    : `Update delivery date for ${targetIds.length} elements to ${formatDate(bulkDate)}?`;
                if (!confirm(confirmMsg)) return;
                try {
                    const batch = db.batch();
                    targetIds.forEach(id => {
                        const ref = db.collection('elements').doc(id);
                        if (action === 'cast') {
                            batch.update(ref, { castingDate: bulkDate, status: 'Stockyard' });
                        } else if (action === 'ship') {
                            batch.update(ref, { deliveryDate: bulkDate, status: 'Shipped' });
                        }
                    });
                    await batch.commit();
                    alert(`✅ Successfully updated ${targetIds.length} elements!`);
                    setSelectedElements([]);
                    setBulkQty('');
                    setShowBulkPanel(false);
                } catch(e) {
                    console.error(e);
                    alert('Error during bulk update: ' + e.message);
                }
            };
            
            // Excel Export
            const handleExportExcel = () => {
                if(filtered.length === 0) { alert("No data to export."); return; }
                const exportData = filtered.map(e => ({ "Element ID": e.elementId, "Project": e.projectName, "Cluster": e.cluster || '', "Villa": e.villa || '', "Type": e.type, "Length": e.length, "Width/Height": e.widthHeight, "Volume": e.volume, "Drawing Date": e.dwgDate || '', "Casting Date": e.castingDate || '', "Delivery Date": e.deliveryDate || '', "Status": e.status }));
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Production_Data");
                XLSX.writeFile(wb, `Production_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            // Admin: Bulk date normalization across all elements
            const handleFixDates = async () => {
                if (!isAdminLocal) { alert('Permission denied: admin only.'); return; }
                const ok = window.confirm("This will normalize all element dates (DWG, Casting, Delivery) and recalculate statuses across ALL projects.\n\nProceed?");
                if (!ok) return;
                try {
                    const snap = await db.collection('elements').get();
                    let checked = 0, updated = 0;
                    let batch = db.batch();
                    let ops = 0;
                    for (const doc of snap.docs) {
                        const data = doc.data() || {};
                        const c = normalizeDate(data.castingDate || '');
                        const d = normalizeDate(data.deliveryDate || '');
                        const w = normalizeDate(data.dwgDate || '');
                        let status = data.status || 'Scheduled';
                        if (d) status = 'Shipped'; else if (c) status = 'Stockyard'; else status = 'Scheduled';
                        const changed = (c !== (data.castingDate || '')) || (d !== (data.deliveryDate || '')) || (w !== (data.dwgDate || '')) || (status !== (data.status || ''));
                        checked++;
                        if (changed) {
                            batch.update(db.collection('elements').doc(doc.id), { castingDate: c, deliveryDate: d, dwgDate: w, status });
                            updated++; ops++;
                            if (ops >= 400) { await batch.commit(); batch = db.batch(); ops = 0; }
                        }
                    }
                    if (ops > 0) await batch.commit();
                    logActivity('BULK_FIX_DATES', `Checked: ${checked}, Updated: ${updated}`);
                    alert(`Date normalization completed.\nChecked: ${checked}\nUpdated: ${updated}`);
                } catch (e) {
                    console.error(e);
                    alert('Error during date normalization: ' + e.message);
                }
            };

            const handleSaveEdit = (e) => { 
                e.preventDefault();
                const fd = new FormData(e.target);
                const cDate = fd.get('castingDate');
                const dDate = fd.get('deliveryDate');
                const dwgDate = fd.get('dwgDate');
                let newStatus = 'Scheduled';
                if (dDate) newStatus = 'Shipped'; else if (cDate) newStatus = 'Stockyard';
                const newElementId = fd.get('elementId')?.trim();
                const oldElementId = editingEl.elementId;
                const updateData = {
                    type: fd.get('type'),
                    cluster: fd.get('cluster'),
                    villa: fd.get('villa'),
                    length: fd.get('length'),
                    widthHeight: fd.get('widthHeight'),
                    volume: fd.get('volume'),
                    dwgDate: dwgDate,
                    castingDate: cDate,
                    deliveryDate: dDate,
                    status: newStatus,
                    elementId: newElementId,
                    notes: fd.get('notes'),
                    qcStatus: fd.get('qcStatus'),
                    location: fd.get('location')
                };
                if (isAdminLocal && newElementId && newElementId !== oldElementId) {
                    // True rename: copy to new doc, delete old doc
                    const oldDocId = editingEl.id;
                    const newDocId = oldDocId.replace(oldElementId, newElementId);
                    db.collection('elements').doc(newDocId).set({ ...editingEl, ...updateData, id: newDocId })
                        .then(() => db.collection('elements').doc(oldDocId).delete())
                        .then(() => {
                            onUpdate(newDocId, updateData, "Renamed Element ID");
                            setEditingEl(null);
                        })
                        .catch(e => { alert('Rename failed: ' + e.message); });
                } else {
                    onUpdate(editingEl.id, updateData, "Edited Details");
                    setEditingEl(null);
                }
            };

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden fade-in relative flex flex-col h-full">
                    <div className="p-4 border-b border-slate-200 bg-slate-50 flex flex-wrap gap-4 justify-between items-center flex-shrink-0">
                        <div className="flex items-center gap-3">
                            <div className="flex bg-white rounded-lg p-1 border border-slate-200">{[{id:'casting', icon:'hammer', lbl:'Casting Update'}, {id:'delivery', icon:'truck', lbl:'Delivery Update'}, {id:'all', icon:'search', lbl:'Search DB'}].map(t => (<button key={t.id} onClick={() => setTab(t.id)} className={`px-4 py-2 rounded-md text-sm font-bold flex items-center gap-2 transition ${tab === t.id ? 'bg-slate-800 text-white' : 'text-slate-500 hover:bg-slate-100'}`}><Icon name={t.icon}/> {t.lbl}</button>))}</div>
                            {canEditLocal && tab !== 'all' && currentItems.length > 0 && (
                                <button onClick={() => setShowBulkPanel(!showBulkPanel)} className={`px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-md transition ${showBulkPanel ? 'bg-emerald-500 text-white' : 'bg-white text-slate-700 border border-slate-300 hover:bg-slate-50'}`}><Icon name="check"/> Bulk Update {selectedElements.length > 0 && `(${selectedElements.length})`}</button>
                            )}
                        </div>
                        {tab === 'all' ? (
                            <div className="flex gap-2 items-center">
                                <button onClick={handleExportExcel} className="btn-secondary flex items-center gap-2"><Icon name="fileExcel"/> Export Excel</button>
                                <select value={projFilter} onChange={e => setProjFilter(e.target.value)} className="p-2 border rounded text-sm bg-white text-slate-900 font-bold"><option value="">Select Project...</option>{projects.map(p => <option key={p.id} value={p.projectId}>{p.projectId} - {p.name}</option>)}</select>
                                <input placeholder="Search ID..." onChange={e => setIdFilter(e.target.value)} className="p-2 border rounded text-sm w-40 bg-white text-slate-900 font-bold" />
                                <input placeholder="Villa, Cluster..." onChange={e => setMetaFilter(e.target.value)} className="p-2 border rounded text-sm w-64 bg-white text-slate-900 font-bold" />
                            </div>
                        ) : (
                            <div className="flex gap-2 items-center">
                                <button onClick={handleExportExcel} className="btn-secondary mr-2"><Icon name="fileExcel"/> Export Excel</button>
                                {isAdminLocal && <button onClick={handleFixDates} className="bg-amber-600 text-white px-3 py-2 rounded text-sm font-bold hover:bg-amber-700 transition flex items-center gap-2" title="Normalize all dates"><Icon name="calendar"/> Fix Dates</button>}
                                <select value={projFilter} onChange={e => setProjFilter(e.target.value)} className="p-2 border rounded text-sm bg-white text-slate-900 font-bold"><option value="">Select Project...</option>{projects.map(p => <option key={p.id} value={p.projectId}>{p.projectId} - {p.name}</option>)}</select>
                                <input placeholder="Search ID..." onChange={e => setIdFilter(e.target.value)} className="p-2 border rounded text-sm w-32 bg-white text-slate-900 font-bold" />
                                <input placeholder="Villa, Cluster..." onChange={e => setMetaFilter(e.target.value)} className="p-2 border rounded text-sm w-48 bg-white text-slate-900 font-bold" />
                            </div>
                        )}
                    </div>
                    {tab === 'all' && statistics && (projFilter || idFilter || metaFilter) && (
                        <div className="px-4 py-2 bg-blue-50 border-b border-blue-200 flex items-center gap-6 text-sm flex-wrap">
                            <span className="font-bold text-slate-700">{statistics.total} Total Elements</span>
                            <span className="font-bold text-slate-700">{statistics.totalVolume.toFixed(2)} m³ Total Volume</span>
                            <span className="font-bold text-green-700">{statistics.castCount} Cast ({statistics.castVolume.toFixed(2)} m³)</span>
                            <span className="font-bold text-blue-700">{statistics.deliveredCount} Delivered ({statistics.deliveredVolume.toFixed(2)} m³)</span>
                        </div>
                    )}
                    {showBulkPanel && canEditLocal && (
                        <div className="p-4 bg-gradient-to-r from-emerald-50 to-blue-50 border-b border-emerald-200 flex flex-wrap gap-4 items-center justify-between">
                            <div className="flex gap-2 items-center">
                                <button onClick={selectAllVisible} className="px-3 py-1.5 bg-white border border-slate-300 rounded text-xs font-bold text-slate-700 hover:bg-slate-50">Select All ({currentItems.length})</button>
                                <button onClick={selectNone} className="px-3 py-1.5 bg-white border border-slate-300 rounded text-xs font-bold text-slate-700 hover:bg-slate-50">Clear Selection</button>
                                <span className="text-sm font-bold text-slate-700 ml-2">{selectedElements.length} selected</span>
                            </div>
                            <div className="flex gap-3 items-center">
                                <div className="flex items-center gap-1 bg-white rounded border border-slate-300 px-2"><span className="text-xs font-bold text-slate-500">Qty:</span><input type="number" min="1" value={bulkQty} onChange={e => setBulkQty(e.target.value)} className="w-16 py-1 text-sm font-bold outline-none text-slate-900" placeholder="Auto" /></div>
                                <input type="date" value={bulkDate} onChange={e => setBulkDate(e.target.value)} className="px-3 py-1.5 border-2 border-emerald-300 rounded font-bold text-sm text-slate-900 bg-white" />
                                {tab === 'casting' && (
                                    <button onClick={() => handleBulkAction('cast')} disabled={selectedElements.length === 0 && !bulkQty} className="px-4 py-1.5 bg-orange-500 text-white rounded font-bold text-sm hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg"><Icon name="hammer" className="mr-2"/> Mark as Cast</button>
                                )}
                                {tab === 'delivery' && (
                                    <button onClick={() => handleBulkAction('ship')} disabled={selectedElements.length === 0 && !bulkQty} className="px-4 py-1.5 bg-blue-500 text-white rounded font-bold text-sm hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg"><Icon name="truck" className="mr-2"/> Mark as Shipped</button>
                                )}
                            </div>
                        </div>
                    )}
                    <div className="flex-1 overflow-x-auto overflow-y-auto">
                        {!projFilter ? (
                            <div className="flex-1 flex flex-col items-center justify-center text-slate-400 bg-slate-50 h-full min-h-[400px]">
                                <Icon name="building" size={48} className="mb-4 text-slate-300"/>
                                <p className="font-medium text-lg">Select a project to load data</p>
                                <p className="text-sm text-slate-400 mt-2">Use the project dropdown above to begin</p>
                            </div>
                        ) : (
                        <div className="responsive-table">
                            <table className="w-full table-min-800 text-sm text-left text-slate-600">
                                {tab === 'all' ? (
                                    <thead className="bg-slate-100 text-xs uppercase font-bold text-slate-500 sticky top-0 z-10">
                                        <tr>
                                            <th className="p-4">Project</th>
                                            <th className="p-4">Proj #</th>
                                            <th className="p-4">Element ID</th>
                                            <th className="p-4">Cluster</th>
                                            <th className="p-4">Villa</th>
                                            <th className="p-4">Type</th>
                                            <th className="p-4">Length</th>
                                            <th className="p-4">Width/Height</th>
                                            <th className="p-4">Vol (m³)</th>
                                            <th className="p-4">DWG Date</th>
                                            <th className="p-4 min-w-[150px]">Dates (Cast & Del)</th>
                                            <th className="p-4">DN #</th>
                                            <th className="p-4">Status</th>
                                            <th className="p-4">QC</th>
                                            <th className="p-4">Loc</th>
                                            <th className="p-4">Notes</th>
                                            <th className="p-4 text-center">Action</th>
                                        </tr>
                                    </thead>
                                ) : (
                                    <thead className="bg-slate-100 text-xs uppercase font-bold text-slate-500 sticky top-0 z-10"><tr>{canEditLocal && showBulkPanel && <th className="p-4 w-12 text-center"><Icon name="check" size={14}/></th>}<th className="p-4">Element ID</th><th className="p-4">Cluster</th><th className="p-4">Villa</th><th className="p-4">Type</th><th className="p-4">Dims (L x W)</th><th className="p-4">Vol (m³)</th><th className="p-4">DWG Date</th><th className="p-4 min-w-[150px]">Dates (Cast & Del)</th><th className="p-4">Status</th><th className="p-4 text-center">Action</th></tr></thead>
                                )}
                                <tbody className="divide-y divide-slate-100">
                                    {/* Cleaned up: No stray whitespace or text nodes between <tr>, <tbody>, and <table> */}
                                    {tab === 'all'
                                        ? currentItems.map(el => (
                                            <tr key={el.id} className="hover:bg-blue-50 transition">
                                                <td className="p-4 text-sm font-medium">{el.projectName || '-'}</td>
                                                <td className="p-4 text-sm">{el.projectNumber || '-'}</td>
                                                <td className="p-4 font-bold text-slate-800">{el.elementId}</td>
                                                <td className="p-4 text-xs">{el.cluster || '-'}</td>
                                                <td className="p-4 text-xs">{el.villa || '-'}</td>
                                                <td className="p-4">{el.type}</td>
                                                <td className="p-4 font-mono text-xs">{el.length || '-'}</td>
                                                <td className="p-4 font-mono text-xs">{el.widthHeight || '-'}</td>
                                                <td className="p-4 font-mono text-xs font-bold">{parseFloat(el.volume || 0).toFixed(3)}</td>
                                                <td className="p-4 text-xs font-mono text-slate-600">{el.dwgDate ? formatDate(el.dwgDate) : '-'}</td>
                                                <td className="p-4 text-xs min-w-[150px]">
                                                    <div className="flex flex-col gap-1">
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-[10px] font-bold text-slate-500">C:</span>
                                                            <span className="font-mono text-slate-700">{el.castingDate ? formatDate(el.castingDate) : '-'}</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-[10px] font-bold text-slate-500">D:</span>
                                                            <span className="font-mono text-slate-700">{el.deliveryDate ? formatDate(el.deliveryDate) : '-'}</span>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td className="p-4 text-xs text-center">
                                                    {el.deliveryDate ? (() => {
                                                        const dn = notes.find(n => Array.isArray(n.items) && n.items.some(it => it && (String(it.id) === String(el.id) || String(it.elementId) === String(el.elementId))));
                                                        if(!dn) return '-';
                                                        return (
                                                            <div className="flex items-center justify-center gap-2">
                                                                <span className="font-mono font-bold text-slate-800">{dn.dnNumber}</span>
                                                <button onClick={() => onViewDN && onViewDN(dn)} className="text-blue-600 hover:text-blue-800 text-xs font-bold">View</button>
                                                            </div>
                                                        );
                                                    })() : '-'}
                                                </td>
                                                <td className="p-4">{el.status === 'Shipped' || el.status === 'Stockyard' ? <span className={`px-2 py-1 rounded text-xs font-bold ${el.status==='Shipped' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{el.status}</span> : (el.plannedDate ? <span className="px-2 py-1 rounded text-xs font-bold bg-amber-100 text-amber-700">Scheduled</span> : <span className="text-slate-300">-</span>)}</td>
                                                <td className="p-4 text-center">{el.qcStatus === 'Passed' ? <Icon name="check" className="text-green-600"/> : el.qcStatus === 'Failed' ? <Icon name="x" className="text-red-600"/> : el.qcStatus === 'Repair' ? <Icon name="hammer" className="text-orange-500"/> : <span className="text-slate-300">-</span>}</td>
                                                <td className="p-4 text-xs font-mono">{el.location || '-'}</td>
                                                <td className="p-4 text-xs text-slate-600">{el.notes || '-'}</td>
                                                <td className="p-4 text-center">
                                                    <div className="flex items-center justify-center gap-2">
                                                        <button onClick={() => setEditingEl(el)} className="text-blue-500 hover:text-blue-700 p-2 bg-blue-50 rounded hover:bg-blue-100 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled={!canEditLocal} title="Edit Element"><Icon name="pencil" size={14}/></button>
                                                        <button onClick={() => onDelete(el.id)} className="text-red-400 hover:text-red-600 p-2 rounded disabled:opacity-50 disabled:cursor-not-allowed" disabled={!canDelete} title="Delete Element"><Icon name="trash" size={14}/></button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))
                                        : currentItems.map(el => (
                                            <tr key={el.id} className={`hover:bg-blue-50 transition ${selectedElements.includes(el.id) ? 'bg-emerald-50' : ''} ${el.qcStatus === 'Failed' ? 'bg-red-50' : ''}`}>
                                                {canEditLocal && showBulkPanel && (
                                                    <td className="p-4 text-center">
                                                        <input type="checkbox" checked={selectedElements.includes(el.id)} onChange={() => toggleSelectElement(el.id)} className="w-4 h-4 cursor-pointer accent-emerald-500" />
                                                    </td>
                                                )}
                                                <td className="p-4 font-bold text-slate-800">{el.elementId}</td>
                                                <td className="p-4 text-xs">{el.cluster||'-'}</td>
                                                <td className="p-4 text-xs">{el.villa||'-'}</td>
                                                <td className="p-4">{el.type}</td>
                                                <td className="p-4 font-mono text-xs">{cleanDim(el.length)} x {cleanDim(el.widthHeight)}</td>
                                                <td className="p-4 font-mono text-xs font-bold">{parseFloat(el.volume || 0).toFixed(3)}</td>
                                                <td className="p-4 text-xs font-mono text-slate-600">{el.dwgDate ? formatDate(el.dwgDate) : '-'}</td>
                                                <td className="p-4 text-xs font-medium">{(el.castingDate || el.deliveryDate) ? (<div className="space-y-1"><div className="text-blue-700 font-bold">C: {el.castingDate ? formatDate(el.castingDate) : "-"}</div><div className="text-emerald-600 font-bold">D: {el.deliveryDate ? formatDate(el.deliveryDate) : "-"}</div></div>) : (<span className="text-slate-300">-</span>)}</td>
                                                <td className="p-4 text-xs text-center">
                                                    {el.deliveryDate ? (() => {
                                                        const dn = notes.find(n => Array.isArray(n.items) && n.items.some(it => it && (String(it.id) === String(el.id) || String(it.elementId) === String(el.elementId))));
                                                        if(!dn) return '-';
                                                        return (
                                                            <div className="flex items-center justify-center gap-2">
                                                                <span className="font-mono font-bold text-slate-800">{dn.dnNumber}</span>
                                                                <button onClick={() => onViewDN(dn)} className="text-blue-600 hover:text-blue-800 text-xs font-bold">View</button>
                                                            </div>
                                                        );
                                                    })() : '-'}
                                                </td>
                                                <td className="p-4">{el.status === 'Shipped' || el.status === 'Stockyard' ? <span className={`px-2 py-1 rounded text-xs font-bold ${el.status==='Shipped' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{el.status}</span> : (el.plannedDate ? <span className="px-2 py-1 rounded text-xs font-bold bg-amber-100 text-amber-700">Scheduled</span> : <span className="text-slate-300">-</span>)}</td>
                                                <td className="p-4 text-center">{el.qcStatus === 'Passed' ? <Icon name="check" className="text-green-600"/> : el.qcStatus === 'Failed' ? <Icon name="x" className="text-red-600"/> : el.qcStatus === 'Repair' ? <Icon name="hammer" className="text-orange-500"/> : <span className="text-slate-300">-</span>}</td>
                                                <td className="p-4 text-xs font-mono">{el.location || '-'}</td>
                                                <td className="p-4 text-center">
                                                    <div className="flex flex-col sm:flex-row items-center justify-center gap-2"><button onClick={() => setEditingEl(el)} className="w-full sm:w-auto text-blue-500 hover:text-blue-700 p-2 bg-blue-50 rounded hover:bg-blue-100 transition text-sm flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed" disabled={!canEditLocal}><Icon name="pencil" size={14}/></button>{tab === 'casting' && <button onClick={() => initiateAction(el.id, 'cast')} className="w-full sm:w-auto btn-primary text-white px-3 py-2 rounded text-xs font-bold disabled:opacity-50 disabled:cursor-not-allowed" disabled={!canEditLocal}>Cast</button>}{tab === 'delivery' && <button onClick={() => initiateAction(el.id, 'ship')} className="w-full sm:w-auto btn-secondary text-white px-3 py-2 rounded text-xs font-bold disabled:opacity-50 disabled:cursor-not-allowed" disabled={!canEditLocal}>Ship</button>}<button onClick={() => initiateAction(el.id, 'delete')} className="w-full sm:w-auto text-red-400 hover:text-red-600 p-2 rounded disabled:opacity-50 disabled:cursor-not-allowed" disabled={!canDelete}><Icon name="trash" size={14}/></button></div>
                                                </td>
                                            </tr>
                                        ))}
                                </tbody>
                            </table>
                        </div>
                        )}
                    </div>
                    {/* Pagination */}
                    <div className="p-3 border-t bg-white flex justify-between items-center flex-shrink-0 shadow-inner"><span className="text-xs text-slate-900 font-bold">Total: {filtered.length} Elements</span><div className="flex items-center gap-2"><button onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage === 1} className="px-3 py-1 rounded border border-slate-300 bg-white text-slate-900 hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed text-xs font-bold">Previous</button><span className="text-xs font-bold text-slate-900">Page {currentPage} of {totalPages || 1}</span><button onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))} disabled={currentPage === totalPages || totalPages === 0} className="px-3 py-1 rounded border border-slate-300 bg-white text-slate-900 hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed text-xs font-bold">Next</button></div></div>
                    
                    {actionModal && (<div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm"><div className="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform scale-100 transition-all"><h3 className="font-bold text-lg mb-2 text-slate-800 flex items-center gap-2">{actionModal.type === 'delete' ? <Icon name="trash" className="text-red-500"/> : <Icon name="calendar" className="text-blue-500"/>}{actionModal.type === 'delete' ? 'Confirm Deletion' : actionModal.type === 'cast' ? 'Confirm Casting' : 'Confirm Shipment'}</h3>{actionModal.type === 'delete' ? (<p className="text-slate-600 mb-6 text-sm">Are you sure you want to permanently delete this element? This action cannot be undone.</p>) : (<div className="mb-6"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Select Date</label><input type="date" value={actionDate} onChange={(e) => setActionDate(e.target.value)} className="w-full border-2 border-blue-100 rounded-lg p-3 text-sm font-bold text-slate-700 focus:border-blue-500 outline-none bg-white text-slate-900"/></div>)}<div className="flex gap-3 justify-end"><button onClick={() => setActionModal(null)} className="px-4 py-2 rounded-lg text-slate-500 font-bold text-sm hover:bg-slate-100">Cancel</button><button onClick={confirmAction} className={`px-6 py-2 rounded-lg text-white font-bold text-sm shadow-lg ${actionModal.type === 'delete' ? 'bg-red-500 hover:bg-red-600' : 'btn-primary'}`}>{actionModal.type === 'delete' ? 'Delete Now' : 'Confirm'}</button></div></div></div>)}
                    {editingEl && (<div className="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4 backdrop-blur-sm"><div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform scale-100 transition-all"><div className="flex justify-between items-center mb-6"><h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Icon name="pencil" className="text-blue-600"/> Edit Element</h3><button onClick={() => setEditingEl(null)}><Icon name="x"/></button></div><form onSubmit={handleSaveEdit} className="space-y-4"><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Element ID {isAdminLocal ? '' : '(Read Only)'}</label>{isAdminLocal ? (<input name="elementId" defaultValue={editingEl.elementId} className="w-full p-3 border rounded font-bold text-slate-800 bg-white"/>):(<input name="elementId" value={editingEl.elementId} readOnly className="w-full p-3 border rounded bg-slate-100 text-slate-500 font-bold cursor-not-allowed"/>)}</div><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Cluster</label><input name="cluster" defaultValue={editingEl.cluster} className="w-full p-3 border rounded font-bold text-slate-800 bg-white"/></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Villa</label><input name="villa" defaultValue={editingEl.villa} className="w-full p-3 border rounded font-bold text-slate-800 bg-white"/></div></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Type</label><input name="type" defaultValue={editingEl.type} className="w-full p-3 border rounded font-bold text-slate-800 bg-white"/></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Volume (m³)</label><input name="volume" defaultValue={editingEl.volume} className="w-full p-3 border-2 border-blue-100 rounded font-bold text-slate-800 focus:border-blue-500 outline-none bg-white"/></div></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Length</label><input name="length" defaultValue={editingEl.length} className="w-full p-3 border rounded font-bold text-slate-800 bg-white"/></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Width/Height</label><input name="widthHeight" defaultValue={editingEl.widthHeight} className="w-full p-3 border rounded font-bold text-slate-800 bg-white"/></div></div><div className="bg-slate-50 p-3 rounded border"><div className="grid grid-cols-3 gap-4"><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Drawing Date (DWG)</label><input type="date" name="dwgDate" defaultValue={editingEl.dwgDate} className="w-full p-2 border rounded text-sm bg-white text-slate-900 font-bold"/></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Casting Date</label><input type="date" name="castingDate" defaultValue={editingEl.castingDate} className="w-full p-2 border rounded text-sm bg-white text-slate-900 font-bold"/></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Delivery Date</label><input type="date" name="deliveryDate" defaultValue={editingEl.deliveryDate} className="w-full p-2 border rounded text-sm bg-white text-slate-900 font-bold"/></div></div></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">QC Status</label><select name="qcStatus" defaultValue={editingEl.qcStatus || 'Pending'} className="w-full p-3 border rounded font-bold text-slate-800 bg-white text-sm"><option value="Pending">Pending</option><option value="Passed">Passed</option><option value="Failed">Failed</option><option value="Repair">Repair</option></select></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Stockyard Loc</label><input name="location" defaultValue={editingEl.location} placeholder="e.g. A-12" className="w-full p-3 border rounded font-bold text-slate-800 bg-white text-sm"/></div></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Notes</label><textarea name="notes" defaultValue={editingEl.notes} className="w-full p-3 border rounded font-bold text-slate-800 bg-white text-sm" rows="3"></textarea></div><div className="flex justify-end gap-3 mt-6"><button type="button" onClick={() => setEditingEl(null)} className="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded">Cancel</button><button type="submit" className="btn-primary text-white px-6 py-2 rounded font-bold shadow-lg">Save Changes</button></div></form></div></div>)}
                </div>
            );
        };

        const WeeklyPlanner = ({ projects, onUpdate, onImport, onPasteImport, onAdd, userRole }) => {
            const canEditLocal = (userRole === 'admin' || userRole === 'editor');
            const [selProj, setSelProj] = useState('');
            const [idFilter, setIdFilter] = useState('');
            const [metaFilter, setMetaFilter] = useState('');
            const [selectedDate, setSelectedDate] = useState(null);
            const [elements, setElements] = useState([]);
            const [loading, setLoading] = useState(true);
            const [dayOffset, setDayOffset] = useState(0);
            const dates = useMemo(() => getNext7Days(dayOffset), [dayOffset]);
            // Bulk planning state
            const [showBulkPlanModal, setShowBulkPlanModal] = useState(false);
            const [bulkPlanQty, setBulkPlanQty] = useState('');
            const [bulkPlanDate, setBulkPlanDate] = useState(new Date().toISOString().split('T')[0]);
            const [markAsTypical, setMarkAsTypical] = useState(false);
            const [noteModal, setNoteModal] = useState(null);

            // Load ALL elements (temporary fix until indexes are ready)
            useEffect(() => {
                setLoading(true);
                const unsub = db.collection('elements').orderBy('elementId').onSnapshot(s => {
                    const activeProjectNums = projects.filter(p => !p.archived).map(p => String(p.projectId));
                    const filtered = s.docs.map(d => ({id:d.id, ...d.data()})).filter(el => activeProjectNums.includes(String(el.projectNumber)));
                    setElements(filtered);
                    setLoading(false);
                });
                return () => unsub();
            }, [projects]);

            const { backlog, planned } = useMemo(() => {
                const p = elements.filter(e => {
                    if (selProj === '' || String(e.projectNumber) !== String(selProj)) return false;
                    if (idFilter && !String(e.elementId || '').toLowerCase().includes(idFilter.toLowerCase())) return false;
                    if (metaFilter && !checkMetaMatch(e, metaFilter)) return false;
                    return true; // Show all elements, including cast ones
                });
                return { backlog: p.filter(e => !e.plannedDate && !e.castingDate), planned: p.filter(e => e.plannedDate && dates.includes(e.plannedDate)) };
            }, [elements, selProj, idFilter, metaFilter, dates]);

            const handleBacklogDoubleClick = (id) => {
                if (!selectedDate) { alert("?? Please click a Date Header (e.g., 'Today') to select it first."); return; }
                onUpdate(id, { plannedDate: selectedDate }, "Scheduled via Double Click");
            };

            const handleDragStart = (e, id) => { e.dataTransfer.setData("text/plain", id); e.dataTransfer.effectAllowed = "move"; };
            const handleDragOver = (e) => { e.preventDefault(); e.currentTarget.classList.add('bg-blue-50'); };
            const handleDragLeave = (e) => { e.currentTarget.classList.remove('bg-blue-50'); };
            const handleDrop = (e, date) => { e.preventDefault(); e.currentTarget.classList.remove('bg-blue-50'); const id = e.dataTransfer.getData("text/plain"); if (id) { onUpdate(id, { plannedDate: date }, "Scheduled via Drag & Drop"); } };

            const handleBulkPlan = async () => {
                if (!canEditLocal) { alert('Permission denied: read-only account.'); return; }
                const qty = parseInt(bulkPlanQty);
                if (!qty || qty < 1) { alert('Please enter a valid quantity.'); return; }
                if (!bulkPlanDate) { alert('Please select a date.'); return; }
                if (backlog.length === 0) { alert('No elements available to plan.'); return; }
                
                const elementsToSchedule = backlog.slice(0, qty);
                if (elementsToSchedule.length < qty) {
                    if (!confirm(`Only ${elementsToSchedule.length} elements available. Plan all of them?`)) return;
                }
                
                try {
                    const batch = db.batch();
                    elementsToSchedule.forEach(el => {
                        const updateData = { plannedDate: bulkPlanDate };
                        if (markAsTypical) {
                            updateData.isTypical = true;
                            updateData.typicalQty = qty;
                        }
                        batch.update(db.collection('elements').doc(el.id), updateData);
                    });
                    await batch.commit();
                    const typicalMsg = markAsTypical ? ` (marked as ${qty} typical elements)` : '';
                    alert(`✅ Successfully planned ${elementsToSchedule.length} elements for ${formatDate(bulkPlanDate)}${typicalMsg}!`);
                    setShowBulkPlanModal(false);
                    setBulkPlanQty('');
                    setMarkAsTypical(false);
                } catch(e) {
                    console.error(e);
                    alert('Error during bulk planning: ' + e.message);
                }
            };

            const handleBulkUnplan = async () => {
                if (!canEditLocal) { alert('Permission denied: read-only account.'); return; }
                if (planned.length === 0) { alert('No elements to unplan.'); return; }
                
                if (!confirm(`⚠️ This will unplan all ${planned.length} scheduled elements.\n\nAre you sure?`)) return;
                
                try {
                    const batch = db.batch();
                    planned.forEach(el => {
                        batch.update(db.collection('elements').doc(el.id), { plannedDate: '' });
                    });
                    await batch.commit();
                    alert(`✅ Successfully unplanned ${planned.length} elements!`);
                } catch(e) {
                    console.error(e);
                    alert('Error during bulk unplan: ' + e.message);
                }
            };

            const handleUnplanDate = async (date) => {
                if (!canEditLocal) { alert('Permission denied: read-only account.'); return; }
                const elementsOnDate = planned.filter(e => e.plannedDate === date);
                if (elementsOnDate.length === 0) return;
                
                if (!confirm(`⚠️ Unplan all ${elementsOnDate.length} elements from ${formatDate(date)}?`)) return;
                
                try {
                    const batch = db.batch();
                    elementsOnDate.forEach(el => {
                        batch.update(db.collection('elements').doc(el.id), { plannedDate: '' });
                    });
                    await batch.commit();
                    alert(`✅ Successfully unplanned ${elementsOnDate.length} elements!`);
                } catch(e) {
                    console.error(e);
                    alert('Error: ' + e.message);
                }
            };

            const handleMarkAsCast = async (elementId) => {
                if (!canEditLocal) { alert('Permission denied: read-only account.'); return; }
                try {
                    const element = elements.find(e => e.id === elementId);
                    const newCastStatus = !element.isCasted;
                    
                    // Use planned date as the casting date, or today if no planned date
                    const castDate = element.plannedDate || (() => {
                        const today = new Date();
                        const y = today.getFullYear();
                        const m = String(today.getMonth() + 1).padStart(2, '0');
                        const d = String(today.getDate()).padStart(2, '0');
                        return `${y}-${m}-${d}`;
                    })();
                    
                    const updateData = { 
                        isCasted: newCastStatus,
                        actualCastDate: newCastStatus ? castDate : null,
                        castingDate: newCastStatus ? castDate : null,
                        status: newCastStatus ? 'Stockyard' : element.status
                    };
                    await db.collection('elements').doc(elementId).update(updateData);
                } catch(e) {
                    console.error(e);
                    alert('Error marking as cast: ' + e.message);
                }
            };

            const handleMoveUncastedToNextDay = async (date) => {
                if (!canEditLocal) { alert('Permission denied: read-only account.'); return; }
                const elementsOnDate = planned.filter(e => e.plannedDate === date);
                const uncastedElements = elementsOnDate.filter(e => !e.isCasted);
                
                if (uncastedElements.length === 0) {
                    alert('✅ All elements on this date are already marked as cast!');
                    return;
                }
                
                // Find next day in the visible week
                const currentIndex = dates.indexOf(date);
                if (currentIndex === -1 || currentIndex === dates.length - 1) {
                    alert('⚠️ Cannot move: this is the last day in the weekly view.');
                    return;
                }
                const nextDay = dates[currentIndex + 1];
                
                if (!confirm(`⚠️ Move ${uncastedElements.length} uncasted elements to ${formatDate(nextDay)}?`)) return;
                
                try {
                    const batch = db.batch();
                    uncastedElements.forEach(el => {
                        batch.update(db.collection('elements').doc(el.id), { plannedDate: nextDay });
                    });
                    await batch.commit();
                    alert(`✅ Successfully moved ${uncastedElements.length} uncasted elements to next day!`);
                } catch(e) {
                    console.error(e);
                    alert('Error: ' + e.message);
                }
            };

            const handleMarkAllAsCast = async (date) => {
                if (!canEditLocal) { alert('Permission denied: read-only account.'); return; }
                const elementsOnDate = planned.filter(e => e.plannedDate === date);
                const uncastedElements = elementsOnDate.filter(e => !e.isCasted);
                
                if (uncastedElements.length === 0) {
                    alert('✅ All elements on this date are already marked as cast!');
                    return;
                }
                
                if (!confirm(`✅ Mark all ${uncastedElements.length} elements as cast for ${formatDate(date)}?`)) return;
                
                try {
                    const batch = db.batch();
                    
                    uncastedElements.forEach(el => {
                        // Use the planned date as the casting date
                        batch.update(db.collection('elements').doc(el.id), { 
                            isCasted: true,
                            actualCastDate: date,
                            castingDate: date,
                            status: 'Stockyard'
                        });
                    });
                    await batch.commit();
                    alert(`✅ Successfully marked ${uncastedElements.length} elements as cast on ${formatDate(date)}!`);
                } catch(e) {
                    console.error(e);
                    alert('Error: ' + e.message);
                }
            };

            const handleSaveNote = async () => {
                if (!noteModal) return;
                await onUpdate(noteModal.id, { notes: noteModal.text }, "Updated remarks");
                setNoteModal(null);
            };

            return (
                <div className="bg-white p-6 rounded-xl border border-slate-200 h-full fade-in flex flex-col">
                    <div className="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <div className="flex items-center gap-3">
                            <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Icon name="calendar"/> Weekly Planner</h2>
                            <div className="flex items-center gap-1 bg-slate-100 rounded-lg p-1">
                                <button onClick={() => setDayOffset(d => d - 1)} className="px-3 py-1 rounded bg-white hover:bg-slate-50 text-slate-700 font-bold text-sm transition">
                                    ← Prev
                                </button>
                                <span className="px-3 text-xs font-bold text-slate-600 whitespace-nowrap">
                                    {dates.length > 0 && `${formatDate(dates[0])} - ${formatDate(dates[6])}`}
                                </span>
                                <button onClick={() => setDayOffset(d => d + 1)} className="px-3 py-1 rounded bg-white hover:bg-slate-50 text-slate-700 font-bold text-sm transition">
                                    Next →
                                </button>
                                {dayOffset !== 0 && (
                                    <button onClick={() => setDayOffset(0)} className="px-3 py-1 rounded bg-blue-600 hover:bg-blue-700 text-white font-bold text-xs transition">
                                        Today
                                    </button>
                                )}
                            </div>
                        </div>
                        <div className="flex gap-2 items-center">
                            {canEditLocal && selProj && backlog.length > 0 && (
                                <button onClick={() => setShowBulkPlanModal(true)} className="btn-secondary flex items-center gap-2"><Icon name="list"/> Bulk Plan</button>
                            )}
                            <button onClick={onImport} className="btn-outline"><Icon name="upload"/> Import</button>
                            <button onClick={onPasteImport} className="btn-outline"><Icon name="paste"/> Paste</button>
                            <button onClick={onAdd} className="btn-primary"><Icon name="plus"/> Add</button>
                        </div>
                    </div>
                    <div className="flex gap-3 mb-4">
                        <div className="flex gap-2 items-center flex-1">
                            <select onChange={e=>setSelProj(e.target.value)} className="p-2 border rounded font-bold text-slate-700 w-64 shadow-sm focus:ring-2 focus:ring-blue-500 outline-none"><option value="">-- Select Project --</option>{projects.filter(p => !p.archived).map(p=><option key={p.id} value={p.projectId}>{p.projectId} - {p.name}</option>)}</select>
                            <div className="relative"><Icon name="hashtag" className="absolute left-3 top-2.5 text-slate-400" size={14}/><input placeholder="Search ID..." onChange={e => setIdFilter(e.target.value)} className="pl-9 p-2 border rounded text-sm w-40 shadow-sm bg-white text-slate-900 font-bold"/></div>
                            <div className="relative"><Icon name="search" className="absolute left-3 top-2.5 text-slate-400" size={14}/><input placeholder="Villa, Cluster..." onChange={e => setMetaFilter(e.target.value)} className="pl-9 p-2 border rounded text-sm w-48 shadow-sm bg-white text-slate-900 font-bold"/></div>
                        </div>
                    </div>
                    {!selProj ? (<div className="flex-1 flex flex-col items-center justify-center text-slate-400 bg-slate-50 rounded-xl border border-dashed"><Icon name="building" size={48} className="mb-4 text-slate-300"/><p className="font-medium">Select a project to start planning</p></div>) : (
                        <div className="flex-1 flex gap-4 overflow-auto">
                            <div className="flex-1 grid grid-cols-7 border rounded-xl bg-white shadow-sm select-none" style={{height: 'fit-content', minHeight: '500px'}}>
                                {dates.map(d => {
                                    const dateElements = planned.filter(e=>e.plannedDate===d);
                                    const totalVolume = dateElements.reduce((sum, e) => {
                                        const vol = parseFloat(e.volume || 0);
                                        const qty = e.isTypical && e.typicalQty > 1 ? e.typicalQty : 1;
                                        return sum + (vol * qty);
                                    }, 0);
                                    return (
                                    <div key={d} className={`border-r last:border-r-0 flex flex-col transition-colors duration-200`} onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={(e) => handleDrop(e, d)}>
                                        <div className={`p-3 text-center border-b transition ${selectedDate === d ? 'bg-blue-600 text-white' : 'bg-slate-50 text-slate-800'}`}>
                                            <div onClick={() => setSelectedDate(d)} className="cursor-pointer">
                                                <span className={`block text-xs font-bold uppercase ${selectedDate === d ? 'text-blue-100' : 'text-slate-500'}`}>{new Date(d).toLocaleDateString('en-US',{weekday:'short'})}</span><span className="block text-lg font-bold">{new Date(d).getDate()}</span>
                                                <span className={`block text-[10px] mt-1 ${selectedDate === d ? 'text-blue-200' : 'text-slate-400'}`}>{dateElements.length} items | {totalVolume.toFixed(2)} m³</span>
                                            </div>
                                            {canEditLocal && dateElements.length > 0 && (
                                                <div className="mt-2 space-y-1">
                                                    <button onClick={(e) => { e.stopPropagation(); handleMarkAllAsCast(d); }} className={`w-full text-[10px] py-1 rounded font-bold transition ${selectedDate === d ? 'bg-green-500 hover:bg-green-600 text-white' : 'bg-green-100 hover:bg-green-200 text-green-700'}`}>
                                                        ✓ Mark All Cast
                                                    </button>
                                                    <button onClick={(e) => { e.stopPropagation(); handleMoveUncastedToNextDay(d); }} className={`w-full text-[10px] py-1 rounded font-bold transition ${selectedDate === d ? 'bg-amber-500 hover:bg-amber-600 text-white' : 'bg-amber-100 hover:bg-amber-200 text-amber-700'}`}>
                                                        Move Uncasted →
                                                    </button>
                                                    <button onClick={(e) => { e.stopPropagation(); handleUnplanDate(d); }} className={`w-full text-[10px] py-1 rounded font-bold transition ${selectedDate === d ? 'bg-red-500 hover:bg-red-600 text-white' : 'bg-red-100 hover:bg-red-200 text-red-700'}`}>
                                                        Unplan All
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                        <div className="p-2 space-y-2 bg-slate-50/30 min-h-[100px]">
                                            {planned.filter(e=>e.plannedDate===d).map(e=>(
                                                <div key={e.id} draggable="true" onDragStart={(ev) => handleDragStart(ev, e.id)} className={`bg-white border-2 p-2 rounded shadow-sm text-xs relative group font-bold transition cursor-move ${e.isCasted ? 'border-green-500 bg-green-50' : 'border-slate-200 hover:border-blue-400'}`}>
                                                    <div className="flex items-center gap-2">
                                                        {e.isCasted ? (
                                                            <span className="text-green-600 font-bold text-sm">✓</span>
                                                        ) : (
                                                            <span className="w-1.5 h-1.5 rounded-full bg-blue-500"></span>
                                                        )}
                                                        <span className={e.isCasted ? 'text-green-700' : 'text-slate-700'}>{e.elementId}</span>
                                                    </div>
                                                    {e.isCasted && e.actualCastDate && (
                                                        <div className="text-[9px] text-green-600 mt-0.5">Cast: {formatDate(e.actualCastDate)}</div>
                                                    )}
                                                    <div className="absolute top-1 right-1 hidden group-hover:flex gap-0.5">
                                                        {canEditLocal && (
                                                            <>
                                                                <button onClick={(ev) => { ev.stopPropagation(); setNoteModal({ id: e.id, text: e.notes || '' }); }} className="text-[10px] px-1.5 py-0.5 rounded font-bold bg-blue-100 text-blue-700 hover:bg-blue-200" title="Edit Remarks"><Icon name="pencil" size={10}/></button>
                                                                <button onClick={(ev) => { ev.stopPropagation(); handleMarkAsCast(e.id); }} className={`text-[10px] px-1.5 py-0.5 rounded font-bold transition ${e.isCasted ? 'bg-slate-100 text-slate-600 hover:bg-slate-200' : 'bg-green-100 text-green-700 hover:bg-green-200'}`}>{e.isCasted ? 'Uncast' : 'Cast'}</button>
                                                            </>
                                                        )}
                                                        <button onClick={()=>onUpdate(e.id,{plannedDate:''}, "Removed from Schedule")} className="text-red-400 hover:bg-red-50 rounded p-0.5">
                                                            <Icon name="x" size={12}/>
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                            {planned.filter(e=>e.plannedDate===d).length === 0 && (<div className="h-full flex items-center justify-center text-slate-300 text-[10px] italic">Drop here</div>)}
                                        </div>
                                    </div>
                                );
                                })}
                            </div>
                            <div className="w-80 bg-white border rounded-xl flex flex-col shadow-sm">
                                <div className="p-3 bg-slate-100 border-b flex justify-between items-center rounded-t-xl"><h3 className="font-bold text-sm text-slate-700">Backlog</h3><span className="bg-slate-200 text-slate-600 text-[10px] px-2 py-0.5 rounded-full font-bold">{backlog.length}</span></div>
                                <div className="flex-1 overflow-y-auto p-2 space-y-2">
                                    {backlog.length === 0 ? (<div className="text-center text-xs text-slate-400 mt-10 italic">No items found</div>) : (backlog.map(e => (<div key={e.id} className="bg-white border border-slate-200 p-2 rounded text-xs font-medium hover:border-blue-500 hover:shadow-md transition select-none group"><div draggable="true" onDragStart={(ev) => handleDragStart(ev, e.id)} onDoubleClick={() => handleBacklogDoubleClick(e.id)} className="cursor-move active:cursor-grabbing"><div className="flex justify-between items-center"><span className="font-bold text-slate-700">{e.elementId}</span><span className="text-[10px] text-slate-400">{e.type}</span></div>{(e.cluster || e.villa) && <div className="text-[10px] text-slate-500 mt-0.5 flex gap-2">{e.cluster && <span>C: {e.cluster}</span>}{e.villa && <span>V: {e.villa}</span>}</div>}<div className="text-[10px] text-slate-400 mt-1">{cleanDim(e.length)} x {cleanDim(e.widthHeight)}</div></div>{canEditLocal && (<div className="mt-2 pt-2 border-t border-slate-100 flex items-center gap-2"><input type="checkbox" id={`typ-${e.id}`} checked={e.isTypical || false} onChange={(ev) => { ev.stopPropagation(); onUpdate(e.id, { isTypical: ev.target.checked, typicalQty: ev.target.checked ? (e.typicalQty || 1) : null }, "Marked as typical"); }} className="w-3 h-3 cursor-pointer"/><label htmlFor={`typ-${e.id}`} className="text-[10px] text-slate-600 cursor-pointer flex-1">Typical</label>{e.isTypical && (<input type="number" min="1" value={e.typicalQty || 1} onChange={(ev) => { ev.stopPropagation(); onUpdate(e.id, { typicalQty: parseInt(ev.target.value) || 1 }, "Updated typical qty"); }} onClick={(ev) => ev.stopPropagation()} className="w-12 px-1 py-0.5 border rounded text-[10px] text-center font-bold text-blue-600" placeholder="Qty"/>)}</div>)}</div>)))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Bulk Plan Modal */}
                    {showBulkPlanModal && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md">
                                <div className="p-4 border-b bg-slate-50 flex justify-between items-center rounded-t-xl">
                                    <h3 className="font-bold text-lg flex items-center gap-2"><Icon name="list"/> Bulk Plan Elements</h3>
                                    <button onClick={() => { setShowBulkPlanModal(false); setBulkPlanQty(''); setMarkAsTypical(false); }} className="text-slate-400 hover:text-slate-600"><Icon name="x"/></button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold text-slate-700 mb-2">Number of Elements to Plan</label>
                                        <input type="number" min="1" max={backlog.length} value={bulkPlanQty} onChange={e => setBulkPlanQty(e.target.value)} placeholder="Enter quantity" className="w-full p-2 border rounded font-bold text-slate-700"/>
                                        <p className="text-xs text-slate-500 mt-1">{backlog.length} elements available in backlog</p>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-slate-700 mb-2">Target Date</label>
                                        <input type="date" value={bulkPlanDate} onChange={e => setBulkPlanDate(e.target.value)} className="w-full p-2 border rounded font-bold text-slate-700"/>
                                    </div>
                                    <div className="border-t pt-4">
                                        <label className="flex items-center gap-3 cursor-pointer p-3 rounded-lg hover:bg-yellow-50 border-2 border-transparent hover:border-yellow-200 transition">
                                            <input type="checkbox" checked={markAsTypical} onChange={e => setMarkAsTypical(e.target.checked)} className="w-5 h-5 cursor-pointer accent-yellow-500"/>
                                            <div className="flex-1">
                                                <div className="font-bold text-slate-800 flex items-center gap-2">
                                                    <span className="text-yellow-600">★</span> Mark as Typical Elements
                                                </div>
                                                <p className="text-xs text-slate-500 mt-0.5">These elements will be grouped in the report showing total quantity</p>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div className="p-4 border-t bg-slate-50 flex justify-end gap-2 rounded-b-xl">
                                    <button onClick={() => { setShowBulkPlanModal(false); setBulkPlanQty(''); setMarkAsTypical(false); }} className="px-4 py-2 border rounded text-sm font-bold text-slate-700 hover:bg-slate-100">Cancel</button>
                                    <button onClick={handleBulkPlan} disabled={!bulkPlanQty || parseInt(bulkPlanQty) <= 0} className="px-4 py-2 bg-emerald-600 text-white rounded text-sm font-bold hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed">Plan Elements</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {noteModal && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
                                <h3 className="font-bold text-lg mb-4">Edit Remarks</h3>
                                <textarea value={noteModal.text} onChange={e => setNoteModal({...noteModal, text: e.target.value})} className="w-full p-3 border rounded mb-4 text-sm focus:border-blue-500 outline-none" rows={3} placeholder="Enter remarks (e.g. Top Priority)..." autoFocus />
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setNoteModal(null)} className="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded">Cancel</button>
                                    <button onClick={handleSaveNote} className="btn-primary">Save</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ReportsView = ({ projects, onUpdate, userRole, notes = [] }) => {
            const [type, setType] = useState('production'); 
            const [mode, setmode] = useState('summary'); 
            const [start, setStart] = useState(new Date().toISOString().split('T')[0]);
            const [end, setEnd] = useState(new Date().toISOString().split('T')[0]);
            const [proj, setProj] = useState('');
            const [search, setSearch] = useState('');
            const [elements, setElements] = useState([]);
            const [loading, setLoading] = useState(true);
            const [weeklyPlanProj, setWeeklyPlanProj] = useState('');
            const [weeklyPlanStart, setWeeklyPlanStart] = useState(new Date().toISOString().split('T')[0]);
            const [weeklyPlanEnd, setWeeklyPlanEnd] = useState(() => {
                const date = new Date();
                date.setDate(date.getDate() + 6);
                return date.toISOString().split('T')[0];
            });
            const [editingRemark, setEditingRemark] = useState(null);
            const [showKPIGraphs, setShowKPIGraphs] = useState(false);

            // Load ALL elements (temporary fix until indexes are ready)
            useEffect(() => {
                setLoading(true);
                const unsub = db.collection('elements').orderBy('elementId').onSnapshot(s => {
                    const activeProjectNums = projects.filter(p => !p.archived).map(p => String(p.projectId));
                    const filtered = s.docs.map(d => ({id:d.id, ...d.data()})).filter(el => activeProjectNums.includes(String(el.projectNumber)));
                    setElements(filtered);
                    setLoading(false);
                });
                return () => unsub();
            }, [projects]);

            // DN mapping for delivered items
            const dnByElementId = useMemo(() => {
                const map = {};
                (notes || []).forEach(n => (n.items || []).forEach(it => {
                    if (it?.elementId) map[String(it.elementId)] = n.dnNumber;
                }));
                return map;
            }, [notes]);

            // Project Detail Mode Data
            const projectDetailElements = useMemo(() => {
                if (type !== 'projectdetail' || !proj) return [];
                return elements.filter(el => String(el.projectNumber) === String(proj));
            }, [elements, type, proj]);

            const projectDetail = useMemo(() => {
                if (type !== 'projectdetail' || !proj) return null;
                const els = projectDetailElements;

                const total = els.length;
                const castedEls = els.filter(e => !!e.castingDate);
                const deliveredEls = els.filter(e => !!e.deliveryDate);
                const scheduledEls = els.filter(e => !e.castingDate);
                const stockyardEls = els.filter(e => e.castingDate && !e.deliveryDate);

                const sumVol = (arr) => arr.reduce((a, b) => a + parseFloat(b.volume || 0), 0);
                const totalVol = sumVol(els);
                const castVol = sumVol(castedEls);
                const delVol = sumVol(deliveredEls);
                const scheduledVol = sumVol(scheduledEls);
                const stockyardVol = sumVol(stockyardEls);

                // Type breakdown
                const typeMap = {};
                els.forEach(e => {
                    const t = (e.type || 'Unknown').trim();
                    if (!typeMap[t]) typeMap[t] = { count: 0, volume: 0 };
                    typeMap[t].count++;
                    typeMap[t].volume += parseFloat(e.volume || 0);
                });

                // Filter by date range
                const inRange = (d, from, to) => {
                    if (!d) return false;
                    const s = String(d).slice(0, 10);
                    return (!from || s >= from) && (!to || s <= to);
                };
                const castInRange = castedEls.filter(e => inRange(e.castingDate, start, end));
                const delInRange = deliveredEls.filter(e => inRange(e.deliveryDate, start, end));

                return {
                    total, totalVol, castedEls, deliveredEls, scheduledEls, stockyardEls,
                    castVol, delVol, scheduledVol, stockyardVol,
                    typeBreakdown: Object.entries(typeMap).sort((a,b)=>b[1].count-a[1].count),
                    castInRange, delInRange
                };
            }, [projectDetailElements, proj, type, start, end]);

            // Stock Report Data - Grouped by Project
            const stockReportData = useMemo(() => {
                if (type !== 'stockreport') return [];
                
                // Filter elements in stockyard (casted but not delivered)
                const stockyardElements = elements.filter(el => el.castingDate && !el.deliveryDate);
                
                // Filter by project if selected
                const filtered = proj ? stockyardElements.filter(el => String(el.projectNumber) === String(proj)) : stockyardElements;
                
                // Group by project first, then by type within each project
                const projectGroups = {};
                filtered.forEach(el => {
                    const projNum = el.projectNumber || 'Unknown';
                    const projName = el.projectName || 'Unknown';
                    const elType = (el.type || 'Unknown').trim();
                    
                    if (!projectGroups[projNum]) {
                        projectGroups[projNum] = {
                            projectNumber: projNum,
                            projectName: projName,
                            types: {}
                        };
                    }
                    
                    if (!projectGroups[projNum].types[elType]) {
                        projectGroups[projNum].types[elType] = {
                            type: elType,
                            count: 0,
                            volume: 0
                        };
                    }
                    
                    projectGroups[projNum].types[elType].count++;
                    projectGroups[projNum].types[elType].volume += parseFloat(el.volume || 0);
                });
                
                // Convert to array and sort
                return Object.values(projectGroups)
                    .sort((a, b) => String(a.projectNumber).localeCompare(String(b.projectNumber)))
                    .map(proj => ({
                        ...proj,
                        types: Object.values(proj.types).sort((a, b) => a.type.localeCompare(b.type))
                    }));
            }, [elements, type, proj]);

            const stockReportTotals = useMemo(() => {
                if (type !== 'stockreport') return { count: 0, volume: 0 };
                let totalCount = 0;
                let totalVolume = 0;
                stockReportData.forEach(proj => {
                    proj.types.forEach(typeData => {
                        totalCount += typeData.count;
                        totalVolume += typeData.volume;
                    });
                });
                return { count: totalCount, volume: totalVolume };
            }, [stockReportData, type]);

            const filteredData = useMemo(() => { const res = elements.filter(el => {
                if(proj && String(el.projectNumber).trim() !== String(proj).trim()) return false;
                let dbDate = type === 'production' ? el.castingDate : el.deliveryDate;
                if (!dbDate) return false;
                dbDate = String(dbDate).trim().substring(0, 10); 
                if (dbDate < start || dbDate > end) return false;
                if (search) {
                    const s = search.toLowerCase();
                    const matchmeta = checkMetaMatch(el, search); 
                    const matchId = String(el.elementId || '').toLowerCase().includes(s);
                    if (!matchmeta && !matchId) return false;
                }
                return true;
            });
            return res.sort((a, b) => {
                const da = type === 'production' ? (a.castingDate||'') : (a.deliveryDate||'');
                const db = type === 'production' ? (b.castingDate||'') : (b.deliveryDate||'');
                return da.localeCompare(db);
            }); }, [elements, type, start, end, proj, search]);

            const summaryData = useMemo(() => {
                if (mode !== 'summary') return [];
                const groups = {};
                filteredData.forEach(el => {
                    const normalizedType = (el.type || 'Unknown').trim();
                    const key = `${el.projectNumber}_${normalizedType}`;
                    if (!groups[key]) groups[key] = { projectNo: el.projectNumber, projectName: el.projectName, type: normalizedType, count: 0, volume: 0 };
                    groups[key].count += 1;
                    groups[key].volume += parseFloat(el.volume || 0);
                });
                return Object.values(groups).sort((a, b) => String(a.projectNo).localeCompare(String(b.projectNo)));
            }, [filteredData, mode]);

            const totalCount = summaryData.reduce((acc, curr) => acc + curr.count, 0);
            const totalVol = summaryData.reduce((acc, curr) => acc + curr.volume, 0);

            const dailyData = useMemo(() => {
                if (mode !== 'daily') return [];
                const groups = {};
                filteredData.forEach(el => {
                    const d = type === 'production' ? el.castingDate : el.deliveryDate;
                    if (!d) return;
                    const pNum = el.projectNumber || 'Unknown';
                    const pName = el.projectName || '';
                    const key = `${d}_${pNum}`;
                    if (!groups[key]) groups[key] = { date: d, projectNumber: pNum, projectName: pName, count: 0, volume: 0 };
                    groups[key].count++;
                    groups[key].volume += parseFloat(el.volume || 0);
                });
                return Object.values(groups).sort((a, b) => { const dc = a.date.localeCompare(b.date); if(dc!==0) return dc; return String(a.projectNumber).localeCompare(String(b.projectNumber)); });
            }, [filteredData, mode, type]);

            // Weekly Plan Report
            const weeklyPlanData = useMemo(() => {
                if (type !== 'weeklyplan') return [];
                return elements.filter(el => {
                    if (weeklyPlanProj && String(el.projectNumber) !== String(weeklyPlanProj)) return false;
                    if (!el.plannedDate) return false;
                    const planDate = el.plannedDate;
                    if (planDate < weeklyPlanStart || planDate > weeklyPlanEnd) return false;
                    return true;
                }).sort((a, b) => {
                    // Sort by project number first, then by planned date, then by element ID
                    const projCompare = String(a.projectNumber).localeCompare(String(b.projectNumber));
                    if (projCompare !== 0) return projCompare;
                    const dateCompare = a.plannedDate.localeCompare(b.plannedDate);
                    if (dateCompare !== 0) return dateCompare;
                    return a.elementId.localeCompare(b.elementId);
                });
            }, [elements, type, weeklyPlanProj, weeklyPlanStart, weeklyPlanEnd]);

            const weeklyGroupedByProject = useMemo(() => {
                if (type !== 'weeklyplan') return {};
                const groups = {};
                weeklyPlanData.forEach(el => {
                    const projKey = String(el.projectNumber);
                    if (!groups[projKey]) {
                        groups[projKey] = {
                            projectNumber: el.projectNumber,
                            projectName: el.projectName,
                            dates: {}
                        };
                    }
                    // Always use the first non-empty projectName encountered
                    if (!groups[projKey].projectName && el.projectName) {
                        groups[projKey].projectName = el.projectName;
                    }
                    const date = el.plannedDate;
                    if (!groups[projKey].dates[date]) groups[projKey].dates[date] = [];
                    groups[projKey].dates[date].push(el);
                });
                return groups;
            }, [weeklyPlanData, type]);

            const handleExport = () => {
                if (type === 'stockreport') {
                    const fileName = `StockReport_${proj || 'AllProjects'}_${new Date().toISOString().split('T')[0]}.xlsx`;
                    const data = [];
                    stockReportData.forEach(projectGroup => {
                        projectGroup.types.forEach(typeData => {
                            data.push({
                                "Project #": projectGroup.projectNumber,
                                "Project Name": projectGroup.projectName,
                                "Type": typeData.type,
                                "Count": typeData.count,
                                "Volume (m³)": typeData.volume.toFixed(2)
                            });
                        });
                    });
                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Stock_Report");
                    XLSX.writeFile(wb, fileName);
                    return;
                }
                if (type === 'projectdetail' && projectDetail) {
                    const fileName = `ProjectDetail_${proj}_${new Date().toISOString().split('T')[0]}.xlsx`;
                    const data = [
                        { Section: 'KPIs', Metric: 'Total Elements', Value: projectDetail.total },
                        { Section: 'KPIs', Metric: 'Total Volume (m³)', Value: projectDetail.totalVol.toFixed(3) },
                        { Section: 'KPIs', Metric: 'Casted Count', Value: projectDetail.castedEls.length },
                        { Section: 'KPIs', Metric: 'Casted Volume (m³)', Value: projectDetail.castVol.toFixed(3) },
                        { Section: 'KPIs', Metric: 'Delivered Count', Value: projectDetail.deliveredEls.length },
                        { Section: 'KPIs', Metric: 'Delivered Volume (m³)', Value: projectDetail.delVol.toFixed(3) },
                        { Section: 'KPIs', Metric: 'Scheduled Count', Value: projectDetail.scheduledEls.length },
                        { Section: 'KPIs', Metric: 'Scheduled Volume (m³)', Value: projectDetail.scheduledVol.toFixed(3) },
                        { Section: 'KPIs', Metric: 'Stockyard Count', Value: projectDetail.stockyardEls.length },
                        { Section: 'KPIs', Metric: 'Stockyard Volume (m³)', Value: projectDetail.stockyardVol.toFixed(3) },
                        ...projectDetail.typeBreakdown.map(([type, agg]) => ({
                            Section: 'Type Breakdown', Type: type, Count: agg.count, Volume: agg.volume.toFixed(3)
                        })),
                        ...projectDetail.scheduledEls.map(e => ({
                            Section: 'Scheduled', ElementID: e.elementId, Type: e.type, Cluster: e.cluster || '',
                            Villa: e.villa || '', Length: e.length, WidthHeight: e.widthHeight, Volume: parseFloat(e.volume || 0)
                        })),
                        ...projectDetail.stockyardEls.map(e => ({
                            Section: 'Stockyard', ElementID: e.elementId, CastDate: e.castingDate, Type: e.type,
                            Volume: parseFloat(e.volume || 0), Notes: e.notes || ''
                        })),
                        ...projectDetail.castInRange.map(e => ({
                            Section: 'Produced', ElementID: e.elementId, CastDate: e.castingDate, Type: e.type,
                            Volume: parseFloat(e.volume || 0), Status: e.status
                        })),
                        ...projectDetail.delInRange.map(e => ({
                            Section: 'Delivered', ElementID: e.elementId, DeliveryDate: e.deliveryDate,
                            DN: dnByElementId[e.elementId] || '-', Type: e.type, Volume: parseFloat(e.volume || 0)
                        }))
                    ];
                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Project_Detail");
                    XLSX.writeFile(wb, fileName);
                    return;
                }
                let data = [];
                let fileName = `Report_${type}_${mode}_${new Date().toISOString().split('T')[0]}.xlsx`;

                if (type === 'weeklyplan') {
                    data = weeklyPlanData.map(e => ({
                        "Planned Date": e.plannedDate,
                        "Project": e.projectName,
                        "Element ID": e.elementId,
                        "Type": e.type,
                        "Volume": parseFloat(e.volume||0),
                        "Remarks": e.notes || ''
                    }));
                } else if (mode === 'summary') {
                    data = summaryData.map(r => ({
                        "Project #": r.projectNo,
                        "Project Name": r.projectName,
                        "Type": r.type,
                        "Count": r.count,
                        "Volume": r.volume
                    }));
                } else if (mode === 'daily') {
                    data = dailyData.map(r => ({
                        "Date": r.date,
                        "Project #": r.projectNumber,
                        "Project Name": r.projectName,
                        "Count": r.count,
                        "Volume": r.volume
                    }));
                } else {
                    data = filteredData.map(e => ({
                        "Date": type === 'production' ? e.castingDate : e.deliveryDate,
                        "Project": e.projectName,
                        "Element ID": e.elementId,
                        "Type": e.type,
                        "Volume": parseFloat(e.volume || 0),
                        "Status": e.status
                    }));
                }
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Report");
                XLSX.writeFile(wb, fileName);
            };

            const saveRemark = () => {
                if(editingRemark && onUpdate) {
                    onUpdate(editingRemark.id, { notes: editingRemark.text }, "Updated remark from report");
                }
                setEditingRemark(null);
            };

            // Create KPI Charts when modal opens
            useEffect(() => {
                if (!showKPIGraphs || elements.length === 0) return;
                
                setTimeout(() => {
                    // Register datalabels plugin globally
                    if (window.ChartDataLabels) {
                        Chart.register(ChartDataLabels);
                    }
                    
                    // Filter elements based on selected project and date range
                    let filteredElements = elements;
                    
                    if (proj) {
                        filteredElements = filteredElements.filter(el => String(el.projectNumber) === String(proj));
                    }
                    
                    // Generate date range between start and end
                    const startDate = new Date(start);
                    const endDate = new Date(end);
                    const dateRange = [];
                    const currentDate = new Date(startDate);
                    
                    while (currentDate <= endDate) {
                        dateRange.push(currentDate.toISOString().split('T')[0]);
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    
                    // If date range is too small, use last 30 days
                    const displayDates = dateRange.length >= 7 ? dateRange : (() => {
                        const last30Days = [];
                        for (let i = 29; i >= 0; i--) {
                            const d = new Date();
                            d.setDate(d.getDate() - i);
                            last30Days.push(d.toISOString().split('T')[0]);
                        }
                        return last30Days;
                    })();
                    
                    const productionByDay = {};
                    const deliveryByDay = {};
                    displayDates.forEach(date => {
                        productionByDay[date] = 0;
                        deliveryByDay[date] = 0;
                    });
                    
                    elements.forEach(el => {
                        if (el.castingDate && productionByDay[el.castingDate] !== undefined) {
                            productionByDay[el.castingDate]++;
                        }
                        if (el.deliveryDate && deliveryByDay[el.deliveryDate] !== undefined) {
                            deliveryByDay[el.deliveryDate]++;
                        }
                    });
                    
                    // Cumulative data for trend chart
                    const cumulativeProd = [];
                    const cumulativeDel = [];
                    let prodSum = 0;
                    let delSum = 0;
                    displayDates.forEach(date => {
                        prodSum += productionByDay[date];
                        delSum += deliveryByDay[date];
                        cumulativeProd.push(prodSum);
                        cumulativeDel.push(delSum);
                    });
                    
                    // Project volumes
                    const projectVol = {};
                    filteredElements.forEach(el => {
                        const proj = el.projectName || 'Unknown';
                        if (!projectVol[proj]) projectVol[proj] = 0;
                        projectVol[proj] += parseFloat(el.volume || 0);
                    });
                    const topProjects = Object.entries(projectVol).sort((a, b) => b[1] - a[1]).slice(0, 6);
                    
                    // Chart 1: Production Trend (Line Chart)
                    const trendCtx = document.getElementById('productionTrendChart');
                    if (trendCtx) {
                        if (trendCtx.chart) trendCtx.chart.destroy();
                        trendCtx.chart = new Chart(trendCtx, {
                            type: 'line',
                            plugins: [ChartDataLabels],
                            data: {
                                labels: displayDates.map(d => new Date(d).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })),
                                datasets: [
                                    {
                                        label: 'Cumulative Production',
                                        data: cumulativeProd,
                                        borderColor: '#8b5cf6',
                                        backgroundColor: 'rgba(139, 92, 246, 0.15)',
                                        fill: true,
                                        tension: 0.4,
                                        borderWidth: 3,
                                        pointRadius: 3,
                                        pointHoverRadius: 5,
                                        pointBackgroundColor: '#8b5cf6',
                                        pointBorderColor: '#fff',
                                        pointBorderWidth: 2
                                    },
                                    {
                                        label: 'Cumulative Delivery',
                                        data: cumulativeDel,
                                        borderColor: '#10b981',
                                        backgroundColor: 'rgba(16, 185, 129, 0.15)',
                                        fill: true,
                                        tension: 0.4,
                                        borderWidth: 3,
                                        pointRadius: 3,
                                        pointHoverRadius: 5,
                                        pointBackgroundColor: '#10b981',
                                        pointBorderColor: '#fff',
                                        pointBorderWidth: 2
                                    }
                                ]
                            },
                            options: {
                                devicePixelRatio: 4,
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: { 
                                        position: 'top', 
                                        labels: { 
                                            font: { size: 12, weight: 'bold' },
                                            padding: 10,
                                            usePointStyle: true,
                                            pointStyle: 'circle'
                                        } 
                                    },
                                    datalabels: {
                                        display: function(context) {
                                            return context.dataIndex % Math.max(1, Math.ceil(displayDates.length / 8)) === 0;
                                        },
                                        color: function(context) {
                                            return context.datasetIndex === 0 ? '#8b5cf6' : '#10b981';
                                        },
                                        font: { size: 10, weight: 'bold' },
                                        anchor: 'end',
                                        align: 'top',
                                        offset: 4,
                                        backgroundColor: 'rgba(255, 255, 255, 0.8)',
                                        borderRadius: 3,
                                        padding: 3
                                    }
                                },
                                scales: {
                                    x: { 
                                        ticks: { font: { size: 10, weight: '500' } },
                                        grid: { color: '#f1f5f9', lineWidth: 1 }
                                    },
                                    y: { 
                                        beginAtZero: true, 
                                        ticks: { font: { size: 11, weight: '500' } },
                                        grid: { color: '#e2e8f0', lineWidth: 1 }
                                    }
                                }
                            }
                        });
                    }
                    
                    // Chart 2: Weekly Activity (Bar Chart)
                    const activityCtx = document.getElementById('weeklyActivityChart');
                    if (activityCtx) {
                        if (activityCtx.chart) activityCtx.chart.destroy();
                        const displayDays = displayDates.slice(-14); // Last 14 days or date range
                        activityCtx.chart = new Chart(activityCtx, {
                            type: 'bar',
                            plugins: [ChartDataLabels],
                            data: {
                                labels: displayDays.map(d => new Date(d).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })),
                                datasets: [
                                    {
                                        label: 'Produced',
                                        data: displayDays.map(d => productionByDay[d]),
                                        backgroundColor: '#3b82f6'
                                    },
                                    {
                                        label: 'Delivered',
                                        data: displayDays.map(d => deliveryByDay[d]),
                                        backgroundColor: '#f59e0b'
                                    }
                                ]
                            },
                            options: {
                                devicePixelRatio: 4,
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: { 
                                        position: 'top', 
                                        labels: { 
                                            font: { size: 12, weight: 'bold' },
                                            padding: 10,
                                            usePointStyle: true,
                                            boxWidth: 12,
                                            boxHeight: 12
                                        } 
                                    },
                                    datalabels: {
                                        display: function(context) {
                                            return context.dataset.data[context.dataIndex] > 0;
                                        },
                                        color: '#fff',
                                        font: { size: 11, weight: 'bold' },
                                        anchor: 'center',
                                        align: 'center',
                                        formatter: function(value) {
                                            return value;
                                        }
                                    }
                                },
                                scales: {
                                    x: { 
                                        ticks: { font: { size: 10, weight: '500' } },
                                        grid: { display: false }
                                    },
                                    y: { 
                                        beginAtZero: true, 
                                        ticks: { font: { size: 11, weight: '500' } },
                                        grid: { color: '#e2e8f0', lineWidth: 1 }
                                    }
                                }
                            }
                        });
                    }
                    
                    // Chart 3: Overall Status (Doughnut)
                    const statusCtx = document.getElementById('overallStatusChart');
                    if (statusCtx) {
                        if (statusCtx.chart) statusCtx.chart.destroy();
                        const scheduled = filteredElements.filter(e => !e.castingDate).length;
                        const stockyard = filteredElements.filter(e => e.castingDate && !e.deliveryDate).length;
                        const delivered = filteredElements.filter(e => e.deliveryDate).length;
                        
                        statusCtx.chart = new Chart(statusCtx, {
                            type: 'doughnut',
                            plugins: [ChartDataLabels],
                            data: {
                                labels: ['Delivered', 'In Stockyard', 'Scheduled'],
                                datasets: [{
                                    data: [delivered, stockyard, scheduled],
                                    backgroundColor: ['#10b981', '#3b82f6', '#f59e0b'],
                                    borderWidth: 3,
                                    borderColor: '#fff',
                                    hoverBorderWidth: 4,
                                    hoverBorderColor: '#fff'
                                }]
                            },
                            options: {
                                devicePixelRatio: 4,
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: { 
                                        position: 'bottom', 
                                        labels: { 
                                            font: { size: 12, weight: 'bold' }, 
                                            padding: 12,
                                            usePointStyle: true,
                                            pointStyle: 'circle',
                                            boxWidth: 10,
                                            boxHeight: 10
                                        } 
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                                return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                                            }
                                        }
                                    },
                                    datalabels: {
                                        color: '#fff',
                                        font: { size: 14, weight: 'bold' },
                                        formatter: function(value, context) {
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return value + '\n(' + percentage + '%)';
                                        },
                                        textAlign: 'center',
                                        textStrokeColor: 'rgba(0,0,0,0.2)',
                                        textStrokeWidth: 0.5
                                    }
                                }
                            }
                        });
                    }
                    
                    // Chart 4: Production Status Overview (Bar Chart)
                    const projVolCtx = document.getElementById('projectVolumeChart');
                    if (projVolCtx) {
                        if (projVolCtx.chart) projVolCtx.chart.destroy();
                        
                        const totalElements = filteredElements.length;
                        const produced = filteredElements.filter(e => e.castingDate).length;
                        const delivered = filteredElements.filter(e => e.deliveryDate).length;
                        const inStock = filteredElements.filter(e => e.castingDate && !e.deliveryDate).length;
                        
                        projVolCtx.chart = new Chart(projVolCtx, {
                            type: 'bar',
                            plugins: [ChartDataLabels],
                            data: {
                                labels: ['Total Elements', 'Produced', 'Delivered', 'In Stock'],
                                datasets: [{
                                    label: 'Quantity',
                                    data: [totalElements, produced, delivered, inStock],
                                    backgroundColor: ['#475569', '#0891b2', '#059669', '#84cc16'],
                                    borderWidth: 0
                                }]
                            },
                            options: {
                                devicePixelRatio: 4,
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return context.label + ': ' + context.parsed.y;
                                            }
                                        }
                                    },
                                    datalabels: {
                                        color: '#fff',
                                        font: { size: 15, weight: 'bold' },
                                        anchor: 'center',
                                        align: 'center',
                                        formatter: function(value) {
                                            return value;
                                        }
                                    }
                                },
                                scales: {
                                    x: { 
                                        ticks: { font: { size: 11, weight: 'bold' } },
                                        grid: { display: false }
                                    },
                                    y: { 
                                        beginAtZero: true, 
                                        ticks: { font: { size: 11, weight: '500' } },
                                        grid: { color: '#e2e8f0', lineWidth: 1 }
                                    }
                                }
                            }
                        });
                    }
                    
                    // Chart 5: Monthly Comparison (Bar Chart)
                    const monthlyCtx = document.getElementById('monthlyComparisonChart');
                    if (monthlyCtx) {
                        if (monthlyCtx.chart) monthlyCtx.chart.destroy();
                        
                        // Get current year or year from date range
                        const currentYear = new Date().getFullYear();
                        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        
                        // Initialize monthly data
                        const monthlyCast = new Array(12).fill(0);
                        const monthlyDelivered = new Array(12).fill(0);
                        
                        // Aggregate data by month
                        filteredElements.forEach(el => {
                            if (el.castingDate) {
                                const castDate = new Date(el.castingDate);
                                if (castDate.getFullYear() === currentYear) {
                                    monthlyCast[castDate.getMonth()]++;
                                }
                            }
                            if (el.deliveryDate) {
                                const delivDate = new Date(el.deliveryDate);
                                if (delivDate.getFullYear() === currentYear) {
                                    monthlyDelivered[delivDate.getMonth()]++;
                                }
                            }
                        });
                        
                        monthlyCtx.chart = new Chart(monthlyCtx, {
                            type: 'bar',
                            plugins: [ChartDataLabels],
                            data: {
                                labels: months,
                                datasets: [
                                    {
                                        label: 'Casted',
                                        data: monthlyCast,
                                        backgroundColor: '#8b5cf6',
                                        borderRadius: 6
                                    },
                                    {
                                        label: 'Delivered',
                                        data: monthlyDelivered,
                                        backgroundColor: '#10b981',
                                        borderRadius: 6
                                    }
                                ]
                            },
                            options: {
                                devicePixelRatio: 4,
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: { 
                                        position: 'top', 
                                        labels: { 
                                            font: { size: 13, weight: 'bold' },
                                            padding: 10,
                                            usePointStyle: true,
                                            boxWidth: 12,
                                            boxHeight: 12
                                        } 
                                    },
                                    datalabels: {
                                        display: function(context) {
                                            return context.dataset.data[context.dataIndex] > 0;
                                        },
                                        color: '#fff',
                                        font: { size: 11, weight: 'bold' },
                                        anchor: 'center',
                                        align: 'center',
                                        formatter: function(value) {
                                            return value;
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: `Year: ${currentYear}`,
                                        font: { size: 12, weight: '600' },
                                        color: '#475569',
                                        padding: { bottom: 10 }
                                    }
                                },
                                scales: {
                                    x: { 
                                        ticks: { font: { size: 11, weight: 'bold' } },
                                        grid: { display: false }
                                    },
                                    y: { 
                                        beginAtZero: true, 
                                        ticks: { font: { size: 10 } },
                                        grid: { color: '#f1f5f9' }
                                    }
                                }
                            }
                        });
                    }
                    
                    // Chart 6: Stock Distribution by Type (Horizontal Bar Chart)
                    const stockDistCtx = document.getElementById('stockDistributionChart');
                    if (stockDistCtx) {
                        if (stockDistCtx.chart) stockDistCtx.chart.destroy();
                        
                        // Get stockyard elements grouped by type
                        const stockByType = {};
                        filteredElements.filter(e => e.castingDate && !e.deliveryDate).forEach(el => {
                            const type = (el.type || 'Unknown').trim();
                            if (!stockByType[type]) {
                                stockByType[type] = { count: 0, volume: 0 };
                            }
                            stockByType[type].count++;
                            stockByType[type].volume += parseFloat(el.volume || 0);
                        });
                        
                        const sortedStock = Object.entries(stockByType)
                            .sort((a, b) => b[1].count - a[1].count)
                            .slice(0, 10); // Top 10 types
                        
                        const stockLabels = sortedStock.map(([type]) => type);
                        const stockCounts = sortedStock.map(([, data]) => data.count);
                        const stockVolumes = sortedStock.map(([, data]) => data.volume);
                        
                        stockDistCtx.chart = new Chart(stockDistCtx, {
                            type: 'bar',
                            plugins: [ChartDataLabels],
                            data: {
                                labels: stockLabels,
                                datasets: [
                                    {
                                        label: 'Count',
                                        data: stockCounts,
                                        backgroundColor: '#3b82f6',
                                        borderRadius: 4,
                                        yAxisID: 'y'
                                    },
                                    {
                                        label: 'Volume (m³)',
                                        data: stockVolumes,
                                        backgroundColor: '#f59e0b',
                                        borderRadius: 4,
                                        yAxisID: 'y1'
                                    }
                                ]
                            },
                            options: {
                                indexAxis: 'y',
                                devicePixelRatio: 4,
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: { 
                                        position: 'top', 
                                        labels: { 
                                            font: { size: 12, weight: 'bold' },
                                            padding: 10,
                                            usePointStyle: true,
                                            boxWidth: 12,
                                            boxHeight: 12
                                        } 
                                    },
                                    datalabels: {
                                        display: function(context) {
                                            return context.dataset.data[context.dataIndex] > 0;
                                        },
                                        color: '#fff',
                                        font: { size: 10, weight: 'bold' },
                                        anchor: 'center',
                                        align: 'center',
                                        formatter: function(value, context) {
                                            if (context.datasetIndex === 0) {
                                                return value;
                                            } else {
                                                return value.toFixed(1);
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        type: 'category',
                                        position: 'left',
                                        ticks: { font: { size: 10, weight: '600' } },
                                        grid: { display: false }
                                    },
                                    y1: {
                                        type: 'linear',
                                        display: false,
                                        position: 'right'
                                    },
                                    x: { 
                                        beginAtZero: true, 
                                        ticks: { font: { size: 10 } },
                                        grid: { color: '#e2e8f0' }
                                    }
                                }
                            }
                        });
                    }
                }, 150);
            }, [showKPIGraphs, elements, proj, start, end]);

            return (
                <div className="bg-white rounded-xl border border-slate-200 min-h-screen fade-in print-container print:border-0 print:rounded-none">
                    <div className="p-4 border-b bg-slate-50 no-print flex gap-4 items-end flex-wrap">
                        <div><label className="block text-[10px] font-bold uppercase text-slate-500">Report Type</label><select onChange={e=>setType(e.target.value)} value={type} className="p-2 border rounded text-sm font-bold text-slate-700 w-40 bg-white text-slate-900"><option value="production">Production</option><option value="delivery">Delivery</option><option value="stockreport">Yard Stock Report</option><option value="weeklyplan">Production Plan</option><option value="projectdetail">Project Detail</option></select></div>
                        {type !== 'weeklyplan' && type !== 'projectdetail' && type !== 'stockreport' && (<><div><label className="block text-[10px] font-bold uppercase text-slate-500">View mode</label><select onChange={e=>setmode(e.target.value)} value={mode} className="p-2 border rounded text-sm font-bold text-slate-700 w-32 bg-white text-slate-900"><option value="summary">Summary</option><option value="daily">Daily Stats</option><option value="detailed">Detailed List</option></select></div>
                        <div><label className="block text-[10px] font-bold uppercase text-slate-500">Search</label><div className="relative"><Icon name="search" className="absolute left-3 top-2.5 text-slate-400" size={14}/><input type="text" placeholder="Villa, Cluster, ID..." value={search} onChange={e=>setSearch(e.target.value)} className="pl-9 p-2 border rounded text-sm w-48 bg-white text-slate-900 font-bold"/></div></div>
                        <div><label className="block text-[10px] font-bold uppercase text-slate-500">From</label><input type="date" value={start} onChange={e=>setStart(e.target.value)} className="p-2 border rounded text-sm bg-white text-slate-900 font-bold"/></div>
                        <div><label className="block text-[10px] font-bold uppercase text-slate-500">To</label><input type="date" value={end} onChange={e=>setEnd(e.target.value)} className="p-2 border rounded text-sm bg-white text-slate-900 font-bold"/></div></>)}
                        {type === 'projectdetail' && (<><div><label className="block text-[10px] font-bold uppercase text-slate-500">From</label><input type="date" value={start} onChange={e=>setStart(e.target.value)} className="p-2 border rounded text-sm bg-white text-slate-900 font-bold"/></div>
                        <div><label className="block text-[10px] font-bold uppercase text-slate-500">To</label><input type="date" value={end} onChange={e=>setEnd(e.target.value)} className="p-2 border rounded text-sm bg-white text-slate-900 font-bold"/></div></>)}
                        {type === 'weeklyplan' && (<><div><label className="block text-[10px] font-bold uppercase text-slate-500">From</label><input type="date" value={weeklyPlanStart} onChange={e=>setWeeklyPlanStart(e.target.value)} className="p-2 border rounded text-sm bg-white text-slate-900 font-bold"/></div>
                        <div><label className="block text-[10px] font-bold uppercase text-slate-500">To</label><input type="date" value={weeklyPlanEnd} onChange={e=>setWeeklyPlanEnd(e.target.value)} className="p-2 border rounded text-sm bg-white text-slate-900 font-bold"/></div></>)}
                        <div><label className="block text-[10px] font-bold uppercase text-slate-500">Project</label><select onChange={e=>type === 'weeklyplan' ? setWeeklyPlanProj(e.target.value) : setProj(e.target.value)} value={type === 'weeklyplan' ? weeklyPlanProj : proj} className="p-2 border rounded text-sm w-48 bg-white text-slate-900 font-bold"><option value="">{type === 'projectdetail' ? 'Select Project' : 'All Projects'}</option>{projects.map(p=><option key={p.id} value={p.projectId}>{p.projectId} - {p.name}{p.archived ? ' (Archived)' : ''}</option>)}</select></div>
                        <button onClick={() => setShowKPIGraphs(true)} className="bg-purple-600 text-white px-4 py-2 rounded text-sm font-bold flex gap-2 items-center hover:bg-purple-700 transition"><Icon name="chartLine"/> KPIs Graph</button>
                        <div className="ml-auto flex gap-2">
                            <button onClick={handleExport} className="bg-green-600 text-white px-4 py-2 rounded text-sm font-bold flex gap-2 items-center hover:bg-green-700 transition"><Icon name="fileExcel"/> Export</button>
                            <button onClick={() => downloadPDF('report-content', `Report_${type}_${new Date().toISOString().split('T')[0]}.pdf`)} className="bg-red-600 text-white px-4 py-2 rounded text-sm font-bold flex gap-2 items-center hover:bg-red-700 transition"><Icon name="fileText"/> PDF</button>
                            <button onClick={()=>window.print()} className="bg-slate-800 text-white px-4 py-2 rounded text-sm font-bold flex gap-2 items-center hover:bg-slate-900 transition"><Icon name="print"/> Print</button>
                        </div>
                    </div>
                    <div id="report-content" className="p-8 print:p-0 print:m-0 text-black">
                        {type === 'projectdetail' && proj && projectDetail ? (
                            <>
                                <div className="text-center mb-6 weekly-report-header">
                                    <h1 className="text-xl font-bold uppercase tracking-wide text-slate-900">Naran Precast Concrete Company LLC.</h1>
                                    <h2 className="text-lg font-medium text-slate-700 mt-1">Project Detail Report</h2>
                                    <p className="text-xs text-slate-500 mt-1">
                                        Project: {projects.find(p => p.projectId === proj)?.name} (#{proj}) • Period: {formatDate(start)} to {formatDate(end)}
                                    </p>
                                </div>

                                {/* KPI Cards */}
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                    <div className="p-4 bg-blue-50 border border-blue-200 rounded">
                                        <div className="text-sm font-bold text-slate-700">Total Elements</div>
                                        <div className="text-2xl font-extrabold text-blue-700">{projectDetail.total}</div>
                                        <div className="text-xs text-slate-600 mt-1">Vol: {projectDetail.totalVol.toFixed(3)} m³</div>
                                    </div>
                                    <div className="p-4 bg-purple-50 border border-purple-200 rounded">
                                        <div className="text-sm font-bold text-slate-700">Scheduled</div>
                                        <div className="text-2xl font-extrabold text-purple-700">{projectDetail.scheduledEls.length}</div>
                                        <div className="text-xs text-slate-600 mt-1">Vol: {projectDetail.scheduledVol.toFixed(3)} m³</div>
                                    </div>
                                    <div className="p-4 bg-emerald-50 border border-emerald-200 rounded">
                                        <div className="text-sm font-bold text-slate-700">Produced</div>
                                        <div className="text-2xl font-extrabold text-emerald-700">{projectDetail.castedEls.length}</div>
                                        <div className="text-xs text-slate-600 mt-1">Vol: {projectDetail.castVol.toFixed(3)} m³</div>
                                    </div>
                                    <div className="p-4 bg-indigo-50 border border-indigo-200 rounded">
                                        <div className="text-sm font-bold text-slate-700">Delivered</div>
                                        <div className="text-2xl font-extrabold text-indigo-700">{projectDetail.deliveredEls.length}</div>
                                        <div className="text-xs text-slate-600 mt-1">Vol: {projectDetail.delVol.toFixed(3)} m³</div>
                                    </div>
                                </div>

                                {/* Type Breakdown */}
                                <div className="mb-6">
                                    <h3 className="font-bold text-slate-800 mb-3 text-lg">Type Breakdown</h3>
                                    <div className="border border-slate-300 responsive-table">
                                        <table className="w-full table-min-640 text-sm border-collapse">
                                            <thead>
                                                <tr className="bg-[#005a8d] text-white">
                                                    <th className="p-2 border-r border-white/20 text-left">Type</th>
                                                    <th className="p-2 border-r border-white/20 text-center w-24">Count</th>
                                                    <th className="p-2 text-right w-32">Total Vol (m³)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {projectDetail.typeBreakdown.length === 0 ? (
                                                    <tr><td colSpan="3" className="p-6 text-center text-gray-400">No elements</td></tr>
                                                ) : (
                                                    projectDetail.typeBreakdown.map(([t, agg]) => (
                                                        <tr key={t} className="border-b border-slate-200 hover:bg-slate-50">
                                                            <td className="p-2 border-r border-slate-200">{t}</td>
                                                            <td className="p-2 border-r border-slate-200 text-center font-bold">{agg.count}</td>
                                                            <td className="p-2 text-right font-mono">{agg.volume.toFixed(3)}</td>
                                                        </tr>
                                                    ))
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                {/* Four Sections */}
                                <div className="space-y-8">
                                    {/* 1. Scheduled */}
                                    <div>
                                        <h3 className="font-bold text-slate-800 mb-2 text-lg flex items-center gap-2">
                                            <span className="bg-purple-100 text-purple-700 px-2 py-1 rounded text-sm">Scheduled ({projectDetail.scheduledEls.length})</span>
                                            <span className="text-sm font-normal text-slate-500">Not Cast Yet</span>
                                        </h3>
                                        <div className="responsive-table">
                                            <table className="w-full table-min-800 text-xs border-collapse border border-slate-300 weekly-report-table">
                                                <thead className="bg-slate-100">
                                                    <tr>
                                                        <th className="p-2 border">Element ID</th>
                                                        <th className="p-2 border">Cluster</th>
                                                        <th className="p-2 border">Villa</th>
                                                        <th className="p-2 border">Type</th>
                                                        <th className="p-2 border text-center">Dimensions</th>
                                                        <th className="p-2 border text-right">Vol (m³)</th>
                                                        <th className="p-2 border">Remarks</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {projectDetail.scheduledEls.length === 0 ? (
                                                        <tr><td colSpan="7" className="p-4 text-center text-slate-400 italic">No scheduled items</td></tr>
                                                    ) : projectDetail.scheduledEls.map(e => (
                                                        <tr key={e.id} className="hover:bg-blue-50">
                                                            <td className="p-2 border font-bold">{e.elementId}</td>
                                                            <td className="p-2 border">{e.cluster || '-'}</td>
                                                            <td className="p-2 border">{e.villa || '-'}</td>
                                                            <td className="p-2 border">{e.type}</td>
                                                            <td className="p-2 border text-center font-mono">{cleanDim(e.length)} x {cleanDim(e.widthHeight)}</td>
                                                            <td className="p-2 border text-right">{parseFloat(e.volume || 0).toFixed(3)}</td>
                                                            <td className="p-2 border text-xs italic text-slate-600">{e.notes || '-'}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    {/* 2. Stockyard */}
                                    <div>
                                        <h3 className="font-bold text-slate-800 mb-2 text-lg flex items-center gap-2">
                                            <span className="bg-amber-100 text-amber-700 px-2 py-1 rounded text-sm">Stockyard ({projectDetail.stockyardEls.length})</span>
                                            <span className="text-sm font-normal text-slate-500">Cast, Not Delivered</span>
                                        </h3>
                                        <div className="responsive-table">
                                            <table className="w-full table-min-800 text-xs border-collapse border border-slate-300 weekly-report-table">
                                                <thead className="bg-slate-100">
                                                    <tr>
                                                        <th className="p-2 border">Element ID</th>
                                                        <th className="p-2 border">Cast Date</th>
                                                        <th className="p-2 border">Type</th>
                                                        <th className="p-2 border text-right">Vol (m³)</th>
                                                        <th className="p-2 border">Remarks</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {projectDetail.stockyardEls.length === 0 ? (
                                                        <tr><td colSpan="5" className="p-4 text-center text-slate-400 italic">No stockyard items</td></tr>
                                                    ) : projectDetail.stockyardEls.map(e => (
                                                        <tr key={e.id} className="hover:bg-blue-50">
                                                            <td className="p-2 border font-bold">{e.elementId}</td>
                                                            <td className="p-2 border font-mono">{e.castingDate ? formatDate(e.castingDate) : '-'}</td>
                                                            <td className="p-2 border">{e.type}</td>
                                                            <td className="p-2 border text-right">{parseFloat(e.volume || 0).toFixed(3)}</td>
                                                            <td className="p-2 border text-xs italic text-slate-600">{e.notes || '-'}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    {/* 3. Produced (in date range) */}
                                    <div>
                                        <h3 className="font-bold text-slate-800 mb-2 text-lg flex items-center gap-2">
                                            <span className="bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-sm">Produced ({projectDetail.castInRange.length})</span>
                                            <span className="text-sm font-normal text-slate-500">Cast in Period: {formatDate(start)} - {formatDate(end)}</span>
                                        </h3>
                                        <div className="responsive-table">
                                            <table className="w-full table-min-800 text-xs border-collapse border border-slate-300 weekly-report-table">
                                                <thead className="bg-slate-100">
                                                    <tr>
                                                        <th className="p-2 border">Element ID</th>
                                                        <th className="p-2 border">Cast Date</th>
                                                        <th className="p-2 border">Type</th>
                                                        <th className="p-2 border text-right">Vol (m³)</th>
                                                        <th className="p-2 border">Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {projectDetail.castInRange.length === 0 ? (
                                                        <tr><td colSpan="5" className="p-4 text-center text-slate-400 italic">No production in this date range</td></tr>
                                                    ) : projectDetail.castInRange.map(e => (
                                                        <tr key={e.id} className="hover:bg-blue-50">
                                                            <td className="p-2 border font-bold">{e.elementId}</td>
                                                            <td className="p-2 border font-mono">{formatDate(e.castingDate)}</td>
                                                            <td className="p-2 border">{e.type}</td>
                                                            <td className="p-2 border text-right">{parseFloat(e.volume || 0).toFixed(3)}</td>
                                                            <td className="p-2 border">{e.status}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    {/* 4. Delivered (in date range) */}
                                    <div>
                                        <h3 className="font-bold text-slate-800 mb-2 text-lg flex items-center gap-2">
                                            <span className="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-sm">Delivered ({projectDetail.delInRange.length})</span>
                                            <span className="text-sm font-normal text-slate-500">Delivered in Period: {formatDate(start)} - {formatDate(end)}</span>
                                        </h3>
                                        <div className="responsive-table">
                                            <table className="w-full table-min-800 text-xs border-collapse border border-slate-300 weekly-report-table">
                                                <thead className="bg-slate-100">
                                                    <tr>
                                                        <th className="p-2 border">Element ID</th>
                                                        <th className="p-2 border">Delivery Date</th>
                                                        <th className="p-2 border">DN #</th>
                                                        <th className="p-2 border">Type</th>
                                                        <th className="p-2 border text-right">Vol (m³)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {projectDetail.delInRange.length === 0 ? (
                                                        <tr><td colSpan="5" className="p-4 text-center text-slate-400 italic">No deliveries in this date range</td></tr>
                                                    ) : projectDetail.delInRange.map(e => (
                                                        <tr key={e.id} className="hover:bg-blue-50">
                                                            <td className="p-2 border font-bold">{e.elementId}</td>
                                                            <td className="p-2 border font-mono">{formatDate(e.deliveryDate)}</td>
                                                            <td className="p-2 border font-mono">{dnByElementId[e.elementId] || '-'}</td>
                                                            <td className="p-2 border">{e.type}</td>
                                                            <td className="p-2 border text-right">{parseFloat(e.volume || 0).toFixed(3)}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <div className="page-number">Page </div>
                            </>
                        ) : type === 'stockreport' ? (
                            <>
                                {/* Stock Report Header */}
                                <div className="text-center mb-6 weekly-report-header">
                                    <h1 className="text-xl font-bold uppercase tracking-wide text-slate-900">Naran Precast Concrete Company LLC.</h1>
                                    <h2 className="text-lg font-medium text-slate-700 mt-1">Stock Report - Elements in Stockyard</h2>
                                    <p className="text-xs text-slate-500 mt-1">
                                        {proj ? `Project: ${projects.find(p => p.projectId === proj)?.name || proj} (#{proj})` : 'All Projects'} • 
                                        Generated: {new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })}
                                    </p>
                                </div>

                                {/* Stock Report Table */}
                                <div className="mb-6">
                                    <h3 className="font-bold text-slate-800 mb-3 text-lg print:text-sm print:mb-2">Stock by Project & Type</h3>
                                    <div className="border border-slate-300 responsive-table">
                                        <table className="w-full table-min-640 text-sm border-collapse print:text-xs">
                                            <thead>
                                                <tr className="bg-[#005a8d] text-white">
                                                    <th className="p-3 border border-slate-300 text-center print:p-1.5">Project #</th>
                                                    <th className="p-3 border border-slate-300 text-center print:p-1.5">Project Name</th>
                                                    <th className="p-3 border border-slate-300 text-center print:p-1.5">Type</th>
                                                    <th className="p-3 border border-slate-300 text-center w-24 print:p-1.5">Count</th>
                                                    <th className="p-3 border border-slate-300 text-center w-32 print:p-1.5">Volume (m³)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {stockReportData.length === 0 ? (
                                                    <tr><td colSpan="5" className="p-8 text-center text-gray-400 italic border border-slate-300">No elements in stockyard</td></tr>
                                                ) : (
                                                    stockReportData.map((projectGroup, projIdx) => (
                                                        <React.Fragment key={projIdx}>
                                                            {projectGroup.types.map((typeData, typeIdx) => (
                                                                <tr key={`${projIdx}-${typeIdx}`} className="hover:bg-slate-50">
                                                                    {typeIdx === 0 ? (
                                                                        <>
                                                                            <td rowSpan={projectGroup.types.length} className="p-3 border border-slate-300 text-center font-mono font-bold align-middle bg-slate-50 print:p-1.5">{projectGroup.projectNumber}</td>
                                                                            <td rowSpan={projectGroup.types.length} className="p-3 border border-slate-300 text-center align-middle bg-slate-50 print:p-1.5">{projectGroup.projectName}</td>
                                                                        </>
                                                                    ) : null}
                                                                    <td className="p-3 border border-slate-300 text-center print:p-1.5">{typeData.type}</td>
                                                                    <td className="p-3 border border-slate-300 text-center font-bold print:p-1.5">{typeData.count}</td>
                                                                    <td className="p-3 border border-slate-300 text-right font-mono print:p-1.5">{typeData.volume.toFixed(2)}</td>
                                                                </tr>
                                                            ))}
                                                        </React.Fragment>
                                                    ))
                                                )}
                                            </tbody>
                                            <tfoot>
                                                <tr className="font-bold bg-white border-t-2 border-slate-400">
                                                    <td colSpan="3" className="p-3 border border-slate-300 text-right pr-4 text-slate-800 print:p-1.5">Total:</td>
                                                    <td className="p-3 border border-slate-300 text-center print:p-1.5">{stockReportTotals.count}</td>
                                                    <td className="p-3 border border-slate-300 text-right print:p-1.5">{stockReportTotals.volume.toFixed(0)}</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>

                                <div className="page-number">Page </div>
                            </>
                        ) : type === 'weeklyplan' ? (
                            <>
                                <div className="text-center mb-6 weekly-report-header"><h1 className="text-xl font-bold uppercase tracking-wide text-slate-900">Naran Precast Concrete Company LLC.</h1><h2 className="text-lg font-medium text-slate-700 mt-1">{weeklyPlanStart === weeklyPlanEnd ? 'Production Plan' : 'Weekly Production Plan'}</h2><p className="text-xs text-slate-500 mt-1">{weeklyPlanStart === weeklyPlanEnd ? formatDate(weeklyPlanStart) : `${formatDate(weeklyPlanStart)} to ${formatDate(weeklyPlanEnd)}`} | Project: {weeklyPlanProj ? projects.find(p => p.projectId === weeklyPlanProj)?.name : 'All Projects'}</p></div>
                                <div className="mb-6 p-4 bg-emerald-50 border border-emerald-200 rounded text-slate-800 text-sm print:bg-transparent print:border-none print:p-0 print:mb-2"><Icon name="calendar" className="mr-2 no-print"/>Total Planned: <b>{weeklyPlanData.length} elements</b> | Total Volume: <b>{weeklyPlanData.reduce((a,c)=>a+parseFloat(c.volume||0),0).toFixed(2)} m³</b></div>
                                {Object.keys(weeklyGroupedByProject).length === 0 ? (
                                    <div className="p-8 text-center text-slate-400 bg-slate-50 rounded-lg border border-dashed">
                                        <Icon name="calendar" size={48} className="mb-4 text-slate-300"/>
                                        <p className="font-medium">No elements planned for the selected date range</p>
                                    </div>
                                ) : (
                                    Object.keys(weeklyGroupedByProject).sort().map(projKey => {
                                        const projectGroup = weeklyGroupedByProject[projKey];
                                        const projectElements = Object.values(projectGroup.dates).flat();
                                        const projectVolume = projectElements.reduce((a,c)=>a+parseFloat(c.volume||0),0);
                                        
                                        return (
                                            <div key={projKey} className="mb-8 break-inside-avoid weekly-project-section">
                                                <div className="p-4 bg-blue-600 text-white rounded-t-lg font-bold flex items-center project-header">
                                                    <span className="text-lg">Project #{projectGroup.projectNumber} - {projectGroup.projectName}</span>
                                                </div>
                                                {(() => {
                                                    const allItemsForProject = Object.values(projectGroup.dates).flat();
                                                    
                                                    const groupedItems = [];
                                                    const processed = new Set();
                                                    const typicalGroups = {};
                                                    
                                                    allItemsForProject.forEach(el => {
                                                        if (el.isTypical && el.typicalQty > 1) {
                                                            const basePattern = el.elementId.replace(/[-_]\d+$/, '').replace(/\d+$/, '');
                                                            const groupKey = `${basePattern}_${el.type}_${el.cluster}_${el.length}_${el.widthHeight}_${el.typicalQty}`;
                                                            if (!typicalGroups[groupKey]) {
                                                                typicalGroups[groupKey] = { elements: [], basePattern: basePattern, representative: el };
                                                            }
                                                            typicalGroups[groupKey].elements.push(el);
                                                        }
                                                    });
                                                    
                                                    allItemsForProject.forEach(el => {
                                                        if (processed.has(el.id)) return;
                                                        
                                                        if (el.isTypical && el.typicalQty > 1) {
                                                            const basePattern = el.elementId.replace(/[-_]\d+$/, '').replace(/\d+$/, '');
                                                            const groupKey = `${basePattern}_${el.type}_${el.cluster}_${el.length}_${el.widthHeight}_${el.typicalQty}`;
                                                            const group = typicalGroups[groupKey];
                                                            
                                                            if (group && group.elements[0].id === el.id) {
                                                                const actualCount = group.elements.length;
                                                                groupedItems.push({
                                                                    ...el,
                                                                    elementId: basePattern || el.elementId,
                                                                    displayQty: actualCount,
                                                                    totalVolume: parseFloat(el.volume || 0) * actualCount,
                                                                    villa: group.elements.length > 1 ? 'Multiple' : el.villa
                                                                });
                                                                group.elements.forEach(e => processed.add(e.id));
                                                            }
                                                        } else {
                                                            groupedItems.push({
                                                                ...el,
                                                                displayQty: 1,
                                                                totalVolume: parseFloat(el.volume || 0)
                                                            });
                                                            processed.add(el.id);
                                                        }
                                                    });
                                                    
                                                    groupedItems.sort((a, b) => {
                                                        const typeCompare = String(a.type || '').localeCompare(String(b.type || ''));
                                                        if (typeCompare !== 0) return typeCompare;
                                                        return String(a.elementId || '').localeCompare(String(b.elementId || ''));
                                                    });

                                                    return (
                                                        <div className="border-l-4 border-r border-b border-slate-200">
                                                            <table className="w-full text-xs border-collapse weekly-report-table">
                                                                <thead className="bg-slate-100">
                                                                    <tr>
                                                                        <th className="border p-2 text-left">Element ID</th>
                                                                        <th className="border p-2 text-center w-16">Qty</th>
                                                                        <th className="border p-2 text-left">Cluster</th>
                                                                        <th className="border p-2 text-left">Villa</th>
                                                                        <th className="border p-2 text-left w-24">Type</th>
                                                                        <th className="border p-2 text-center">Dimensions</th>
                                                                        <th className="border p-2 text-right">Volume (m³)</th>
                                                                        <th className="border p-2 text-left">Remarks</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {groupedItems.map((el, idx) => (
                                                                        <tr key={idx} className={`hover:bg-blue-50 ${el.displayQty > 1 ? 'bg-yellow-50' : ''}`}>
                                                                            <td className="border p-2 font-bold text-slate-800">{el.elementId}</td>
                                                                            <td className="border p-2 text-center font-bold text-blue-600">{el.displayQty ? `${el.displayQty} nos` : '-'}</td>
                                                                            <td className="border p-2">{el.cluster || '-'}</td>
                                                                            <td className="border p-2">{el.villa || '-'}</td>
                                                                            <td className="border p-2 whitespace-nowrap">{el.type}</td>
                                                                            <td className="border p-2 text-center font-mono">{cleanDim(el.length)} x {cleanDim(el.widthHeight)}</td>
                                                                            <td className="border p-2 text-right font-bold">{el.totalVolume.toFixed(3)}</td>
                                                                            <td className="border p-2 text-xs italic text-slate-600 relative group">
                                                                                {editingRemark?.id === el.id ? (
                                                                                    <input 
                                                                                        className="w-full p-1 border border-blue-400 rounded text-xs outline-none bg-white text-slate-900"
                                                                                        value={editingRemark.text}
                                                                                        onChange={e => setEditingRemark({ ...editingRemark, text: e.target.value })}
                                                                                        onBlur={saveRemark}
                                                                                        onKeyDown={e => e.key === 'Enter' && saveRemark()}
                                                                                        autoFocus
                                                                                    />
                                                                                ) : (
                                                                                    <>
                                                                                        {el.notes || '-'}
                                                                                        {(userRole === 'admin' || userRole === 'editor') && (
                                                                                            <button 
                                                                                                onClick={() => setEditingRemark({ id: el.id, text: el.notes || '' })}
                                                                                                className="absolute right-1 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 text-slate-400 hover:text-blue-600 transition-opacity no-print p-1"
                                                                                                title="Edit Remark"
                                                                                            >
                                                                                                <Icon name="pencil" size={10}/>
                                                                                            </button>
                                                                                        )}
                                                                                    </>
                                                                                )}
                                                                            </td>
                                                                        </tr>
                                                                    ))}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    );
                                                })()}
                                            </div>
                                        );
                                    })
                                )}
                                <div className="page-number">Page </div>
                            </>
                        ) : (
                            <>
                                <div className="text-center mb-6"><h1 className="text-xl font-bold uppercase tracking-wide text-slate-900">Naran Precast Concrete Company LLC.</h1><h2 className="text-lg font-medium text-slate-700 mt-1">{type.charAt(0).toUpperCase() + type.slice(1)} {mode === 'summary' ? 'Summary' : ''} Report</h2><p className="text-xs text-slate-500 mt-1">Period: {formatDate(start)} to {formatDate(end)}</p></div>
                                {mode === 'summary' && ( <div className="border border-slate-300 responsive-table"><table className="w-full table-min-640 text-sm border-collapse"><thead><tr className="bg-[#005a8d] text-white"><th className="p-2 border-r border-white/20 text-center w-24">ProjectNo</th><th className="p-2 border-r border-white/20 text-center">ProjectName</th><th className="p-2 border-r border-white/20 text-center">Type</th><th className="p-2 border-r border-white/20 text-center w-24">Count</th><th className="p-2 text-center w-32">Total Vol</th></tr></thead><tbody>{summaryData.length === 0 ? (<tr><td colSpan="5" className="p-8 text-center italic text-gray-400">No data found for this period.</td></tr>) : (summaryData.map((row, i) => (<tr key={i} className="border-b border-slate-200 hover:bg-slate-50"><td className="p-2 border-r border-slate-200 text-center font-mono">{row.projectNo}</td><td className="p-2 border-r border-slate-200 text-center">{row.projectName}</td><td className="p-2 border-r border-slate-200 text-center">{row.type}</td><td className="p-2 border-r border-slate-200 text-center font-bold">{row.count}</td><td className="p-2 text-center font-mono">{row.volume.toFixed(3)}</td></tr>)))}</tbody><tfoot><tr className="font-bold bg-white border-t-2 border-slate-300"><td colSpan="3" className="p-2 text-right pr-4 text-slate-800">Total:</td><td className="p-2 text-center border-l border-slate-200">{totalCount}</td><td className="p-2 text-center border-l border-slate-200">{totalVol.toFixed(3)}</td></tr></tfoot></table></div> )}
                                {mode === 'daily' && ( <div className="border border-slate-300 responsive-table"><table className="w-full table-min-640 text-sm border-collapse"><thead><tr className="bg-[#005a8d] text-white"><th className="p-2 border-r border-white/20 text-left">Date</th><th className="p-2 border-r border-white/20 text-left">Project</th><th className="p-2 border-r border-white/20 text-center w-32">Count</th><th className="p-2 text-right w-32">Volume (m³)</th></tr></thead><tbody>{dailyData.length === 0 ? (<tr><td colSpan="4" className="p-8 text-center italic text-gray-400">No data found for this period.</td></tr>) : (dailyData.map((row, i) => (<tr key={i} className="border-b border-slate-200 hover:bg-slate-50"><td className="p-2 border-r border-slate-200 font-bold text-slate-700">{formatDate(row.date)}</td><td className="p-2 border-r border-slate-200 text-xs">{row.projectName} (#{row.projectNumber})</td><td className="p-2 border-r border-slate-200 text-center">{row.count}</td><td className="p-2 text-right font-mono">{row.volume.toFixed(3)}</td></tr>)))}</tbody><tfoot><tr className="font-bold bg-white border-t-2 border-slate-300"><td colSpan="2" className="p-2 text-right pr-4 text-slate-800">Total:</td><td className="p-2 text-center border-l border-slate-200">{dailyData.reduce((a,b)=>a+b.count,0)}</td><td className="p-2 text-right border-l border-slate-200">{dailyData.reduce((a,b)=>a+b.volume,0).toFixed(3)}</td></tr></tfoot></table></div> )}
                                {mode === 'detailed' && ( <div className="responsive-table"><table className="w-full table-min-800 text-xs border-collapse border border-slate-300"><thead><tr className="bg-gray-100 border-b-2 border-black"><th className="p-2 text-left border-r">Date</th><th className="p-2 text-left border-r">Project</th><th className="p-2 text-left border-r">Element ID</th><th className="p-2 text-left border-r">Cluster</th><th className="p-2 text-left border-r">Villa</th><th className="p-2 text-left border-r">Type</th><th className="p-2 text-center border-r">Dimensions</th><th className="p-2 text-right">Vol (m³)</th></tr></thead><tbody>{filteredData.length === 0 ? (<tr><td colSpan="8" className="p-8 text-center italic text-gray-400">No records found.</td></tr>) : (filteredData.map((el, i) => (<tr key={el.id} className={`border-b border-slate-200 ${i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}><td className="p-2 border-r">{formatDate(type === 'production' ? el.castingDate : el.deliveryDate)}</td><td className="p-2 border-r">{el.projectName}</td><td className="p-2 border-r font-bold">{el.elementId}</td><td className="p-2 border-r text-xs">{el.cluster || '-'}</td><td className="p-2 border-r text-xs">{el.villa || '-'}</td><td className="p-2 border-r">{el.type}</td><td className="p-2 border-r text-center">{cleanDim(el.length)}x{cleanDim(el.widthHeight)}</td><td className="p-2 text-right">{parseFloat(el.volume || 0).toFixed(3)}</td></tr>)))}</tbody><tfoot><tr className="font-bold bg-gray-100 border-t-2 border-black"><td colSpan="7" className="p-2 text-right">TOTAL VOL:</td><td className="p-2 text-right">{filteredData.reduce((a, b) => a + parseFloat(b.volume || 0), 0).toFixed(3)}</td></tr></tfoot></table></div> )}
                            </>
                        )}
                    </div>
                    
                    {/* KPI Graphs Modal */}
                    {showKPIGraphs && (
                        <div className="fixed inset-0 bg-black/60 z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-7xl overflow-hidden flex flex-col max-h-[95vh] kpi-dashboard-print">
                                <div className="p-4 bg-gradient-to-r from-purple-600 to-blue-600 text-white flex justify-between items-center no-print">
                                    <div>
                                        <h3 className="font-bold text-lg flex items-center gap-2"><Icon name="chartLine"/> KPIs & Analytics Dashboard</h3>
                                        <p className="text-xs mt-1 opacity-90">
                                            {proj ? `Project: ${projects.find(p => p.projectId === proj)?.name || proj}` : 'All Projects'} • 
                                            Period: {formatDate(start)} to {formatDate(end)}
                                        </p>
                                    </div>
                                    <button onClick={() => setShowKPIGraphs(false)} className="hover:bg-white/20 p-2 rounded transition"><Icon name="x"/></button>
                                </div>
                                <div className="flex-1 overflow-auto p-6 bg-gradient-to-br from-slate-50 to-slate-100">{(() => {
                                    const filteredEls = proj ? elements.filter(e => String(e.projectNumber) === String(proj)) : elements;
                                    return (
                                        <>
                                            {/* Print Header - Only visible when printing */}
                                            <div className="kpi-print-header" style={{ display: 'none' }}>
                                                <h1>KPIs & Analytics Dashboard - Naran Precast</h1>
                                                <p>
                                                    {proj ? `Project: ${projects.find(p => p.projectId === proj)?.name || proj}` : 'All Projects'} | 
                                                    Period: {formatDate(start)} to {formatDate(end)} | 
                                                    Generated: {new Date().toLocaleDateString('en-GB')}
                                                </p>
                                            </div>
                                            
                                            {/* Summary Stats Cards */}
                                            <div className="stat-cards grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                                <div className="bg-gradient-to-br from-blue-500 to-blue-600 p-5 rounded-xl text-white shadow-lg transform hover:scale-105 transition-transform">
                                                    <div className="flex items-center justify-between mb-2">
                                                        <div className="text-xs font-bold opacity-90 uppercase tracking-wide">Total Elements</div>
                                                        <Icon name="cube" size={20} className="opacity-75"/>
                                                    </div>
                                                    <div className="text-4xl font-extrabold mb-1">{filteredEls.length}</div>
                                                    <div className="text-xs opacity-75">Overall Count</div>
                                                </div>
                                                <div className="bg-gradient-to-br from-purple-500 to-purple-600 p-5 rounded-xl text-white shadow-lg transform hover:scale-105 transition-transform">
                                                    <div className="flex items-center justify-between mb-2">
                                                        <div className="text-xs font-bold opacity-90 uppercase tracking-wide">Casted</div>
                                                        <Icon name="hammer" size={20} className="opacity-75"/>
                                                    </div>
                                                    <div className="text-4xl font-extrabold mb-1">{filteredEls.filter(e => e.castingDate).length}</div>
                                                    <div className="text-xs opacity-75">{((filteredEls.filter(e => e.castingDate).length / filteredEls.length) * 100).toFixed(1)}% Completed</div>
                                                </div>
                                                <div className="bg-gradient-to-br from-emerald-500 to-emerald-600 p-5 rounded-xl text-white shadow-lg transform hover:scale-105 transition-transform">
                                                    <div className="flex items-center justify-between mb-2">
                                                        <div className="text-xs font-bold opacity-90 uppercase tracking-wide">Delivered</div>
                                                        <Icon name="truck" size={20} className="opacity-75"/>
                                                    </div>
                                                    <div className="text-4xl font-extrabold mb-1">{filteredEls.filter(e => e.deliveryDate).length}</div>
                                                    <div className="text-xs opacity-75">{((filteredEls.filter(e => e.deliveryDate).length / filteredEls.length) * 100).toFixed(1)}% Shipped</div>
                                                </div>
                                                <div className="bg-gradient-to-br from-orange-500 to-orange-600 p-5 rounded-xl text-white shadow-lg transform hover:scale-105 transition-transform">
                                                    <div className="flex items-center justify-between mb-2">
                                                        <div className="text-xs font-bold opacity-90 uppercase tracking-wide">In Stock</div>
                                                        <Icon name="box" size={20} className="opacity-75"/>
                                                    </div>
                                                    <div className="text-4xl font-extrabold mb-1">{filteredEls.filter(e => e.castingDate && !e.deliveryDate).length}</div>
                                                    <div className="text-xs opacity-75">Ready to Ship</div>
                                                </div>
                                            </div>
                                            
                                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 chart-grid">
                                                {/* Chart 1: Production vs Delivery Trend (Line Chart) */}
                                                <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-md hover:shadow-lg transition-shadow chart-container">
                                                    <h4 className="text-sm font-bold text-slate-800 mb-3 flex items-center gap-2 border-b pb-2">
                                                        <Icon name="trendingUp" size={16} className="text-purple-600"/>
                                                        Production vs Delivery Trend
                                                    </h4>
                                                    <canvas id="productionTrendChart" style={{ maxHeight: '280px' }}></canvas>
                                                </div>
                                                
                                                {/* Chart 2: Weekly Production Activity (Bar Chart) */}
                                                <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-md hover:shadow-lg transition-shadow chart-container">
                                                    <h4 className="text-sm font-bold text-slate-800 mb-3 flex items-center gap-2 border-b pb-2">
                                                        <Icon name="chartBar" size={16} className="text-blue-600"/>
                                                        Daily Production Activity
                                                    </h4>
                                                    <canvas id="weeklyActivityChart" style={{ maxHeight: '280px' }}></canvas>
                                                </div>
                                                
                                                {/* Chart 3: Project Status Distribution (Doughnut) */}
                                                <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-md hover:shadow-lg transition-shadow chart-container">
                                                    <h4 className="text-sm font-bold text-slate-800 mb-3 flex items-center gap-2 border-b pb-2">
                                                        <Icon name="pieChart" size={16} className="text-emerald-600"/>
                                                        Status Distribution
                                                    </h4>
                                                    <canvas id="overallStatusChart" style={{ maxHeight: '280px' }}></canvas>
                                                </div>
                                                
                                                {/* Chart 4: Production Status Overview */}
                                                <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-md hover:shadow-lg transition-shadow chart-container">
                                                    <h4 className="text-sm font-bold text-slate-800 mb-3 flex items-center gap-2 border-b pb-2">
                                                        <Icon name="chartBar" size={16} className="text-cyan-600"/>
                                                        Production Status Overview
                                                    </h4>
                                                    <canvas id="projectVolumeChart" style={{ maxHeight: '280px' }}></canvas>
                                                </div>
                                                
                                                {/* Chart 5: Monthly Comparison (Bar Chart) */}
                                                <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-md hover:shadow-lg transition-shadow chart-container lg:col-span-2">
                                                    <h4 className="text-sm font-bold text-slate-800 mb-3 flex items-center gap-2 border-b pb-2">
                                                        <Icon name="calendar" size={16} className="text-indigo-600"/>
                                                        Monthly Production Comparison (Jan - Dec)
                                                    </h4>
                                                    <canvas id="monthlyComparisonChart" style={{ maxHeight: '300px' }}></canvas>
                                                </div>
                                                
                                                {/* Chart 6: Stock Distribution by Type (Horizontal Bar Chart) */}
                                                <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-md hover:shadow-lg transition-shadow chart-container lg:col-span-2">
                                                    <h4 className="text-sm font-bold text-slate-800 mb-3 flex items-center gap-2 border-b pb-2">
                                                        <Icon name="box" size={16} className="text-orange-600"/>
                                                        Stock Distribution by Element Type (Top 10)
                                                    </h4>
                                                    <canvas id="stockDistributionChart" style={{ maxHeight: '300px' }}></canvas>
                                                </div>
                                            </div>
                                        </>
                                    );
                                })()}
                                </div>
                                <div className="p-4 border-t bg-white flex justify-between items-center no-print">
                                    <div className="text-xs text-slate-600 italic">
                                        <Icon name="info" size={12} className="inline mr-1"/>
                                        Charts update automatically based on your project and date range selection
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => window.print()} className="bg-slate-700 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-slate-800 transition shadow-md"><Icon name="print"/> Print</button>
                                        <button onClick={() => setShowKPIGraphs(false)} className="bg-slate-200 text-slate-700 px-4 py-2 rounded-lg font-bold hover:bg-slate-300 transition">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        const LogsView = ({ user, userRole }) => {

            const isAdminLocal = (userRole === 'admin');
            const [logs, setLogs] = useState([]);
            const [recycle, setRecycle] = useState([]);
            const [archivedProjects, setArchivedProjects] = useState([]);
            const [logTab, setLogTab] = useState('activity');
            const [backupFreq, setBackupFreq] = useState(localStorage.getItem('kesha_backup_freq') || 'off');
            const [lastBackup, setLastBackup] = useState(localStorage.getItem('kesha_last_backup'));
            const [restoreMode, setRestoreMode] = useState('merge'); // 'merge' or 'overwrite'
            const restoreFileRef = useRef(null);

            useEffect(() => {
                const unsub = db.collection('logs').orderBy('timestamp', 'desc').limit(50).onSnapshot(s => setLogs(s.docs.map(d => d.data())));
                return unsub;
            }, []);
            useEffect(() => {
                const unsub = db.collection('recycle').orderBy('deletedAt','desc').onSnapshot(s => setRecycle(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                return unsub;
            }, []);
            useEffect(() => {
                const unsub = db.collection('projects').where('archived', '==', true).onSnapshot(s => setArchivedProjects(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                return unsub;
            }, []);

                    const handleRestoreRecycle = async (item) => {
                if (!isAdminLocal) { alert('Permission denied: only admins can restore deleted items.'); return; }
                if (!confirm(`Restore ${item.originalId || item.id} ?`)) return;
                try {
                    const source = item.recycledFrom || 'elements';
                    const originalId = item.originalId || item.id.replace(/^note_/, '').replace(/^project_/, '');
                    // copy back to original collection
                    // clean metadata fields before restoring
                    const restoreData = Object.fromEntries(Object.entries(item).filter(([k]) => !k.startsWith('__') && k !== 'id' && k !== 'deletedAt' && k !== 'deletedBy'));
                    await db.collection(source).doc(originalId).set(restoreData);
                    // remove from recycle
                    await db.collection('recycle').doc(item.id).delete();
                    // log
                    await db.collection('logs').add({ timestamp: new Date().toISOString(), user: user?.email || 'unknown', action: 'RESTORE', details: `Restored ${originalId} to ${source}` });
                    alert('Restored.');
                } catch(e) { console.error(e); alert('Restore failed: ' + e.message); }
            };

            const handlePermanentlyDeleteRecycle = async (id) => {
                if (!isAdminLocal) { alert('Permission denied: only admins can permanently delete items.'); return; }
                if (!confirm('Permanently delete this item? This cannot be undone.')) return;
                try {
                    await db.collection('recycle').doc(id).delete();
                    await db.collection('logs').add({ timestamp: new Date().toISOString(), user: user?.email || 'unknown', action: 'DELETE_PERmANENT', details: `Permanently deleted recycle id ${id}` });
                    alert('Permanently deleted.');
                } catch(e) { console.error(e); alert('Delete failed: ' + e.message); }
            };

            const handleClearRecycleBin = async () => {
                if (!isAdminLocal) { alert('Permission denied: only admins can clear recycle bin.'); return; }
                if (recycle.length === 0) { alert('Recycle Bin is already empty.'); return; }
                if (!confirm(`⚠️ WARNING\n\nThis will permanently delete ALL ${recycle.length} items from Recycle Bin.\n\nThis action cannot be undone.\n\nAre you sure?`)) return;
                try {
                    const batch = db.batch();
                    recycle.forEach(item => {
                        batch.delete(db.collection('recycle').doc(item.id));
                    });
                    await batch.commit();
                    await db.collection('logs').add({ timestamp: new Date().toISOString(), user: user?.email || 'unknown', action: 'CLEAR_RECYCLE', details: `Cleared ${recycle.length} items from Recycle Bin` });
                    alert(`Successfully deleted ${recycle.length} items.`);
                } catch(e) { console.error(e); alert('Failed to clear recycle bin: ' + e.message); }
            };

            const handleManualBackup = async () => {
                if(!isAdminLocal) return alert("Permission denied: Admins only.");
                const btn = document.getElementById('backup-btn');
                if(btn) { btn.disabled = true; btn.innerText = "Processing..."; }
                try {
                    const { count, failed } = await performBackup();
                    const now = Date.now();
                    localStorage.setItem('kesha_last_backup', now);
                    setLastBackup(now);
                    let msg = `✅ Backup Complete!\n\nSuccessfully exported ${count} records.`;
                    if (failed.length > 0) msg += `\n\n⚠️ Skipped (Permission Denied): ${failed.join(', ')}`;
                    alert(msg);
                } catch(e) { alert("Backup failed: " + e.message); }
                if(btn) { btn.disabled = false; btn.innerText = "Download Full Backup Now"; }
            };

            const handleRestoreSelect = async (e) => {
                if (!isAdminLocal) return;
                const file = e.target.files[0];
                if (!file) return;
                
                // Use the selected restore mode from state
                const isMergeMode = restoreMode === 'merge';
                
                const modeText = isMergeMode ? '🔀 MERGE MODE' : '⚠️ OVERWRITE MODE';
                const modeDesc = isMergeMode ? 
                    'This will ADD new records from the backup file without overwriting existing data.' :
                    'This will OVERWRITE all data in the current database with data from the backup file.';
                const modeSafety = isMergeMode ? 
                    'Existing records will be skipped. Safe for incremental restores.' :
                    'If you are migrating to a new empty database, this is safe.\nIf you are on your live database, this replaces current data.';
                
                if (!confirm(`⚠️ CRITICAL WARNING: ${modeText}\n\n${modeDesc}\n\n${modeSafety}\n\nAre you sure you want to proceed?`)) {
                    e.target.value = null;
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (event) => {
                    // Create progress overlay
                    const overlay = document.createElement('div');
                    overlay.id = 'restore-progress';
                    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999;';
                    
                    const progressBox = document.createElement('div');
                    progressBox.style.cssText = 'background:white;padding:30px;border-radius:10px;min-width:400px;text-align:center;';
                    
                    progressBox.innerHTML = `
                        <h2 style="margin:0 0 20px;font-size:24px;color:#1e293b;">Restoring Data...</h2>
                        <div style="background:#e2e8f0;height:30px;border-radius:15px;overflow:hidden;margin-bottom:15px;">
                            <div id="progress-bar" style="background:linear-gradient(90deg, #3b82f6, #10b981);height:100%;width:0%;transition:width 0.3s;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:14px;"></div>
                        </div>
                        <p id="progress-text" style="margin:0;color:#64748b;font-size:14px;">Preparing...</p>
                        <p id="progress-details" style="margin:10px 0 0;color:#94a3b8;font-size:12px;"></p>
                    `;
                    
                    overlay.appendChild(progressBox);
                    document.body.appendChild(overlay);
                    
                    const progressBar = document.getElementById('progress-bar');
                    const progressText = document.getElementById('progress-text');
                    const progressDetails = document.getElementById('progress-details');
                    
                    try {
                        const json = JSON.parse(event.target.result);
                        
                        // Support both new format {data: {...}} and old format {...}
                        const dataObj = json.data || json;
                        
                        if (!dataObj || typeof dataObj !== 'object') {
                            throw new Error("Invalid backup file format.");
                        }
                        
                        const collections = Object.keys(dataObj);
                        
                        // Calculate total documents
                        let totalDocs = 0;
                        for (const col of collections) {
                            const docs = Array.isArray(dataObj[col]) ? dataObj[col] : Object.values(dataObj[col]);
                            totalDocs += docs.length;
                        }
                        
                        progressText.textContent = `Found ${totalDocs.toLocaleString()} documents in ${collections.length} collections`;
                        
                        let processedDocs = 0;
                        let errors = 0;
                        let skipped = 0;
                        let errorDetails = [];
                        
                        const BATCH_SIZE = 80; // Increased to 80 for faster restore
                        const DELAY_BETWEEN_BATCHES = 100; // 100ms delay between batches
                        
                        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
                        
                        const retryOperation = async (operation, maxRetries = 3) => {
                            for (let attempt = 0; attempt < maxRetries; attempt++) {
                                try {
                                    return await operation();
                                } catch (err) {
                                    if (attempt === maxRetries - 1) throw err;
                                    // If rate limited (429) or server error (5xx), wait longer
                                    if (err.code === 429 || (err.code >= 500 && err.code < 600)) {
                                        await sleep(1000 * (attempt + 1)); // Progressive delay
                                    } else {
                                        throw err; // Don't retry other errors
                                    }
                                }
                            }
                        };
                        
                        for (const col of collections) {
                            const docs = Array.isArray(dataObj[col]) ? dataObj[col] : Object.values(dataObj[col]);
                            
                            progressDetails.textContent = `Processing collection: ${col} (${docs.length} documents)`;
                            
                            // Process in smaller batches with delays
                            for (let i = 0; i < docs.length; i += BATCH_SIZE) {
                                const batch = docs.slice(i, i + BATCH_SIZE);
                                
                                // Process all documents in this batch in parallel with retry logic
                                const promises = batch.map(async (doc) => {
                                    try {
                                        const { _id, id, ...data } = doc;
                                        const docId = _id || id;
                                        
                                        if (!docId) {
                                            console.warn('Skipping document without ID in collection:', col);
                                            return { success: false, reason: 'No ID' };
                                        }
                                        
                                        // **MERGE MODE: Check if record already exists**
                                        if (isMergeMode) {
                                            try {
                                                const existing = await db.collection(col).doc(docId).get();
                                                if (existing.exists) {
                                                    console.log(`[MERGE] Skipping existing: ${col}/${docId}`);
                                                    return { success: true, skipped: true };
                                                }
                                            } catch (e) {
                                                // Continue if check fails
                                            }
                                        }
                                        
                                        // Convert volume to number if present
                                        if (data.volume !== undefined) {
                                            data.volume = data.volume === '' ? 0 : parseFloat(data.volume) || 0;
                                        }
                                        
                                        // Convert archived to boolean if present
                                        if (data.archived !== undefined) {
                                            data.archived = Boolean(data.archived);
                                        }
                                        
                                        // Fix for projects collection - add ProjectNo field
                                        if (col === 'projects' && data.projectId && !data.ProjectNo) {
                                            data.ProjectNo = data.projectId;
                                        }
                                        
                                        // Clean data for Appwrite - preserve types
                                        const cleanData = {};
                                        for (const [key, value] of Object.entries(data)) {
                                            if (value === null || value === undefined) {
                                                cleanData[key] = '';
                                            } else if (typeof value === 'boolean') {
                                                cleanData[key] = value; // Preserve booleans
                                            } else if (typeof value === 'number') {
                                                cleanData[key] = value; // Preserve numbers
                                            } else if (typeof value === 'object' && !Array.isArray(value)) {
                                                cleanData[key] = JSON.stringify(value);
                                            } else if (Array.isArray(value)) {
                                                cleanData[key] = JSON.stringify(value);
                                            } else {
                                                cleanData[key] = value;
                                            }
                                        }
                                        
                                        // Use set() with retry logic
                                        await retryOperation(async () => {
                                            await db.collection(col).doc(docId).set(cleanData);
                                        });
                                        
                                        return { success: true };
                                        
                                    } catch (err) {
                                        const errorMsg = `${col}/${doc._id || doc.id}: ${err.message || err.code}`;
                                        console.error(errorMsg, err);
                                        errorDetails.push(errorMsg);
                                        return { success: false, error: err };
                                    }
                                });
                                
                                // Wait for all documents in this batch to complete
                                const results = await Promise.all(promises);
                                
                                // Count successes and errors
                                results.forEach(result => {
                                    processedDocs++;
                                    if (result.skipped) {
                                        skipped++;
                                    } else if (!result.success) {
                                        errors++;
                                    }
                                });
                                
                                // Update progress
                                const percentage = Math.round((processedDocs / totalDocs) * 100);
                                progressBar.style.width = percentage + '%';
                                progressBar.textContent = percentage + '%';
                                progressText.textContent = `Restoring: ${processedDocs.toLocaleString()} / ${totalDocs.toLocaleString()} documents`;
                                
                                // Delay between batches to avoid rate limits
                                if (i + BATCH_SIZE < docs.length) {
                                    await sleep(DELAY_BETWEEN_BATCHES);
                                }
                            }
                        }
                        
                        // Log first 10 errors for debugging
                        if (errorDetails.length > 0) {
                            console.error('First 10 errors:', errorDetails.slice(0, 10));
                        }
                        
                        // Show completion
                        progressBar.style.width = '100%';
                        progressBar.textContent = '100%';
                        progressText.textContent = '✅ Restore Complete!';
                        progressDetails.textContent = `Successfully restored ${(processedDocs - errors - skipped).toLocaleString()} documents${skipped > 0 ? ` • Skipped ${skipped} existing` : ''}${errors > 0 ? ` • ${errors} errors` : ''}`;
                        
                        setTimeout(() => {
                            document.body.removeChild(overlay);
                            const mode = isMergeMode ? '🔀 MERGE MODE' : '⚠️ OVERWRITE MODE';
                            alert(`✅ Restore Complete! (${mode})\n\nAdded: ${processedDocs - errors - skipped} records\n${skipped > 0 ? `Skipped (existing): ${skipped} records\n` : ''}${errors > 0 ? `\n⚠️ Errors: ${errors} documents (check console)` : ''}\n\nNote: User passwords are not backed up. Users may need to register again, but their roles/profiles are restored.`);
                            window.location.reload();
                        }, 2000);
                        
                    } catch (err) {
                        console.error(err);
                        document.body.removeChild(overlay);
                        alert("Restore Failed: " + err.message);
                    }
                };
                reader.readAsText(file);
                e.target.value = null;
            };

            return (
                <div className="bg-white rounded-xl border border-slate-200 h-full flex flex-col fade-in p-6">
                    <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><Icon name="shield"/> System Activity Log</h2>
                    <div className="flex-1 overflow-auto border rounded-lg p-4">
                        <div className="mb-4">
                            <div className="flex items-center gap-2">
                                <button onClick={() => setLogTab('activity')} className={`px-3 py-1 rounded ${logTab === 'activity' ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-700'}`}>Recent Activity</button>
                                <button onClick={() => setLogTab('recycle')} className={`px-3 py-1 rounded ${logTab === 'recycle' ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-700'}`}>Recycle Bin</button>
                                <button onClick={() => setLogTab('archive')} className={`px-3 py-1 rounded ${logTab === 'archive' ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-700'}`}>Archive</button>
                                <button onClick={() => setLogTab('backup')} className={`px-3 py-1 rounded ${logTab === 'backup' ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-700'}`}>Backup & Restore</button>
                            </div>
                        </div>

                        {logTab === 'activity' && (
                            <div className="mb-6">
                                <h3 className="font-bold text-slate-800 mb-2">Recent Activity</h3>
                                <div className="overflow-auto max-h-[600px] border rounded bg-white">
                                    <table className="w-full table-min-640 text-sm text-left"><thead className="bg-slate-100 sticky top-0"><tr><th className="p-3">Time</th><th className="p-3">User</th><th className="p-3">Action</th><th className="p-3">Details</th></tr></thead><tbody className="divide-y divide-slate-100">{logs.map((log, i) => (<tr key={i} className="hover:bg-slate-50"><td className="p-3 text-xs font-mono text-slate-500">{new Date(log.timestamp).toLocaleString()}</td><td className="p-3 font-bold text-blue-600">{log.user}</td><td className="p-3 font-bold uppercase text-xs"><span className={`px-2 py-1 rounded ${log.action==='DELETE'?'bg-red-100 text-red-700':log.action==='CREATE'?'bg-green-100 text-green-700':'bg-blue-100 text-blue-700'}`}>{log.action}</span></td><td className="p-3 text-slate-600">{log.details}</td></tr>))}</tbody></table>
                                </div>
                            </div>
                        )}

                        {logTab === 'recycle' && (
                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <h3 className="font-bold text-slate-800">Recycle Bin</h3>
                                    <button onClick={handleClearRecycleBin} disabled={recycle.length === 0} className="disabled:opacity-50 disabled:cursor-not-allowed px-3 py-1 bg-red-600 text-white rounded text-xs font-bold hover:bg-red-700 transition flex items-center gap-1"><Icon name="trash" size={12}/> Clear All ({recycle.length})</button>
                                </div>
                                <p className="text-xs text-slate-500 mb-2">Deleted items are kept here so they can be restored or permanently removed.</p>
                                <div className="overflow-auto max-h-56 border rounded bg-white">
                                    <table className="w-full table-min-640 text-sm text-left"><thead className="bg-slate-100 sticky top-0"><tr><th className="p-2 text-slate-700">ID</th><th className="p-2 text-slate-700">Type</th><th className="p-2 text-slate-700">Project / Name</th><th className="p-2 text-slate-700">Deleted At</th><th className="p-2 text-center text-slate-700">Actions</th></tr></thead><tbody className="divide-y divide-slate-100">{recycle.length === 0 ? (<tr><td colSpan="5" className="p-4 text-center text-xs text-gray-400 italic">Recycle Bin is empty.</td></tr>) : (recycle.map((it, i) => (<tr key={it.id}><td className="p-2 font-mono text-xs text-slate-800 break-all">{it.originalId || it.id}</td><td className="p-2 text-xs text-slate-800">{it.recycledFrom || 'unknown'}</td><td className="p-2 text-xs text-slate-800 break-words">{it.projectName || it.elementId || it.name || '-'}</td><td className="p-2 text-xs text-slate-800">{it.deletedAt ? new Date(it.deletedAt).toLocaleString() : '-'}</td><td className="p-2 text-center"><div className="flex items-center justify-center gap-2"><button onClick={() => handleRestoreRecycle(it)} className="btn-secondary text-xs">Restore</button><button onClick={() => handlePermanentlyDeleteRecycle(it.id)} className="px-3 py-1 bg-red-500 text-white rounded text-xs font-bold hover:bg-red-600">Delete</button></div></td></tr>)))}</tbody></table>
                                </div>
                            </div>
                        )}

                        {logTab === 'archive' && (
                            <div>
                                <h3 className="font-bold text-slate-800 mb-2">Archived Projects</h3>
                                <div className="overflow-auto max-h-56 border rounded bg-white">
                                    <table className="w-full table-min-640 text-sm text-left"><thead className="bg-slate-100 sticky top-0"><tr><th className="p-2 text-slate-700">Project Name</th><th className="p-2 text-slate-700">Project #</th><th className="p-2 text-slate-700">Address</th><th className="p-2 text-slate-700">Actions</th></tr></thead><tbody className="divide-y divide-slate-100">{archivedProjects.length === 0 ? (<tr><td colSpan="4" className="p-4 text-center text-xs text-gray-400 italic">No archived projects.</td></tr>) : (archivedProjects.map((p, i) => (<tr key={p.id}><td className="p-2 font-bold text-slate-800">{p.name}</td><td className="p-2 font-mono text-xs text-slate-800">{p.projectId}</td><td className="p-2 text-xs text-slate-800">{p.address || '-'}</td><td className="p-2 text-center"><button onClick={async () => { await db.collection('projects').doc(p.id).update({ archived: false }); }} className="btn-secondary text-xs">Unarchive</button></td></tr>)))}</tbody></table>
                                </div>
                            </div>
                        )}

                        {logTab === 'backup' && (
                            <div className="max-w-2xl">
                                <h3 className="font-bold text-slate-800 mb-4">System Backup & Migration</h3>
                                <div className="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-6">
                                    <div className="flex items-start gap-4">
                                        <div className="bg-blue-100 p-3 rounded-full text-blue-600"><Icon name="save" size={24}/></div>
                                        <div className="flex-1">
                                            <h4 className="font-bold text-lg text-slate-800 mb-1">1. Export Data (Backup)</h4>
                                            <p className="text-sm text-slate-600 mb-4">Export all Projects, Elements, Delivery Notes, Users, and Logs into a single JSON file. Use this to migrate to a new database.</p>
                                            <button id="backup-btn" onClick={handleManualBackup} className="btn-primary"><Icon name="upload" className="rotate-180"/> Download Backup File</button>
                                            {lastBackup && <p className="text-xs text-slate-500 mt-2">Last backup: {new Date(parseInt(lastBackup)).toLocaleString()}</p>}
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-amber-50 border border-amber-200 rounded-xl p-6 mb-6">
                                    <div className="flex items-start gap-4">
                                        <div className="bg-amber-100 p-3 rounded-full text-amber-600"><Icon name="history" size={24}/></div>
                                        <div className="flex-1">
                                            <h4 className="font-bold text-lg text-slate-800 mb-1">2. Import Data (Restore/Migrate)</h4>
                                            <p className="text-sm text-slate-600 mb-3">Upload a backup file to restore data or populate a new database.</p>
                                            <div className="bg-white border border-amber-200 rounded-lg p-4 mb-4">
                                                <div className="text-xs font-bold text-slate-700 mb-3">✨ Choose Restore Mode:</div>
                                                <div className="space-y-2">
                                                    <button onClick={() => setRestoreMode('merge')} className={`w-full text-left flex items-start gap-3 p-3 rounded-lg border-2 transition ${restoreMode === 'merge' ? 'border-green-500 bg-green-50' : 'border-slate-200 bg-white hover:border-green-300'}`}>
                                                        <input type="radio" checked={restoreMode === 'merge'} onChange={() => setRestoreMode('merge')} className="mt-0.5 cursor-pointer"/>
                                                        <div className="flex-1">
                                                            <div className="font-bold text-slate-800 text-sm">🔀 Merge Mode</div>
                                                            <div className="text-xs text-slate-600">Add new records only • Skip existing • Safe for weekly restores</div>
                                                        </div>
                                                    </button>
                                                    <button onClick={() => setRestoreMode('overwrite')} className={`w-full text-left flex items-start gap-3 p-3 rounded-lg border-2 transition ${restoreMode === 'overwrite' ? 'border-red-500 bg-red-50' : 'border-slate-200 bg-white hover:border-red-300'}`}>
                                                        <input type="radio" checked={restoreMode === 'overwrite'} onChange={() => setRestoreMode('overwrite')} className="mt-0.5 cursor-pointer"/>
                                                        <div className="flex-1">
                                                            <div className="font-bold text-slate-800 text-sm">⚠️ Overwrite Mode</div>
                                                            <div className="text-xs text-slate-600">Replace all data • Use only for fresh migrations</div>
                                                        </div>
                                                    </button>
                                                </div>
                                            </div>
                                            <input type="file" ref={restoreFileRef} onChange={handleRestoreSelect} accept=".json" className="hidden" />
                                            <button onClick={() => restoreFileRef.current.click()} className="bg-amber-600 text-white px-4 py-2 rounded font-bold hover:bg-amber-700 flex items-center gap-2 shadow-lg"><Icon name="upload"/> Select Backup File to Restore</button>
                                        </div>
                                    </div>
                                </div>

                                <h3 className="font-bold text-slate-800 mb-4">Automatic Backup Settings</h3>
                                <div className="bg-slate-50 border border-slate-200 rounded-xl p-6">
                                    <div className="flex items-center justify-between mb-2"><label className="font-bold text-slate-700">Auto-Backup Frequency</label><select value={backupFreq} onChange={(e) => { setBackupFreq(e.target.value); localStorage.setItem('kesha_backup_freq', e.target.value); }} className="p-2 border rounded font-bold text-slate-800"><option value="off">Off (Manual only)</option><option value="daily">Daily</option><option value="weekly">Weekly</option></select></div>
                                    <p className="text-xs text-slate-500">If enabled, the system will automatically download a backup file when you log in, if the scheduled time has passed.</p>
                                </div>
                            </div>
                        )}
                </div>
            </div>
        );
        };

        // --- PROJECTS VIEW ---
        const ProjectsView = ({ projects, setIsProjOpen, canEdit, setSummaryProj, setEditingProj, handleArchiveProject, handleDeleteProject, handleDeleteProjectElements, isAdminUser, userProfile }) => {
            const [showArchived, setShowArchived] = useState(false);
            const [elements, setElements] = useState([]);
            const filteredProjects = (showArchived ? projects.filter(p => p.archived) : projects.filter(p => !p.archived))
                .sort((a, b) => {
                    const numA = parseInt(a.projectId) || 0;
                    const numB = parseInt(b.projectId) || 0;
                    return numA - numB;
                });
            const canDeleteProj = isAdminUser() || userProfile?.permissions?.canDeleteProjects;
            const canDeleteElem = isAdminUser() || userProfile?.permissions?.canDeleteElements;
            const canArchive = isAdminUser() || userProfile?.permissions?.canArchiveProjects;

            // Load all elements for project statistics (minimal data only)
            useEffect(() => {
                const unsub = db.collection('elements').limit(5000)
                    .onSnapshot(s => {
                        console.log('Elements snapshot for ProjectsView:', s.docs.length, 'elements');
                        const activeProjectNums = projects.filter(p => !p.archived).map(p => String(p.projectId));
                        console.log('Active project numbers:', activeProjectNums);
                        const filtered = s.docs.map(d => {
                            const data = d.data();
                            return {
                                id: d.id,
                                projectNumber: data.projectNumber,
                                castingDate: data.castingDate,
                                deliveryDate: data.deliveryDate
                            };
                        }).filter(el => activeProjectNums.includes(String(el.projectNumber)));
                        setElements(filtered);
                    });
                return () => unsub();
            }, [projects]);

            return (
                <div className="space-y-6 fade-in">
                    <div className="flex justify-between items-center bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <div className="flex items-center gap-4">
                            <h2 className="font-bold text-lg text-blue-700">{showArchived ? 'Archived Projects' : 'Active Projects'}</h2>
                            <button onClick={() => setShowArchived(!showArchived)} className="text-sm px-3 py-1 rounded border border-slate-300 hover:bg-slate-50 font-medium text-slate-600">{showArchived ? 'Show Active' : 'Show Archived'}</button>
                        </div>
                        <button onClick={() => setIsProjOpen(true)} disabled={!canEdit()} className="disabled:opacity-50 disabled:cursor-not-allowed btn-primary flex items-center gap-2"><Icon name="plus"/> Add Project</button>
                    </div>
                    {filteredProjects.length === 0 ? (
                        <div className="flex flex-col items-center justify-center py-20 text-slate-400">
                            <Icon name="archive" size={64} className="mb-4 opacity-50"/>
                            <p className="text-lg font-bold text-slate-500">No {showArchived ? 'archived' : 'active'} projects yet</p>
                            <p className="text-sm mt-2">{showArchived ? 'Archive completed projects to keep your workspace organized.' : 'Click "Add Project" to get started.'}</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {filteredProjects.map(p => {
                                const projElements = elements.filter(e => String(e.projectNumber) === String(p.projectId));
                                const count = projElements.length;
                                const casted = projElements.filter(e => e.castingDate).length;
                                const delivered = projElements.filter(e => e.deliveryDate).length;
                                const castPct = count > 0 ? Math.round((casted / count) * 100) : 0;
                                const delPct = count > 0 ? Math.round((delivered / count) * 100) : 0;
                                return (
                                    <div key={p.id} className={`bg-white p-6 rounded-xl border shadow-sm hover:shadow-md transition relative flex flex-col justify-between h-auto min-h-[220px] ${p.archived ? 'border-slate-300 opacity-75' : 'border-slate-200'}`}>
                                        {p.archived && <div className="absolute top-2 left-2 bg-slate-500 text-white text-xs px-2 py-0.5 rounded font-bold">ARCHIVED</div>}
                                        <div className="flex justify-between items-start">
                                            <div><h3 className="font-bold text-lg text-slate-800 line-clamp-2">{p.name}</h3><p className="text-slate-500 text-sm mt-1">#{p.projectId}</p></div>
                                            <div className="flex gap-2">
                                                <button onClick={() => setSummaryProj(p)} className="bg-emerald-50 text-emerald-600 p-2 rounded-lg hover:bg-emerald-100 transition" title="View Summary"><Icon name="list" size={16}/></button>
                                                <button onClick={() => setEditingProj(p)} disabled={!canEdit()} className="disabled:opacity-50 disabled:cursor-not-allowed bg-blue-50 text-blue-600 p-2 rounded-lg hover:bg-blue-100 transition"><Icon name="pencil" size={16}/></button>
                                                <button onClick={(e) => { e.stopPropagation(); handleArchiveProject(p.id, !p.archived); }} disabled={!canArchive} className={`p-2 rounded-lg transition disabled:opacity-30 disabled:cursor-not-allowed ${p.archived ? 'bg-amber-50 text-amber-600 hover:bg-amber-100' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`} title={p.archived ? 'Unarchive' : 'Archive'}><Icon name={p.archived ? 'archive' : 'archive'} size={16}/></button>
                                                <div className="bg-slate-100 text-slate-500 p-2 rounded-lg"><Icon name="building" size={20} /></div>
                                            </div>
                                        </div>
                                        {p.address && <p className="text-xs text-slate-400 mt-2 line-clamp-2"><Icon name="truck" size={10} className="mr-1"/>{p.address}</p>}
                                        <div className="mt-3 space-y-2">
                                            <div className="flex items-center justify-between text-xs">
                                                <span className="text-slate-600 font-medium">Casted:</span>
                                                <span className="font-bold text-blue-700">{casted}/{count} ({castPct}%)</span>
                                            </div>
                                            <div className="w-full bg-slate-200 rounded-full h-1.5">
                                                <div className="bg-blue-600 h-1.5 rounded-full transition-all" style={{width: `${castPct}%`}}></div>
                                            </div>
                                            <div className="flex items-center justify-between text-xs">
                                                <span className="text-slate-600 font-medium">Delivered:</span>
                                                <span className="font-bold text-emerald-700">{delivered}/{count} ({delPct}%)</span>
                                            </div>
                                            <div className="w-full bg-slate-200 rounded-full h-1.5">
                                                <div className="bg-emerald-600 h-1.5 rounded-full transition-all" style={{width: `${delPct}%`}}></div>
                                            </div>
                                        </div>
                                        <div className="flex justify-between items-end mt-4">
                                            <span className="text-sm text-slate-600 font-medium">Total Elements: <span className="font-bold text-slate-900">{count}</span></span>
                                            <div className="flex gap-2">
                                                <button onClick={(e) => { e.stopPropagation(); handleDeleteProjectElements(p.id); }} disabled={!canDeleteElem || count === 0} className="disabled:opacity-30 disabled:cursor-not-allowed text-orange-400 hover:text-orange-600 transition" title="Delete all elements"><Icon name="trash" size={16} /></button>
                                                <button onClick={(e) => { e.stopPropagation(); handleDeleteProject(p.id); }} disabled={!canDeleteProj} className="disabled:opacity-50 disabled:cursor-not-allowed text-red-300 hover:text-red-500 transition" title="Delete project & elements"><Icon name="trash" size={16} /></button>
                                            </div>
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                    )}
                </div>
            );
        };

        // --- USER mANAGEmENT (ADmIN) ---
        const UsersView = ({ userRole }) => {
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [fetchError, setFetchError] = useState(null);
            const [newUid, setNewUid] = useState('');
            const [newEmail, setNewEmail] = useState('');
            const [newName, setNewName] = useState('');
            const [newRole, setNewRole] = useState('editor');
            const [permModal, setPermModal] = useState(null);
            const [refreshKey, setRefreshKey] = useState(0);

            useEffect(() => {
                if (userRole !== 'admin') { setUsers([]); setLoading(false); return; }
                setLoading(true);
                const unsub = db.collection('users').onSnapshot(s => {
                    const list = s.docs.map(d => ({ id: d.id, ...d.data() }));
                    list.sort((a, b) => (a.email || '').toLowerCase().localeCompare((b.email || '').toLowerCase()));
                    setUsers(list); 
                    setLoading(false);
                    setFetchError(null);
                }, err => { 
                    console.error('users fetch err', err); 
                    setFetchError(err.message);
                    setLoading(false); 
                });
                return () => unsub();
            }, [userRole, refreshKey]);

            const changeRole = async (uid, role) => {
                if (userRole !== 'admin') { alert('Only admins can change roles.'); return; }
                try { 
                    await db.collection('users').doc(uid).set({ role }, { merge: true }); 
                    alert('✅ Role updated successfully!');
                }
                catch(e) { console.error(e); alert('Failed to change role: ' + e.message); }
            };

            const toggleDisabled = async (uid, disabled) => {
                if (userRole !== 'admin') { alert('Only admins can disable/enable users.'); return; }
                try {
                    await db.collection('users').doc(uid).set({ disabled }, { merge: true });
                    alert(`✅ User ${disabled ? 'disabled' : 'enabled'} successfully!`);
                } catch(e) { console.error(e); alert('Failed to update status: ' + e.message); }
            };

            const saveProfile = async () => {
                if (userRole !== 'admin') { alert('Only admins can create profiles.'); return; }
                const uid = newUid.trim();
                if (!uid) return alert('UID required. See Firebase Authentication console for user UID.');
                try {
                    await db.collection('users').doc(uid).set({ name: newName || newEmail, email: newEmail, role: newRole, createdAt: new Date().toISOString() });
                    setNewUid(''); setNewEmail(''); setNewName(''); setNewRole('viewer');
                    alert('User profile created (FireStore). Note: Authentication user must already exist, or invite them separately.');
                } catch(e) { console.error(e); alert('Failed to create profile: ' + e.message); }
            };

            const createInvite = async () => {
                if (userRole !== 'admin') { alert('Only admins can invite.'); return; }
                if (!newEmail) return alert('Enter an email to invite.');
                try {
                    // Create an invitations doc   server or admin will pick up and send an email/invite flow
                    await db.collection('invitations').add({ email: newEmail, role: newRole, name: newName || '', invitedAt: new Date().toISOString() });
                    alert('Invite request saved   please send the sign-in information via your normal channels.');
                } catch(e) { console.error(e); alert('Failed to create invite: ' + e.message); }
            };

            const deleteProfile = async (uid) => {
                if (userRole !== 'admin') { alert('Only admins can delete profiles.'); return; }
                if (!confirm('Delete user profile ' + uid + ' ?')) return;
                try { await db.collection('users').doc(uid).delete(); alert('Deleted profile doc (user in Authentication not affected).'); }
                catch(e) { console.error(e); alert('Delete failed: ' + e.message); }
            };

            const savePermissions = async () => {
                if(!permModal) return;
                try {
                    await db.collection('users').doc(permModal.uid).set({ permissions: permModal.permissions }, { merge: true });
                    setPermModal(null);
                    alert('Permissions updated.');
                } catch(e) { console.error(e); alert(e.message); }
            };
            const togglePerm = (key) => {
                setPermModal(prev => ({
                    ...prev,
                    permissions: { ...prev.permissions, [key]: !prev.permissions?.[key] }
                }));
            };

            return (
                <div className="bg-white rounded-xl border border-slate-200 h-full p-6 fade-in flex flex-col">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-lg font-bold text-slate-800">User management – Admin</h2>
                        <button onClick={() => setRefreshKey(k => k + 1)} className="text-xs text-blue-600 hover:underline flex items-center gap-1"><Icon name="history"/> Refresh List</button>
                    </div>
                    <div className="p-4 border rounded-lg mb-4 bg-slate-50">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <input placeholder="Firebase UID (required to link auth user)" value={newUid} onChange={e=>setNewUid(e.target.value)} className="p-2 border rounded" />
                            <input placeholder="Email (for invite)" value={newEmail} onChange={e=>setNewEmail(e.target.value)} className="p-2 border rounded" />
                            <input placeholder="Name" value={newName} onChange={e=>setNewName(e.target.value)} className="p-2 border rounded" />
                            <select value={newRole} onChange={e=>setNewRole(e.target.value)} className="p-2 border rounded w-full md:w-48"><option value="viewer">viewer</option><option value="editor">editor</option><option value="admin">admin</option></select>
                            <div className="flex gap-2"><button onClick={saveProfile} className="btn-primary"><Icon name="plus"/> Add User</button><button onClick={createInvite} className="btn-secondary">Create Invitation</button></div>
                            <div className="text-xs text-slate-400 italic">Tip: UID is visible under Firebase Console ? Authentication ? click user ? UID. Creating an 'invitation' does not create an auth user; it's an app-level invite record your IT or server can consume.</div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-auto border rounded p-3 bg-white">
                        {fetchError && (
                            <div className="p-4 mb-4 text-sm text-red-700 bg-red-100 rounded border border-red-200">
                                <div className="font-bold flex items-center gap-2"><Icon name="shield"/> Firestore Permission Error</div>
                                <p className="mt-1">Your database rules are blocking the user list. To fix this, go to <b>Firebase Console &gt; Firestore Database &gt; Rules</b> and paste these <b>Secure Rules</b>:</p>
                                <pre className="mt-3 bg-slate-800 text-green-400 p-3 rounded font-mono text-xs overflow-x-auto select-all">
{`rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function role() { return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role; }
    function isStaff() { return request.auth != null && (role() == 'admin' || role() == 'editor'); }
    function isAuth() { return request.auth != null; }

    match /users/{u} { allow read: if isAuth(); allow write: if role() == 'admin'; }
    match /projects/{p} { allow read: if isAuth(); allow write: if isStaff(); }
    match /elements/{e} { allow read: if isAuth(); allow write: if isStaff(); }
    match /delivery_notes/{d} { allow read: if isAuth(); allow write: if isStaff(); }
    match /recycle/{r} { allow read: if isAuth(); allow write: if isStaff(); }
    match /logs/{l} { allow read: if isAuth(); allow create: if isAuth(); allow update, delete: if role() == 'admin'; }
    match /invitations/{i} { allow read, write: if role() == 'admin'; }
  }
}`}
                                </pre>
                                <p className="mt-2 text-xs text-emerald-600">Note: These rules are secure. They enforce the 'Admin' and 'Editor' roles you set in this app.</p>
                            </div>
                        )}
                        {loading ? (<div className="text-center p-8 text-slate-400">Loading users...</div>) : (
                            users.length === 0 ? (<div className="text-center text-xs text-slate-400 italic p-8">No user profiles found.</div>) : (
                                <table className="w-full text-sm text-left table-min-640"><thead><tr className="bg-slate-100 text-xs"><th className="p-2 text-slate-700">UID</th><th className="p-2 text-slate-700">Email</th><th className="p-2 text-slate-700">Name</th><th className="p-2 text-slate-700">Role</th><th className="p-2 text-slate-700">Disabled</th><th className="p-2 text-center text-slate-700">Actions</th></tr></thead><tbody className="divide-y divide-slate-100">{users.map(u => (<tr key={u.id}><td className="p-2 font-mono text-xs text-slate-800 break-all">{u.id}</td><td className="p-2 text-xs text-slate-800 break-words">{u.email || '-'}</td><td className="p-2 text-xs font-bold text-slate-900">{u.name || '-'}</td><td className="p-2"><select value={u.role || 'viewer'} onChange={e => changeRole(u.id, e.target.value)} className="p-1 border rounded text-sm font-bold text-slate-700"><option value="viewer">viewer</option><option value="editor">editor</option><option value="admin">admin</option></select></td><td className="p-2 text-xs"><input type="checkbox" checked={!!u.disabled} onChange={e => toggleDisabled(u.id, e.target.checked)} className="w-4 h-4 accent-red-600 cursor-pointer" /></td><td className="p-2 text-center"><div className="flex items-center justify-center gap-2"><button onClick={() => setPermModal({ uid: u.id, name: u.name, permissions: u.permissions || {} })} className="px-3 py-1 bg-purple-100 text-purple-700 rounded text-xs font-bold hover:bg-purple-200">Permissions</button><button onClick={() => deleteProfile(u.id)} className="px-3 py-1 bg-red-500 text-white rounded text-xs">Delete</button></div></td></tr>))}</tbody></table>
                            ) ) }
                    </div>
                    {permModal && (
                        <div className="fixed inset-0 bg-black/60 z-[90] flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
                                <h3 className="font-bold text-lg mb-4">Permissions: {permModal.name}</h3>
                                <div className="space-y-3 mb-6">
                                    <label className="flex items-center gap-3 p-2 border rounded hover:bg-slate-50 cursor-pointer"><input type="checkbox" checked={!!permModal.permissions.canDeleteElements} onChange={() => togglePerm('canDeleteElements')} className="w-5 h-5 accent-blue-600"/> <span className="text-sm font-bold text-slate-700">Can Delete Elements</span></label>
                                    <label className="flex items-center gap-3 p-2 border rounded hover:bg-slate-50 cursor-pointer"><input type="checkbox" checked={!!permModal.permissions.canDeleteProjects} onChange={() => togglePerm('canDeleteProjects')} className="w-5 h-5 accent-blue-600"/> <span className="text-sm font-bold text-slate-700">Can Delete Projects</span></label>
                                    <label className="flex items-center gap-3 p-2 border rounded hover:bg-slate-50 cursor-pointer"><input type="checkbox" checked={!!permModal.permissions.canArchiveProjects} onChange={() => togglePerm('canArchiveProjects')} className="w-5 h-5 accent-blue-600"/> <span className="text-sm font-bold text-slate-700">Can Archive Projects</span></label>
                                    <label className="flex items-center gap-3 p-2 border rounded hover:bg-slate-50 cursor-pointer"><input type="checkbox" checked={!!permModal.permissions.canEditElements} onChange={() => togglePerm('canEditElements')} className="w-5 h-5 accent-blue-600"/> <span className="text-sm font-bold text-slate-700">Can Edit Elements</span></label>
                                    <label className="flex items-center gap-3 p-2 border rounded hover:bg-slate-50 cursor-pointer"><input type="checkbox" checked={!!permModal.permissions.canCreateDN} onChange={() => togglePerm('canCreateDN')} className="w-5 h-5 accent-blue-600"/> <span className="text-sm font-bold text-slate-700">Can Create Delivery Notes</span></label>
                                </div>
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setPermModal(null)} className="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded">Cancel</button>
                                    <button onClick={savePermissions} className="btn-primary">Save Permissions</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==================================================================================
        // 6. mAIN APPLICATION LOGIC
        // ==================================================================================
        const App = () => {
            const [user, setUser] = useState(null);
            const [showWelcome, setShowWelcome] = useState(true);
            const [authLoading, setAuthLoading] = useState(true); 
            const [userRole, setUserRole] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [view, setView] = useState('projects'); 
            const [projects, setProjects] = useState([]);
            const [notes, setNotes] = useState([]);
            
            const [dnmodal, setDnmodal] = useState(false);
            const [histmodal, setHistmodal] = useState(false);
            const [printDN, setPrintDN] = useState(null);
            const [dnPopupOpen, setDnPopupOpen] = useState(false);
            const [isImportOpen, setIsImportOpen] = useState(false);
            const [isPasteImportOpen, setIsPasteImportOpen] = useState(false); 
            const [isAddOpen, setIsAddOpen] = useState(false);
            const [isBatchAddOpen, setIsBatchAddOpen] = useState(false);
            const [isProjOpen, setIsProjOpen] = useState(false);
            const [editingProj, setEditingProj] = useState(null); 
            const [summaryProj, setSummaryProj] = useState(null);
            const [summaryElements, setSummaryElements] = useState([]);

            const [dnProj, setDnProj] = useState('');
            const [dnItems, setDnItems] = useState([]);
            const [dnAddr, setDnAddr] = useState('');
            const [dnContact, setDnContact] = useState('');
            const [dnDriver, setDnDriver] = useState('');
            const [dnVehicle, setDnVehicle] = useState('');
            const [dnTransport, setDnTransport] = useState('');
            const [dnSearch, setDnSearch] = useState(''); 
            const [dnmetaSearch, setDnmetaSearch] = useState('');
            
            // Production Control tab/filter state persistence
            const [savedControlTab, setSavedControlTab] = useState('casting');
            const [savedControlProjFilter, setSavedControlProjFilter] = useState('');
 
            const [histSearch, setHistSearch] = useState('');
            const [histProjFilter, setHistProjFilter] = useState('');
            const [histDateFrom, setHistDateFrom] = useState('');
            const [histDateTo, setHistDateTo] = useState('');
            const [dnDate, setDnDate] = useState(new Date().toISOString().split('T')[0]);
            const [stockyardElements, setStockyardElements] = useState([]);
            const [ismobilemenuOpen, setIsmobilemenuOpen] = useState(false);
            const [bulkTypicalMode, setBulkTypicalMode] = useState(false);
            const [bulkTypicalBase, setBulkTypicalBase] = useState(null);
            const [bulkTypicalQty, setBulkTypicalQty] = useState(1);
            const [groupDnItems, setGroupDnItems] = useState(false);
            const [dnShowCluster, setDnShowCluster] = useState(false);
            const [dnShowVilla, setDnShowVilla] = useState(false);
            const [dnShowWeight, setDnShowWeight] = useState(true);

            // Delivery History: Track selected notes for batch print
            const [selectedNotes, setSelectedNotes] = useState([]);
            const [bulkPrintNotes, setBulkPrintNotes] = useState(null);
            
            const [addRows, setAddRows] = useState([{ id: '', cluster: '', villa: '', type: '', len: '', wh: '', vol: '', qty: 1 }]);
            const [batchProj, setBatchProj] = useState('');
            const lastActivityRef = useRef(Date.now());
            const [editDN, setEditDN] = useState(null);
            const [histSelected, setHistSelected] = useState([]);
            const [returnToHistory, setReturnToHistory] = useState(false);

            const filteredNotes = useMemo(() => {
                return notes.filter(n => {
                    const s = (histSearch || '').toLowerCase().trim();
                    let match = true;
                    if (s) {
                        const dnmatch = (n.dnNumber || '').toLowerCase().includes(s);
                        const itemmatch = (n.items || []).some(i => String(i.elementId || '').toLowerCase().includes(s));
                        match = match && (dnmatch || itemmatch);
                    }
                    if (histProjFilter && String(n.project) !== String(histProjFilter)) match = false;
                    if (histDateFrom && n.date < histDateFrom) match = false;
                    if (histDateTo && n.date > histDateTo) match = false;
                    return match;
                });
            }, [notes, histSearch, histProjFilter, histDateFrom, histDateTo]);

            const handleSelectAll = (e) => { setHistSelected(e.target.checked ? filteredNotes.map(n => n.id) : []); };

            // --- IDLE TIMEOUT AUTO-LOGOUT (30 minutes) ---
            useEffect(() => {
                let timer;
                const resetTimer = () => {
                    if (timer) clearTimeout(timer);
                    timer = setTimeout(() => {
                        if (auth.currentUser) {
                            alert('You have been logged out due to inactivity.');
                            auth.signOut();
                            sessionStorage.removeItem('kesha_session_active');
                        }
                    }, 30 * 60 * 1000); // 30 minutes
                };
                // Listen for user activity
                const events = ['mousemove', 'keydown', 'mousedown', 'touchstart', 'scroll'];
                events.forEach(e => window.addEventListener(e, resetTimer));
                resetTimer();
                return () => {
                    if (timer) clearTimeout(timer);
                    events.forEach(e => window.removeEventListener(e, resetTimer));
                };
            }, []);

            useEffect(() => { 
                // Security: Enforce Session Persistence & Clear Stale Sessions
                auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);
                const unsubscribe = auth.onAuthStateChanged(async (u) => { 
                    console.log('Auth state changed:', u ? `User: ${u.email}` : 'No user');
                    // If user exists but no session flag -> New tab with stale LocalStorage -> Force Logout
                    if (u && !sessionStorage.getItem('kesha_session_active')) {
                        console.log('Clearing stale session');
                        await auth.signOut();
                        setUser(null);
                        setAuthLoading(false);
                        sessionStorage.setItem('kesha_session_active', '1'); // Mark active for subsequent login
                    } else {
                        if (u) {
                            console.log('Setting session active');
                            sessionStorage.setItem('kesha_session_active', '1');
                        }
                        setUser(u); 
                        setAuthLoading(false);
                    }
                }); 
                return unsubscribe; 
            }, []);

            // Auto-Backup Check
            useEffect(() => {
                if(user && userRole === 'admin') {
                    const checkBackup = async () => {
                        const freq = localStorage.getItem('kesha_backup_freq');
                        const last = localStorage.getItem('kesha_last_backup');
                        if(!freq || freq === 'off') return;
                        const now = Date.now();
                        const interval = freq === 'daily' ? 86400000 : 604800000; // 24h or 7d
                        if(!last || (now - parseInt(last) > interval)) {
                            try { await performBackup(); localStorage.setItem('kesha_last_backup', now); } catch(e) { console.error("Auto-backup failed", e); }
                        }
                    };
                    checkBackup();
                }
            }, [user, userRole]);

            // Session timeout - 30 minutes of inactivity
            useEffect(() => {
                if (!user) return;
                
                const TIMEOUT_DURATION = 30 * 60 * 1000; // 30 minutes in milliseconds
                
                const checkTimeout = () => {
                    const now = Date.now();
                    if (now - lastActivityRef.current > TIMEOUT_DURATION) {
                        alert('Session expired due to inactivity. Please login again.');
                        auth.signOut();
                    }
                };
                
                const updateActivity = () => { lastActivityRef.current = Date.now(); };
                
                // Track user activity
                const events = ['mousedown', 'keydown', 'scroll', 'touchstart'];
                events.forEach(event => document.addEventListener(event, updateActivity));
                
                // Check every minute
                const interval = setInterval(checkTimeout, 60000);
                
                return () => {
                    events.forEach(event => document.removeEventListener(event, updateActivity));
                    clearInterval(interval);
                };
            }, [user]);

            // Subscribe to current user's Firestore profile to read role & metadata
            useEffect(() => {
                if (!user) { setUserRole(null); setUserProfile(null); return; }
                const uref = db.collection('users').doc(user.uid);
                
                // First, try to get the user document
                uref.get().then(doc => {
                    if (doc.exists) {
                        const d = doc.data();
                        // Check if user is disabled
                        if (d.disabled) {
                            alert('⚠️ Your account has been disabled. Please contact your administrator.');
                            auth.signOut();
                            return;
                        }
                        setUserRole(d.role || 'admin');
                        setUserProfile(d || null);
                    } else {
                        // No profile exists - create default admin profile for first user
                        console.log('No user profile found, creating admin profile...');
                        const defaultProfile = {
                            email: user.email,
                            name: user.name || user.email.split('@')[0],
                            role: 'admin',
                            createdAt: new Date().toISOString(),
                            disabled: false
                        };
                        
                        // Create the profile
                        uref.set(defaultProfile).then(() => {
                            console.log('Admin profile created successfully');
                            setUserRole('admin');
                            setUserProfile(defaultProfile);
                        }).catch(err => {
                            console.error('Error creating user profile:', err);
                            // Still allow access with admin role even if profile creation fails
                            setUserRole('admin');
                            setUserProfile(defaultProfile);
                        });
                    }
                }).catch(err => {
                    console.error('User profile load error', err);
                    // Default to admin for first user
                    setUserRole('admin');
                    setUserProfile(null);
                });
            }, [user]);
            useEffect(() => { 
                if(!user) return; 
                const unsubPr = db.collection('projects').onSnapshot({
                    next: (s) => {
                        console.log('Projects snapshot received:', s.docs.length, 'documents');
                        const sortedProjects = s.docs
                            .map(d => ({id:d.id, ...d.data()}))
                            .sort((a, b) => {
                                const numA = parseInt(a.projectId) || 0;
                                const numB = parseInt(b.projectId) || 0;
                                return numA - numB;
                            });
                        console.log('Sorted projects:', sortedProjects.length);
                        setProjects(sortedProjects);
                    },
                    error: (err) => { console.error('Firestore projects snapshot error:', err); window.__fsError = err; }
                }); 
                const unsubNt = db.collection('delivery_notes').orderBy('date','desc').onSnapshot({
                    next: (s) => {
                        console.log('Delivery notes snapshot received:', s.docs.length, 'documents');
                        setNotes(s.docs.map(d => ({id:d.id, ...d.data()})));
                    },
                    error: (err) => { console.error('Firestore delivery_notes snapshot error:', err); window.__fsError = err; }
                }); 
                return () => { unsubPr(); unsubNt(); }; 
            }, [user]);

            // Load ALL stockyard elements (temporary fix until indexes are ready)
            useEffect(() => {
                if (!dnmodal && !editDN) {
                    setStockyardElements([]);
                    return;
                }
                const targetProj = dnmodal ? dnProj : (editDN ? editDN.project : '');
                const unsub = db.collection('elements').orderBy('elementId').onSnapshot({
                    next: (s) => {
                        const activeProjectNums = projects.filter(p => !p.archived).map(p => String(p.projectId));
                        const allElements = s.docs.map(d => ({id:d.id, ...d.data()})).filter(el => activeProjectNums.includes(String(el.projectNumber)));
                        const stockyard = allElements.filter(e => (targetProj ? String(e.projectNumber) === String(targetProj) : true) && e.status === 'Stockyard');
                        setStockyardElements(stockyard);
                    },
                    error: (err) => { console.error('Firestore elements snapshot error:', err); window.__fsError = err; }
                });
                return () => unsub();
            }, [dnProj, dnmodal, editDN, projects]);

            // Load elements for summary modal
            useEffect(() => {
                if (!summaryProj) {
                    setSummaryElements([]);
                    return;
                }
                const unsub = db.collection('elements')
                    .where('projectNumber', '==', String(summaryProj.projectId))
                    .onSnapshot(s => {
                        setSummaryElements(s.docs.map(d => ({id: d.id, ...d.data()})));
                    });
                return () => unsub();
            }, [summaryProj]);

            // Create charts for summary modal
            useEffect(() => {
                if (!summaryProj || summaryElements.length === 0) return;
                
                setTimeout(() => {
                    const projElements = summaryElements;
                    const types = [...new Set(projElements.map(e => (e.type || 'Unknown').toUpperCase()))].sort();
                    const data = { total: { TOTAL: 0 }, casted: { TOTAL: 0 }, delivered: { TOTAL: 0 } };
                    types.forEach(t => { data.total[t] = 0; data.casted[t] = 0; data.delivered[t] = 0; });
                    projElements.forEach(e => { 
                        const t = (e.type || 'Unknown').toUpperCase(); 
                        data.total[t]++; 
                        data.total.TOTAL++; 
                        if (e.castingDate) { data.casted[t]++; data.casted.TOTAL++; } 
                        if (e.deliveryDate) { data.delivered[t]++; data.delivered.TOTAL++; } 
                    });
                    
                    const balCast = data.total.TOTAL - data.casted.TOTAL;
                    const balDel = data.casted.TOTAL - data.delivered.TOTAL;
                    
                    // Status Doughnut Chart
                    const statusCtx = document.getElementById('statusDoughnutChart');
                    if (statusCtx) {
                        if (statusCtx.chart) statusCtx.chart.destroy();
                        statusCtx.chart = new Chart(statusCtx, {
                            type: 'doughnut',
                            data: {
                                labels: ['Delivered', 'In Stockyard', 'Balance Casting'],
                                datasets: [{
                                    data: [data.delivered.TOTAL, balDel, balCast],
                                    backgroundColor: ['#10b981', '#3b82f6', '#ef4444'],
                                    borderWidth: 2,
                                    borderColor: '#fff'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: { position: 'bottom', labels: { font: { size: 11, weight: 'bold' }, padding: 10 } },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                                return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                    
                    // Type Bar Chart
                    const typeCtx = document.getElementById('typeBarChart');
                    if (typeCtx) {
                        if (typeCtx.chart) typeCtx.chart.destroy();
                        typeCtx.chart = new Chart(typeCtx, {
                            type: 'bar',
                            data: {
                                labels: types,
                                datasets: [
                                    { label: 'Total', data: types.map(t => data.total[t]), backgroundColor: '#94a3b8' },
                                    { label: 'Casted', data: types.map(t => data.casted[t]), backgroundColor: '#3b82f6' },
                                    { label: 'Delivered', data: types.map(t => data.delivered[t]), backgroundColor: '#10b981' }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: { position: 'top', labels: { font: { size: 11, weight: 'bold' }, padding: 10 } }
                                },
                                scales: {
                                    x: { stacked: false, ticks: { font: { size: 10, weight: 'bold' } } },
                                    y: { stacked: false, beginAtZero: true, ticks: { font: { size: 10 } } }
                                }
                            }
                        });
                    }
                }, 100);
            }, [summaryProj, summaryElements]);

            const logActivity = (action, details) => { if(user) db.collection('logs').add({ timestamp: new Date().toISOString(), user: user.email, action, details }); };

            // Open DN in popup overlay
            const openDNInPopup = (note) => {
                setPrintDN(note);
            };

            // helpers to check privileges
            const canEdit = () => (userRole === 'admin' || userRole === 'editor');
            const isAdminUser = () => (userRole === 'admin');
            const handleDnProjChange = (e) => { const val = e.target.value; setDnProj(val); const p = projects.find(proj => proj.projectId === val); if(p && p.address) setDnAddr(p.address); else setDnAddr(''); setDnContact(p && p.contactNo ? p.contactNo : ''); };
            const handleUpdate = (id, data, logmsg) => { if (!canEdit()) { alert('Permission denied: read-only account.'); return; } db.collection('elements').doc(id).update(data); if(logmsg) logActivity('UPDATE', logmsg); };
            const handleDelete = async (id) => {
                const canDel = isAdminUser() || userProfile?.permissions?.canDeleteElements;
                if (!canDel) { alert('Permission denied: You do not have delete permissions.'); return; }
                if (!confirm("Please Confirm Delete?")) return;
                try {
                    const ref = db.collection('elements').doc(id);
                    const doc = await ref.get();
                    if (!doc.exists) { alert('Item not found.'); return; }
                    const data = doc.data();
                    // copy into recycle collection (keep same id for easy restore)
                    await db.collection('recycle').doc(id).set({ ...data, recycledFrom: 'elements', originalId: id, deletedAt: new Date().toISOString(), deletedBy: user?.email || 'unknown' });
                    await ref.delete();
                    logActivity('DELETE', `moved Element ID: ${id} to Recycle Bin`);
                } catch (e) { console.error(e); alert('Delete failed: ' + e.message); }
            };
            const handleDeleteNote = async (noteId) => {
                const canDel = isAdminUser() || userProfile?.permissions?.canDeleteElements;
                if (!canDel) { alert('Permission denied: You do not have delete permissions.'); return; }
                if (!window.confirm("Are you sure you want to delete this Delivery Note?")) return;
                try {
                    const nref = db.collection('delivery_notes').doc(noteId);
                    const ndoc = await nref.get();
                    if (!ndoc.exists) { alert('Delivery Note not found'); return; }
                    const data = ndoc.data();

                    // Revert element statuses back to Stockyard and remove delivery date
                    if (data.items && Array.isArray(data.items)) {
                        const batch = db.batch();
                        for (const item of data.items) {
                            const ids = item.ids || (item.id ? [item.id] : []);
                            ids.forEach(id => {
                                const elemRef = db.collection('elements').doc(id);
                                batch.update(elemRef, { status: 'Stockyard', deliveryDate: '' });
                            });
                        }
                        await batch.commit();
                    }

                    // Remove elements from delivery history (custom logic)
                    // If you have a delivery history collection, remove references here
                    // Example: await db.collection('delivery_history').doc(noteId).delete();

                    // store with a note_ prefix in recycle to avoid key collisions
                    await db.collection('recycle').doc(`note_${noteId}`).set({ ...data, recycledFrom: 'delivery_notes', originalId: noteId, deletedAt: new Date().toISOString(), deletedBy: user?.email || 'unknown' });
                    await nref.delete();
                    logActivity('DELETE', `moved Delivery Note ID: ${noteId} to Recycle Bin and reverted elements to Stockyard`);
                } catch (e) { console.error(e); alert('Error: ' + e.message); }
            };
            const handleChangeDNNumber = async (noteId, currentDN) => {
                const hasPerm = canEdit() || userProfile?.permissions?.canCreateDN;
                if (!hasPerm) { alert('Permission denied: You do not have permission to edit DN Numbers.'); return; }
                const newDN = window.prompt(`Change Delivery Note Number\n\nCurrent: ${currentDN}\n\nEnter new DN number:`, currentDN);
                if (!newDN || newDN.trim() === '' || newDN === currentDN) return;
                try {
                    await db.collection('delivery_notes').doc(noteId).update({ dnNumber: newDN.trim() });
                    logActivity('UPDATE', `Changed DN# from ${currentDN} to ${newDN.trim()}`);
                    alert('✅ DN number updated successfully!');
                } catch (e) { console.error(e); alert('Error updating DN#: ' + e.message); }
            };
            const handleChangeDNDate = async (noteId, currentDate, noteItems) => {
                const hasPerm = canEdit() || userProfile?.permissions?.canCreateDN;
                if (!hasPerm) { alert('Permission denied: You do not have permission to edit DN Dates.'); return; }
                const newDate = window.prompt(`Change Delivery Date\n\nCurrent: ${formatDate(currentDate)}\n\nEnter new date (YYYY-MM-DD):`, currentDate);
                if (!newDate || newDate.trim() === '' || newDate === currentDate) return;
                try {
                    // Update delivery note date
                    await db.collection('delivery_notes').doc(noteId).update({ date: newDate.trim() });
                    // Update all elements' delivery dates
                    if (noteItems && Array.isArray(noteItems)) {
                        const batch = db.batch();
                        for (const item of noteItems) {
                            const ids = item.ids || (item.id ? [item.id] : []);
                            ids.forEach(id => {
                                const elemRef = db.collection('elements').doc(id);
                                batch.update(elemRef, { deliveryDate: newDate.trim() });
                            });
                        }
                        await batch.commit();
                    }
                    logActivity('UPDATE', `Changed delivery date from ${formatDate(currentDate)} to ${formatDate(newDate.trim())} for DN# ${noteId}`);
                    alert('✅ Delivery date updated successfully!');
                } catch (e) { console.error(e); alert('Error updating delivery date: ' + e.message); }
            };
            const handleDeleteProject = async (id) => {
                const canDel = isAdminUser() || userProfile?.permissions?.canDeleteProjects;
                if (!canDel) { alert('Permission denied: You do not have project delete permissions.'); return; }
                if (!window.confirm("⚠️ DANGER ZONE\n\nThis will move the project and ALL its elements to Recycle Bin.\n\nAre you sure you want to continue?")) return;
                try {
                    const pjRef = db.collection('projects').doc(id);
                    const pjDoc = await pjRef.get();
                    if (pjDoc.exists) {
                        const pjData = pjDoc.data();
                        await db.collection('recycle').doc(`project_${id}`).set({ ...pjData, recycledFrom: 'projects', originalId: id, deletedAt: new Date().toISOString(), deletedBy: user?.email || 'unknown' });
                    }
                    const p = projects.find(x => x.id === id);
                    if (p) {
                        const batch = db.batch();
                        const elems = elements.filter(e => String(e.projectNumber) === String(p.projectId));
                        elems.forEach(e => {
                            // copy element data to recycle (same id)
                            batch.set(db.collection('recycle').doc(e.id), { ...e, recycledFrom: 'elements', originalId: e.id, deletedAt: new Date().toISOString(), deletedBy: user?.email || 'unknown' });
                            batch.delete(db.collection('elements').doc(e.id));
                        });
                        await batch.commit();
                    }
                    // finally delete project doc
                    await pjRef.delete();
                    logActivity('DELETE', `moved Project ID: ${id} and its elements to Recycle Bin`);
                    alert('Project moved to Recycle Bin.');
                } catch (e) { console.error(e); alert('Error: ' + e.message); }
            };
            const handleDeleteProjectElements = async (projectId) => {
                const canDel = isAdminUser() || userProfile?.permissions?.canDeleteElements;
                if (!canDel) { alert('Permission denied: You do not have delete permissions.'); return; }
                const p = projects.find(x => x.id === projectId);
                if (!p) return;
                const snapshot = await db.collection('elements').where('projectNumber', '==', String(p.projectId)).get();
                const elemCount = snapshot.size;
                if (elemCount === 0) { alert('No elements to delete for this project.'); return; }
                if (!window.confirm(`⚠️ WARNING\n\nThis will move ALL ${elemCount} elements of "${p.name}" to Recycle Bin.\n\nThe project itself will remain.\n\nAre you sure?`)) return;
                try {
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.set(db.collection('recycle').doc(doc.id), { ...doc.data(), recycledFrom: 'elements', originalId: doc.id, deletedAt: new Date().toISOString(), deletedBy: user?.email || 'unknown' });
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    logActivity('DELETE', `moved ${elemCount} elements from Project "${p.name}" to Recycle Bin`);
                    alert(`${elemCount} elements moved to Recycle Bin.`);
                } catch (e) { console.error(e); alert('Error: ' + e.message); }
            };
            const handleAddProj = (e) => { if (!canEdit()) { alert('Permission denied: read-only account.'); return; } e.preventDefault(); const fd = new FormData(e.target); db.collection('projects').doc(`PROJ_${fd.get('id')}`).set({ name: fd.get('name'), projectId: String(fd.get('id')), address: fd.get('address'), contactNo: fd.get('contact') || '', archived: false }); logActivity('CREATE', `Created Project: ${fd.get('name')}`); setIsProjOpen(false); };
            const handleUpdateProject = (e) => { if (!canEdit()) { alert('Permission denied: read-only account.'); return; } e.preventDefault(); const fd = new FormData(e.target); if(!editingProj) return; db.collection('projects').doc(editingProj.id).update({ name: fd.get('name'), address: fd.get('address'), contactNo: fd.get('contact') || '' }).then(() => { logActivity('UPDATE', `Updated Project: ${editingProj.name}`); setEditingProj(null); }); };
            const handleArchiveProject = async (id, shouldArchive) => { 
                const canArch = isAdminUser() || userProfile?.permissions?.canArchiveProjects;
                if (!canArch) { alert('Permission denied: You do not have archive permissions.'); return; } 
                const project = projects.find(p => p.id === id); if (!project) return; const action = shouldArchive ? 'archive' : 'unarchive'; if (!confirm(`Are you sure you want to ${action} the project "${project.name}"?`)) return; try { await db.collection('projects').doc(id).update({ archived: shouldArchive }); logActivity(shouldArchive ? 'ARCHIVE' : 'UNARCHIVE', `${shouldArchive ? 'Archived' : 'Unarchived'} Project: ${project.name}`); } catch (e) { console.error(e); alert('Error: ' + e.message); } 
            };
            const handleAddElem = (e) => { if (!canEdit()) { alert('Permission denied: read-only account.'); return; } e.preventDefault(); const fd = new FormData(e.target); const proj = projects.find(p => p.id === fd.get('proj')); const docId = `${proj.projectId}_${fd.get('id')}`.replace(/\//g, "_"); db.collection('elements').doc(docId).set({ elementId: fd.get('id'), projectNumber: String(proj.projectId), projectName: proj.name, type: fd.get('type'), length: fd.get('len'), widthHeight: fd.get('wh'), volume: fd.get('vol'), status: 'Scheduled', castingDate:'', deliveryDate:'', plannedDate:'' }); logActivity('CREATE', `Added Element: ${fd.get('id')} to Project ${proj.name}`); setIsAddOpen(false); };
            
            // QC status UI removed from Delivery view   handler no longer needed

            const handleBatchSave = async () => {
                if (!canEdit()) { alert('Permission denied: read-only account.'); return; }
                if(!batchProj) { alert("Please select a project."); return; }
                
                // Check if there are any rows with Element ID filled
                const validRows = addRows.filter(row => row.id && row.id.trim());
                if (validRows.length === 0) { 
                    alert("Please enter at least one Element ID before saving."); 
                    return; 
                }
                
                const proj = projects.find(p => p.projectId === batchProj);
                if(!proj) { alert("Project not found."); return; }
                
                const newIds = [];
                validRows.forEach(row => { const qty = parseInt(row.qty) || 1; for(let i=0; i<qty; i++) { let uniqueId = row.id.trim(); if(qty > 1) uniqueId = `${row.id.trim()}-${i+1}`; newIds.push(uniqueId); } });
                
                // Check for duplicates by querying Firestore
                const duplicateChecks = await Promise.all(
                    newIds.map(id => db.collection('elements').doc(`${batchProj}_${id}`.replace(/\//g, "_")).get())
                );
                const existingIds = duplicateChecks.filter(doc => doc.exists).map(doc => doc.data().elementId);
                
                if (existingIds.length > 0) { 
                    if (!confirm(`⚠️ WARNING: ${existingIds.length} element(s) already exist: ${existingIds.join(', ')}\n\nIf you continue, existing data will be UPDATED.\nDo you want to proceed?`)) { 
                        return; 
                    } 
                }
                
                const batch = db.batch(); 
                let count = 0;
                validRows.forEach(row => { 
                    const qty = parseInt(row.qty) || 1; 
                    for(let i = 0; i < qty; i++) { 
                        let uniqueId = row.id.trim(); 
                        if(qty > 1) uniqueId = `${row.id.trim()}-${i+1}`; 
                        const docId = `${batchProj}_${uniqueId}`.replace(/\//g, "_"); 
                        batch.set(db.collection('elements').doc(docId), { 
                            elementId: uniqueId, 
                            projectNumber: String(batchProj), 
                            projectName: proj.name, 
                            cluster: row.cluster || '', 
                            villa: row.villa || '', 
                            type: row.type || '', 
                            length: row.len || '', 
                            widthHeight: row.wh || '', 
                            volume: parseFloat(row.vol) || 0, 
                            status: 'Scheduled', 
                            castingDate: '', 
                            deliveryDate: '',
                            plannedDate: ''
                        }, {merge: true}); 
                        count++; 
                    } 
                });
                
                try { 
                    await batch.commit(); 
                    console.log(`Successfully saved ${count} elements to Firebase`);
                    alert(`✅ Successfully saved ${count} elements!`); 
                    logActivity('CREATE', `Batch added ${count} elements to ${proj.name}`); 
                    // Reset form and close modal
                    setAddRows([{ id: '', cluster: '', villa: '', type: '', len: '', wh: '', vol: '', qty: 1 }]);
                    setBatchProj('');
                    setIsBatchAddOpen(false);
                } catch(e) { 
                    console.error("Error saving batch:", e);
                    alert("❌ Error saving: " + e.message); 
                }
            };
            const handleAddRow = () => { const prev = addRows[addRows.length - 1]; setAddRows([...addRows, { id: '', cluster: prev.cluster, villa: prev.villa, type: prev.type, len: prev.len, wh: prev.wh, vol: prev.vol, qty: 1 }]); };
            const handleRemoveRow = (idx) => setAddRows(addRows.filter((_, i) => i !== idx));
            const handleRowChange = (idx, field, val) => { const newRows = [...addRows]; newRows[idx][field] = val; setAddRows(newRows); };

            const handleRemoveDNItem = async (note, itemToRemove) => {
                const hasPerm = canEdit() || userProfile?.permissions?.canEditElements || userProfile?.permissions?.canCreateDN;
                if (!hasPerm) { alert('Permission denied: You do not have permission to edit Delivery Notes.'); return; }
                if (!confirm(`Remove element ${itemToRemove.elementId} from this Delivery Note?\n\nIts status will revert to 'Stockyard'.`)) return;
                try {
                    const noteRef = db.collection('delivery_notes').doc(note.id);
                    // itemToRemove might be a grouped item, so we filter by object reference or elementId+type
                    const newItems = note.items.filter(i => i !== itemToRemove);
                    await noteRef.update({ items: newItems });
                    
                    const idsToRevert = itemToRemove.ids || (itemToRemove.id ? [itemToRemove.id] : []);
                    const batch = db.batch();
                    idsToRevert.forEach(id => batch.update(db.collection('elements').doc(id), { status: 'Stockyard', deliveryDate: '' }));
                    await batch.commit();
                    
                    logActivity('UPDATE', `Removed ${itemToRemove.elementId} (Qty: ${itemToRemove.qty || 1}) from DN ${note.dnNumber}`);
                    setEditDN(prev => ({ ...prev, items: newItems }));
                } catch (e) { console.error(e); alert('Error removing item: ' + e.message); }
            };

            const handleAddDNItem = async (note, itemToAdd) => {
                const hasPerm = canEdit() || userProfile?.permissions?.canEditElements || userProfile?.permissions?.canCreateDN;
                if (!hasPerm) { alert('Permission denied: You do not have permission to edit Delivery Notes.'); return; }
                if (!confirm(`Add element ${itemToAdd.elementId} to this Delivery Note?\n\nIts status will change to 'Shipped'.`)) return;
                try {
                    const noteRef = db.collection('delivery_notes').doc(note.id);
                    const newItem = { id: itemToAdd.id, elementId: itemToAdd.elementId, type: itemToAdd.type, qty: 1, volume: itemToAdd.volume };
                    const newItems = [...note.items, newItem];
                    await noteRef.update({ items: newItems });
                    await db.collection('elements').doc(itemToAdd.id).update({ status: 'Shipped', deliveryDate: note.date });
                    logActivity('UPDATE', `Added element ${itemToAdd.elementId} to DN ${note.dnNumber}`);
                    setEditDN(prev => ({ ...prev, items: newItems }));
                } catch (e) { console.error(e); alert('Error adding item: ' + e.message); }
            };

            const handleUpdateDNItemQty = async (note, item, newQty) => {
                const hasPerm = canEdit() || userProfile?.permissions?.canEditElements || userProfile?.permissions?.canCreateDN;
                if (!hasPerm) { alert('Permission denied: You do not have permission to edit Delivery Notes.'); return; }
                const qty = parseInt(newQty) || 1;
                if (qty < 1) { alert('Quantity must be at least 1.'); return; }
                
                const oldQty = item.qty || 1;
                if (qty === oldQty) return; // No change
                
                try {
                    const noteRef = db.collection('delivery_notes').doc(note.id);
                    const batch = db.batch();
                    
                    // If item has 'ids' array (grouped items), handle element status changes
                    if (item.ids && Array.isArray(item.ids)) {
                        if (qty < oldQty) {
                            // DECREASING: Revert removed elements to Stockyard
                            const removedCount = oldQty - qty;
                            const idsToRevert = item.ids.slice(-removedCount); // Last N elements
                            idsToRevert.forEach(id => {
                                batch.update(db.collection('elements').doc(id), { 
                                    status: 'Stockyard', 
                                    deliveryDate: '' 
                                });
                            });
                            // Update item.ids to remove last N
                            item.ids = item.ids.slice(0, qty);
                        } else if (qty > oldQty) {
                            // INCREASING: Find and add more elements
                            const addCount = qty - oldQty;
                            const baseId = item.elementId.replace(/[-\.]\d+$/, '');
                            
                            // Find available stockyard elements with same base ID
                            const availableElements = stockyardElements.filter(e => {
                                const elId = e.elementId.replace(/[-\.]\d+$/, '');
                                return elId === baseId && 
                                       e.type === item.type && 
                                       !item.ids.includes(e.id);
                            }).slice(0, addCount);
                            
                            if (availableElements.length < addCount) {
                                alert(`Only ${availableElements.length} more elements available. Cannot increase to ${qty}.`);
                                return;
                            }
                            
                            // Add new elements to Shipped status
                            availableElements.forEach(el => {
                                batch.update(db.collection('elements').doc(el.id), { 
                                    status: 'Shipped', 
                                    deliveryDate: note.date 
                                });
                                item.ids.push(el.id);
                            });
                        }
                    }
                    
                    // Update DN items with new quantity
                    const updatedItems = note.items.map(i => i === item ? { ...i, qty, ids: item.ids } : i);
                    await noteRef.update({ items: updatedItems });
                    await batch.commit();
                    
                    logActivity('UPDATE', `Changed ${item.elementId} quantity from ${oldQty} to ${qty} in DN ${note.dnNumber}`);
                    setEditDN(prev => ({ ...prev, items: updatedItems }));
                } catch (e) { console.error(e); alert('Error updating quantity: ' + e.message); }
            };

            const handleCreateDN = async (showPreview = false) => {
                if (!canEdit()) { alert('Permission denied: read-only account.'); return; }

                // Generate a per-project sequential delivery note number like DN#N0001
                // and a professional reference like NPCC-<year>-<project#>-<day>
                try {
                    // Check for mixed projects
                    const uniqueProjs = [...new Set(dnItems.map(i => String(i.projectNumber)))];
                    const isMultiProject = uniqueProjs.length > 1;

                    // Group items logic for the Delivery Note payload
                    const groupedItems = [];
                    if (groupDnItems) {
                        dnItems.forEach(item => {
                            // Determine base ID (e.g. BLOCK-1 -> BLOCK, or CP-01.001 -> CP-01)
                            const baseId = item.elementId.replace(/[-\.]\d+$/, '');
                            
                            const existing = groupedItems.find(g => 
                                g.elementId === baseId && 
                                g.type === item.type && 
                                String(g.projectNumber) === String(item.projectNumber) &&
                                Math.abs(parseFloat(g.volume||0) - parseFloat(item.volume||0)) < 0.001 &&
                                (!dnShowCluster || g.cluster === item.cluster) &&
                                (!dnShowVilla || g.villa === item.villa)
                            );
                            
                            if (existing) {
                                existing.qty = (existing.qty || 1) + 1;
                                if (!existing.ids) existing.ids = [existing.id];
                                existing.ids.push(item.id);
                            } else {
                                groupedItems.push({ ...item, elementId: baseId, qty: 1, ids: [item.id] });
                            }
                        });
                    } else {
                        dnItems.forEach(item => {
                            groupedItems.push({ ...item, qty: 1, ids: [item.id] });
                        });
                    }

                    const projectKey = String(dnProj || '0');
                    // Get existing notes for this project and find the highest number
                    const projectNotes = (notes || []).filter(n => String(n.project) === projectKey);
                    let maxNum = 0;
                    projectNotes.forEach(n => {
                        const match = (n.dnNumber || '').match(/DN#N(\d+)/);
                        if (match) {
                            const num = parseInt(match[1], 10);
                            if (num > maxNum) maxNum = num;
                        }
                    });
                    const nextNum = maxNum + 1;
                    const seqStr = String(nextNum).padStart(3, '0');
                    const dnNum = `DN#N${seqStr}`;

                    // Reference number: NPCC-<year>-<project#>-<sequential#>
                    const createdDate = dnDate ? new Date(dnDate) : new Date();
                    const year = createdDate.getFullYear();
                    const refNo = `NPCC-${year}-${projectKey}-${seqStr}`;

                    const batch = db.batch();
                    const noteRef = db.collection('delivery_notes').doc();
                    const selectedProject = projects.find(p => String(p.projectId) === String(dnProj));

                    const payload = {
                        dnNumber: dnNum,
                        refNo,
                        project: dnProj,
                    projectName: isMultiProject ? `Multiple Projects` : (selectedProject ? selectedProject.name : ''),
                    projectNumber: isMultiProject ? 'VARIOUS' : (selectedProject ? selectedProject.projectId : dnProj),
                        address: dnAddr,
                        contactNo: dnContact,
                        showCluster: dnShowCluster,
                        showVilla: dnShowVilla,
                        showWeight: dnShowWeight,
                        date: dnDate,
                        items: groupedItems,
                        driverName: dnDriver,
                        vehicleNo: dnVehicle,
                    transportCo: dnTransport,
                    isMultiProject: isMultiProject
                    };
                    batch.set(noteRef, payload);
                    dnItems.forEach(i => batch.update(db.collection('elements').doc(i.id), { status:'Shipped', deliveryDate: dnDate }));

                    await batch.commit();
                    logActivity('DELIVERY', `Created Delivery Note ${dnNum} (${refNo}) with ${dnItems.length} items.`);
                    
                    if (showPreview) {
                        // Open DN in popup overlay immediately
                        openDNInPopup({ ...payload });
                        setDnmodal(false); // Close the DN creation modal
                    } else {
                        // Save & Next - clear form for next DN
                        alert(`✅ Delivery Note ${dnNum} created successfully!\n\nReady for the next one.`);
                    }
                    setDnItems([]);
                } catch (e) {
                    console.error('Create DN error', e);
                    if (e.message && e.message.includes('showPreview')) {
                        // Suppress this error, DN is already created
                        return;
                    }
                    alert('Failed to create Delivery Note: ' + (e.message || e));
                }
            };
            const toggleDnItem = (el) => { 
                if(dnItems.find(i=>i.id===el.id)) {
                    setDnItems(dnItems.filter(i=>i.id!==el.id)); 
                } else {
                if (dnItems.length === 0 && !dnProj) {
                        setDnProj(el.projectNumber);
                        const p = projects.find(proj => String(proj.projectId) === String(el.projectNumber)); 
                        if(p && p.address) setDnAddr(p.address); else setDnAddr(''); 
                        setDnContact(p && p.contactNo ? p.contactNo : '');
                }
                    setDnItems([...dnItems, el]); 
                }
            };
            
            const handleBulkTypicalAdd = () => {
                if (!bulkTypicalBase) { alert('Please select a typical element first.'); return; }
                const qty = parseInt(bulkTypicalQty) || 1;
                if (qty < 1) { alert('Quantity must be at least 1.'); return; }
                
                // Find all elements with same base ID pattern (e.g., CP-01.001, CP-01.002, or COL-01, COL-01-2)
                // Match both "." and "-" separators before the trailing number
                const baseId = bulkTypicalBase.elementId.replace(/[-\.]\d+$/, ''); // Remove trailing -N or .N suffix
                const typicalElements = stockyardElements.filter(e => {
                    const elId = e.elementId.replace(/[-\.]\d+$/, '');
                    return elId === baseId && !dnItems.find(i => i.id === e.id);
                });
                
                if (typicalElements.length === 0) {
                    alert('No available typical elements found in stockyard.');
                    return;
                }
                
                const toAdd = typicalElements.slice(0, qty);
                setDnItems([...dnItems, ...toAdd]);
                alert(`Added ${toAdd.length} typical element(s) to delivery.`);
                setBulkTypicalMode(false);
                setBulkTypicalBase(null);
                setBulkTypicalQty(1);
            };
            
            if (showWelcome) return <WelcomeScreen onEnter={() => setShowWelcome(false)} />;
            if (authLoading) return <div className="h-screen flex items-center justify-center bg-slate-900 text-white"><Icon name="spinner" size={40}/></div>;
            if (!user) return <Login />;

            if (printDN) {
                console.log('Rendering DeliveryNoteTemplate for:', printDN);
                return (
                    <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-5xl h-[90vh] flex flex-col overflow-hidden">
                            <div className="flex-1 overflow-auto">
                                <DeliveryNoteTemplate
                                    note={printDN}
                                    onClose={() => setPrintDN(null)}
                                    onPrint={() => window.print()}
                                    isPopup={true}
                                />
                            </div>
                        </div>
                    </div>
                );
            }

            if(bulkPrintNotes) return (
                <div className="bg-white min-h-screen">
                    <div className="no-print fixed top-4 right-4 flex gap-2 z-50">
                        <button onClick={() => window.print()} className="bg-blue-600 text-white px-4 py-2 rounded shadow-lg hover:bg-blue-700 font-bold flex items-center gap-2">
                            <Icon name="print"/> Print All
                        </button>
                        <button onClick={() => setBulkPrintNotes(null)} className="bg-gray-800 text-white px-4 py-2 rounded shadow-lg hover:bg-gray-700 font-bold">
                            Close
                        </button>
                    </div>
                    {bulkPrintNotes.map((note, i) => (
                        <div key={note.id} className="page-break">
                            <DeliveryNoteTemplate note={note} hideControls={true} isPopup={true} />
                            {i < bulkPrintNotes.length - 1 && <div className="print:block hidden" style={{pageBreakAfter: 'always'}}></div>}
                        </div>
                    ))}
                </div>
            );

            return (
                <div className="flex h-screen bg-slate-900 text-slate-100 font-sans overflow-hidden">
                    {/* DN Popup Overlay */}
                    {printDN && (
                        <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm no-print">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-5xl h-[90vh] flex flex-col overflow-hidden">
                                <div className="flex-1 overflow-auto">
                                    <DeliveryNoteTemplate
                                        note={printDN}
                                        onClose={() => setPrintDN(null)}
                                        onPrint={() => window.print()}
                                        isPopup={true}
                                    />
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Firestore debug banner with auth status */}
                    {(window.__fsError || !user) && (
                        <div className={`no-print fixed top-2 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded shadow-lg text-sm font-mono ${window.__fsError ? 'bg-red-600 text-white' : 'bg-yellow-500 text-black'}`}>
                            {window.__fsError && `🔴 Firestore: ${String(window.__fsError.message || window.__fsError)} | `}
                            Project: {firebase.app().options.projectId} | 
                            Auth: {user ? `✓ ${user.email}` : '✗ NOT SIGNED IN'} | 
                            Role: {userRole || 'loading...'}
                        </div>
                    )}
                    
                    {/* mOBILE HEADER */}
                    <div className="no-print md:hidden bg-slate-900 text-white p-4 flex justify-between items-center fixed top-0 left-0 right-0 z-50 shadow-md">
                        <h1 className="font-bold text-lg tracking-tight truncate mr-2">Naran Precast</h1>
                        <button onClick={() => setIsmobilemenuOpen(!ismobilemenuOpen)} className="p-2 rounded hover:bg-slate-800"><Icon name="bars" size={24}/></button>
                    </div>

                    {ismobilemenuOpen && <div className="no-print fixed inset-0 bg-black/50 z-40 md:hidden" onClick={() => setIsmobilemenuOpen(false)}></div>}

                    {/* SIDEBAR (Responsive) */}
                    <aside className={`no-print fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 text-white transition-transform duration-300 ease-in-out transform ${ismobilemenuOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 md:flex flex-col`}>
                        <div className="p-6 border-b border-slate-800 flex items-center gap-3 mt-14 md:mt-0">
                            <div className="bg-blue-600 p-2 rounded-lg text-white"><Icon name="hammer" size={20}/></div>
                            <div>
                                <h1 className="font-bold text-lg tracking-tight leading-tight">Naran Precast</h1>
                                <p className="text-[10px] text-slate-400 font-medium uppercase tracking-wider">Concrete Company LLC.</p>
                            </div>
                        </div>
                        <nav className="p-4 space-y-2 flex-1 overflow-y-auto">
                            {(() => {
                                    const base = [{id:'production', lbl:'Production & Planning', icon:'calendar'}, {id:'control', lbl:'Production Control', icon:'hammer'}, {id:'delivery', lbl:'Delivery', icon:'truck'}, {id:'reports', lbl:'Reports', icon:'fileText'}, {id:'projects', lbl:'Projects', icon:'folderPlus'}, {id:'logs', lbl:'Activity Logs', icon:'shield'}];
                                    // Only show users management for admins
                                    if (userRole === 'admin') base.push({ id: 'users', lbl: 'User management', icon: 'shield' });
                                    return base;
                                })().map(item => (
                                <button key={item.id} onClick={() => { setView(item.id); setIsmobilemenuOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 ${view === item.id ? 'bg-gradient-to-r from-blue-600 to-cyan-600 text-white shadow-lg scale-[1.02]' : 'text-slate-400 hover:bg-slate-800/50 hover:text-white'}`}>
                                    <Icon name={item.icon} className={view === item.id ? 'text-white' : ''}/> <span className="font-semibold">{item.lbl}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-slate-800">
                            <div className="mb-3 text-xs text-slate-300">
                                <div className="font-bold text-white truncate" title={user?.email}>{user?.email}</div>
                                <div className="text-[10px] text-slate-500 font-mono mb-1 truncate" title={user?.uid}>{user?.uid}</div>
                                <div className="inline-block mt-1 text-[11px] px-2 py-0.5 rounded-full bg-blue-700 text-white font-semibold">{userRole || 'loading...'}</div>
                                <div className="flex flex-wrap gap-1 mt-2">
                                    {userProfile?.permissions?.canCreateDN && <span className="text-[9px] px-1.5 py-0.5 rounded bg-emerald-900 text-emerald-300 border border-emerald-700">Create DN</span>}
                                    {userProfile?.permissions?.canEditElements && <span className="text-[9px] px-1.5 py-0.5 rounded bg-blue-900 text-blue-300 border border-blue-700">Edit Elem</span>}
                                    {userProfile?.permissions?.canDeleteElements && <span className="text-[9px] px-1.5 py-0.5 rounded bg-red-900 text-red-300 border border-red-700">Delete Elem</span>}
                                    {userProfile?.permissions?.canDeleteProjects && <span className="text-[9px] px-1.5 py-0.5 rounded bg-red-900 text-red-300 border border-red-700">Del Proj</span>}
                                    {userProfile?.permissions?.canArchiveProjects && <span className="text-[9px] px-1.5 py-0.5 rounded bg-amber-900 text-amber-300 border border-amber-700">Archive</span>}
                                </div>
                            </div>
                            <button onClick={() => auth.signOut()} className="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-red-400 hover:bg-slate-800 transition"><Icon name="arrowRight" className="rotate-180"/> <span className="font-bold">Sign Out</span></button>
                        </div>
                    </aside>

                    {/* mAIN CONTENT */}
                    <main className={`flex-1 bg-slate-50 p-4 md:p-8 overflow-y-auto relative mt-16 md:mt-0 ${summaryProj ? 'print:hidden' : ''}`}>
                        {view === 'production' && <WeeklyPlanner projects={projects} onUpdate={(id,d,m)=>handleUpdate(id,d,m)} onImport={() => setIsImportOpen(true)} onPasteImport={() => setIsPasteImportOpen(true)} onAdd={() => setIsBatchAddOpen(true)} userRole={userRole} />}
                        {view === 'control' && <ProductionControlView projects={projects} notes={notes} onUpdate={handleUpdate} onDelete={handleDelete} userRole={userRole} userProfile={userProfile} onViewDN={openDNInPopup} savedTab={savedControlTab} setSavedTab={setSavedControlTab} savedProjFilter={savedControlProjFilter} setSavedProjFilter={setSavedControlProjFilter} />}
                        {view === 'delivery' && <DeliveryView projects={projects} notes={notes} onCreateDN={()=>{setDnItems([]); setDnProj(''); setDnDriver(''); setDnVehicle(''); setDnTransport(''); setGroupDnItems(false); setDnShowCluster(false); setDnShowVilla(false); setDnShowWeight(true); setDnmodal(true)}} onHistory={()=>setHistmodal(true)} userRole={userRole} userProfile={userProfile} onViewDN={openDNInPopup} onAdd={() => setIsAddOpen(true)} />}
                        {view === 'reports' && <ReportsView projects={projects} onUpdate={handleUpdate} userRole={userRole} notes={notes} />}
                        {view === 'logs' && <LogsView user={user} userRole={userRole} />}
                        {view === 'users' && userRole === 'admin' && <UsersView userRole={userRole} />}
                        {view === 'projects' && <ProjectsView projects={projects} setIsProjOpen={setIsProjOpen} canEdit={canEdit} setSummaryProj={setSummaryProj} setEditingProj={setEditingProj} handleArchiveProject={handleArchiveProject} handleDeleteProject={handleDeleteProject} handleDeleteProjectElements={handleDeleteProjectElements} isAdminUser={isAdminUser} userProfile={userProfile} />}
                    </main>

                    {/* --- mODAL SECTION --- */}
                    
                    {isImportOpen && <ImportWizard projects={projects} onClose={() => setIsImportOpen(false)} onImportComplete={(msg) => { setIsImportOpen(false); logActivity('ImPORT', msg || 'File Imported'); }} userRole={userRole} />}
                    {isPasteImportOpen && <PasteImporter projects={projects} onClose={() => setIsPasteImportOpen(false)} onImportComplete={(msg) => { setIsPasteImportOpen(false); logActivity('ImPORT', msg || 'Pasted Data'); }} userRole={userRole} />}
                    
                    {/* NEW: BATCH ADD mODAL (Updated with Quantity) */}
                    {isBatchAddOpen && (
                        <div className="fixed inset-0 bg-black/60 z-[90] flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl flex flex-col h-[90vh] overflow-hidden">
                                <div className="p-4 bg-slate-900 text-white flex justify-between items-center"><h3 className="font-bold text-lg flex items-center gap-2"><Icon name="plus"/> Batch Add Elements</h3><button onClick={() => setIsBatchAddOpen(false)}><Icon name="x"/></button></div>
                                <div className="p-4 border-b bg-slate-50"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Select Project for Batch</label><select value={batchProj} onChange={e=>setBatchProj(e.target.value)} className="w-full max-w-md p-2 border-2 border-blue-200 rounded font-bold text-slate-800 bg-white"><option value="">-- Select Project --</option>{projects.filter(p => !p.archived).map(p => <option key={p.projectId} value={p.projectId}>{p.projectId} - {p.name}</option>)}</select></div>
                                <div className="flex-1 overflow-auto p-4">
                                    <table className="w-full text-sm text-left border-collapse"><thead className="bg-slate-100 text-xs uppercase font-bold text-slate-500 sticky top-0"><tr><th className="p-3 border">Element ID (Base)</th><th className="p-3 border w-16 text-center bg-yellow-50">Qty</th><th className="p-3 border">Cluster</th><th className="p-3 border">Villa</th><th className="p-3 border">Type</th><th className="p-3 border w-20">L</th><th className="p-3 border w-20">W/H</th><th className="p-3 border w-20">Vol</th><th className="p-3 border text-center">Action</th></tr></thead>
                                    <tbody>{addRows.map((row, idx) => (<tr key={idx}><td className="p-1 border"><input value={row.id} onChange={e=>handleRowChange(idx, 'id', e.target.value)} className="w-full p-2 border-none bg-transparent font-bold" placeholder="e.g. COL-01"/></td><td className="p-1 border bg-yellow-50"><input type="number" min="1" value={row.qty} onChange={e=>handleRowChange(idx, 'qty', e.target.value)} className="w-full p-2 border-none bg-transparent text-center font-bold text-blue-600"/></td><td className="p-1 border"><input value={row.cluster} onChange={e=>handleRowChange(idx, 'cluster', e.target.value)} className="w-full p-2 border-none bg-transparent"/></td><td className="p-1 border"><input value={row.villa} onChange={e=>handleRowChange(idx, 'villa', e.target.value)} className="w-full p-2 border-none bg-transparent"/></td><td className="p-1 border"><input value={row.type} onChange={e=>handleRowChange(idx, 'type', e.target.value)} className="w-full p-2 border-none bg-transparent"/></td><td className="p-1 border"><input value={row.len} onChange={e=>handleRowChange(idx, 'len', e.target.value)} className="w-full p-2 border-none bg-transparent"/></td><td className="p-1 border"><input value={row.wh} onChange={e=>handleRowChange(idx, 'wh', e.target.value)} className="w-full p-2 border-none bg-transparent"/></td><td className="p-1 border"><input value={row.vol} onChange={e=>handleRowChange(idx, 'vol', e.target.value)} className="w-full p-2 border-none bg-transparent"/></td><td className="p-1 border text-center"><button onClick={()=>handleRemoveRow(idx)} className="text-red-400 hover:text-red-600"><Icon name="trash"/></button></td></tr>))}</tbody></table>
                                    <p className="text-xs text-slate-400 mt-2 italic">* If Qty &gt; 1, IDs will be generated as ID-1, ID-2, etc.</p>
                                </div>
                                <div className="p-4 border-t bg-slate-50 flex justify-between items-center"><button onClick={handleAddRow} className="text-blue-600 font-bold flex items-center gap-2 hover:underline"><Icon name="plus"/> Add Row</button><div className="flex gap-2"><button onClick={() => setIsBatchAddOpen(false)} className="px-4 py-2 text-slate-500 font-bold hover:bg-slate-200 rounded">Cancel</button><button onClick={handleBatchSave} className="btn-primary text-white px-6 py-2 rounded font-bold shadow-lg">Save All Elements</button></div></div>
                            </div>
                        </div>
                    )}
                    
                    {/* NEW: SUmmARY mODAL */}
                    {summaryProj && (
                        <div className="fixed inset-0 bg-black/60 z-[80] flex items-center justify-center p-4 backdrop-blur-sm print:absolute print:inset-0 print:bg-white print:p-0 print:block print:h-auto print:overflow-visible">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl overflow-hidden flex flex-col max-h-[90vh] print:shadow-none print:max-h-none print:h-auto print:overflow-visible">
                                <div className="p-4 bg-slate-900 text-white flex justify-between items-center no-print">
                                    <h3 className="font-bold text-lg">ProjectNo {summaryProj.projectId} - {summaryProj.name} Summary</h3>
                                    <button onClick={() => setSummaryProj(null)}><Icon name="x"/></button>
                                </div>
                                <div id="summary-content" className="flex-1 overflow-auto p-6 project-summary-print">
                                    <div className="text-center mb-6 print:block hidden">
                                        <h1 className="text-2xl font-extrabold uppercase tracking-wide text-blue-900">Naran Precast Concrete Co. LLC.</h1>
                                        <h2 className="text-lg font-bold text-slate-700 mt-2">Project Summary Report</h2>
                                        <p className="text-sm text-slate-600 mt-1">Project: {summaryProj.name} (#{summaryProj.projectId})</p>
                                    </div>
                                    {(() => {
                                        const projElements = summaryElements;
                                        const types = [...new Set(projElements.map(e => (e.type || 'Unknown').toUpperCase()))].sort();
                                        const data = { total: { TOTAL: 0 }, casted: { TOTAL: 0 }, delivered: { TOTAL: 0 }, balCast: { TOTAL: 0 }, balDel: { TOTAL: 0 } };
                                        types.forEach(t => { data.total[t] = 0; data.casted[t] = 0; data.delivered[t] = 0; data.balCast[t] = 0; data.balDel[t] = 0; });
                                        projElements.forEach(e => { const t = (e.type || 'Unknown').toUpperCase(); data.total[t]++; data.total.TOTAL++; if (e.castingDate) { data.casted[t]++; data.casted.TOTAL++; } if (e.deliveryDate) { data.delivered[t]++; data.delivered.TOTAL++; } });
                                        types.forEach(t => { data.balCast[t] = data.total[t] - data.casted[t]; data.balDel[t] = data.casted[t] - data.delivered[t]; });
                                        data.balCast.TOTAL = data.total.TOTAL - data.casted.TOTAL; data.balDel.TOTAL = data.casted.TOTAL - data.delivered.TOTAL;
                                        const castPct = data.total.TOTAL > 0 ? ((data.casted.TOTAL / data.total.TOTAL) * 100).toFixed(1) : '0.0';
                                        const delPct = data.total.TOTAL > 0 ? ((data.delivered.TOTAL / data.total.TOTAL) * 100).toFixed(1) : '0.0';
                                        
                                        // Prepare chart data
                                        const statusChartData = {
                                            labels: ['Delivered', 'In Stockyard', 'Balance Casting'],
                                            data: [data.delivered.TOTAL, data.balDel.TOTAL, data.balCast.TOTAL],
                                            colors: ['#10b981', '#3b82f6', '#ef4444']
                                        };
                                        
                                        const typeChartData = {
                                            labels: types,
                                            datasets: [
                                                { label: 'Total', data: types.map(t => data.total[t]), backgroundColor: '#94a3b8' },
                                                { label: 'Casted', data: types.map(t => data.casted[t]), backgroundColor: '#3b82f6' },
                                                { label: 'Delivered', data: types.map(t => data.delivered[t]), backgroundColor: '#10b981' }
                                            ]
                                        };
                                        
                                        return ( 
                                            <div>
                                                <div className="grid grid-cols-2 gap-4 mb-6">
                                                    <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                                        <div className="flex justify-between items-center mb-2">
                                                            <span className="text-sm font-bold text-slate-700">Cast Progress</span>
                                                            <span className="text-2xl font-extrabold text-blue-700">{castPct}%</span>
                                                        </div>
                                                        <div className="w-full bg-blue-200 rounded-full h-3 overflow-hidden">
                                                            <div className="bg-blue-600 h-3 rounded-full transition-all" style={{ width: `${castPct}%` }}></div>
                                                        </div>
                                                        <div className="text-xs text-slate-600 mt-2">{data.casted.TOTAL} of {data.total.TOTAL} elements</div>
                                                    </div>
                                                    <div className="bg-emerald-50 p-4 rounded-lg border border-emerald-200">
                                                        <div className="flex justify-between items-center mb-2">
                                                            <span className="text-sm font-bold text-slate-700">Delivery Progress</span>
                                                            <span className="text-2xl font-extrabold text-emerald-700">{delPct}%</span>
                                                        </div>
                                                        <div className="w-full bg-emerald-200 rounded-full h-3 overflow-hidden">
                                                            <div className="bg-emerald-600 h-3 rounded-full transition-all" style={{ width: `${delPct}%` }}></div>
                                                        </div>
                                                        <div className="text-xs text-slate-600 mt-2">{data.delivered.TOTAL} of {data.total.TOTAL} elements</div>
                                                    </div>
                                                </div>
                                                
                                                {/* Charts Section */}
                                                <div className="grid grid-cols-2 gap-4 mb-6 no-print">
                                                    <div className="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                                                        <h4 className="text-sm font-bold text-slate-700 mb-3">Project Status Distribution</h4>
                                                        <canvas id="statusDoughnutChart" style={{ maxHeight: '250px' }}></canvas>
                                                    </div>
                                                    <div className="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                                                        <h4 className="text-sm font-bold text-slate-700 mb-3">Elements by Type</h4>
                                                        <canvas id="typeBarChart" style={{ maxHeight: '250px' }}></canvas>
                                                    </div>
                                                </div>
                                                
                                                <table className="w-full text-sm border-collapse border border-slate-300 text-center"><thead><tr className="bg-[#005a8d] text-white font-bold"><th className="p-3 border border-slate-300 text-left w-48">DESCRIPTION</th>{types.map(t => <th key={t} className="p-3 border border-slate-300">{t}</th>)}<th className="p-3 border border-slate-300 bg-slate-800">TOTAL</th></tr></thead><tbody className="font-bold text-slate-700"><tr className="bg-blue-50"><td className="p-3 border border-slate-300 text-left">Total Elements</td>{types.map(t => <td key={t} className="p-3 border border-slate-300">{data.total[t]}</td>)}<td className="p-3 border border-slate-300 text-slate-900 text-lg">{data.total.TOTAL}</td></tr><tr className="bg-white"><td className="p-3 border border-slate-300 text-left">Casted</td>{types.map(t => <td key={t} className="p-3 border border-slate-300">{data.casted[t]}</td>)}<td className="p-3 border border-slate-300 text-slate-900 text-lg">{data.casted.TOTAL}</td></tr><tr className="bg-blue-50"><td className="p-3 border border-slate-300 text-left">Delivered</td>{types.map(t => <td key={t} className="p-3 border border-slate-300">{data.delivered[t]}</td>)}<td className="p-3 border border-slate-300 text-slate-900 text-lg">{data.delivered.TOTAL}</td></tr><tr className="bg-white"><td className="p-3 border border-slate-300 text-left">Balance Casting</td>{types.map(t => <td key={t} className="p-3 border border-slate-300 text-red-600">{data.balCast[t]}</td>)}<td className="p-3 border border-slate-300 text-red-600 text-lg">{data.balCast.TOTAL}</td></tr><tr className="bg-blue-50"><td className="p-3 border border-slate-300 text-left">Balance Delivery (Stock)</td>{types.map(t => <td key={t} className="p-3 border border-slate-300 text-emerald-600">{data.balDel[t]}</td>)}<td className="p-3 border border-slate-300 text-emerald-600 text-lg">{data.balDel.TOTAL}</td></tr></tbody></table>
                                            </div>
                                        );
                                    })()}
                                </div>
                                <div className="p-4 border-t bg-slate-50 flex justify-end gap-2 no-print">
                                    <button onClick={() => downloadPDF('summary-content', `Summary_${summaryProj.projectId}.pdf`)} className="bg-red-600 text-white px-6 py-2 rounded font-bold flex items-center gap-2 hover:bg-red-700 transition"><Icon name="fileText"/> Download PDF</button>
                                    <button onClick={() => window.print()} className="bg-slate-800 text-white px-6 py-2 rounded font-bold flex items-center gap-2 hover:bg-slate-900 transition"><Icon name="print"/> Print Summary</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {dnmodal && (
                        <div className="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-7xl p-4 flex flex-col h-[95vh] text-slate-900 transform scale-100 transition-all">
                                <div className="flex justify-between items-center mb-2"><h3 className="font-bold text-lg flex items-center gap-2"><Icon name="truck" className="text-slate-700"/> Create Delivery Note</h3><button onClick={()=>{setDnmodal(false); setDnSearch(''); setBulkTypicalMode(false);}} className="p-1 hover:bg-slate-100 rounded-full transition"><Icon name="x"/></button></div>
                                <div className="bg-slate-50 p-2 rounded-lg border border-slate-200 mb-2 space-y-2">
                                    <div className="flex gap-2 items-center">
                                        <div className="relative flex-1"><Icon name="hashtag" className="absolute left-3 top-2.5 text-slate-400" size={14}/><input type="text" value={dnSearch} onChange={e => setDnSearch(e.target.value)} className="w-full pl-9 p-1.5 border border-slate-300 rounded text-sm font-bold placeholder-slate-400 focus:border-blue-500 outline-none" placeholder="Search ID..." /></div>
                                        <div className="relative flex-[2]"><Icon name="search" className="absolute left-3 top-2.5 text-slate-400" size={14}/><input type="text" value={dnmetaSearch} onChange={e => setDnmetaSearch(e.target.value)} className="w-full pl-9 p-1.5 border border-slate-300 rounded text-sm font-bold placeholder-slate-400 focus:border-blue-500 outline-none" placeholder="Search Cluster, Villa, Type..." /></div>
                                        <label className="flex items-center gap-2 cursor-pointer text-xs font-bold text-slate-700 select-none bg-white px-3 py-1.5 rounded border border-slate-300 hover:border-blue-400 transition"><input type="checkbox" checked={groupDnItems} onChange={e => setGroupDnItems(e.target.checked)} className="w-4 h-4 accent-blue-600"/> Group Typical</label>
                                        <label className="flex items-center gap-2 cursor-pointer text-xs font-bold text-slate-700 select-none bg-white px-3 py-1.5 rounded border border-slate-300 hover:border-blue-400 transition"><input type="checkbox" checked={dnShowCluster} onChange={e => setDnShowCluster(e.target.checked)} className="w-4 h-4 accent-blue-600"/> Show Cluster</label>
                                        <label className="flex items-center gap-2 cursor-pointer text-xs font-bold text-slate-700 select-none bg-white px-3 py-1.5 rounded border border-slate-300 hover:border-blue-400 transition"><input type="checkbox" checked={dnShowVilla} onChange={e => setDnShowVilla(e.target.checked)} className="w-4 h-4 accent-blue-600"/> Show Villa</label>
                                        <label className="flex items-center gap-2 cursor-pointer text-xs font-bold text-slate-700 select-none bg-white px-3 py-1.5 rounded border border-slate-300 hover:border-blue-400 transition"><input type="checkbox" checked={dnShowWeight} onChange={e => setDnShowWeight(e.target.checked)} className="w-4 h-4 accent-blue-600"/> Show Weight</label>
                                        <button onClick={() => setBulkTypicalMode(!bulkTypicalMode)} className={`px-3 py-1.5 rounded text-sm font-bold transition ${bulkTypicalMode ? 'bg-purple-600 text-white' : 'bg-purple-100 text-purple-700 hover:bg-purple-200'}`}><Icon name="copy" size={12}/> Bulk Typical</button>
                                    </div>
                                    <div className="grid grid-cols-4 gap-2">
                                        <div><label className="block text-[10px] font-bold text-slate-500 uppercase">Project</label><select value={dnProj} onChange={handleDnProjChange} className="w-full p-1.5 border border-slate-300 rounded text-sm font-bold text-slate-700 focus:border-blue-500 outline-none"><option value="">-- Select --</option>{projects.filter(p => !p.archived).map(p=><option key={p.id} value={p.projectId}>{p.projectId} - {p.name}</option>)}</select></div>
                                        <div><label className="block text-[10px] font-bold text-slate-500 uppercase">Date</label><input type="date" value={dnDate} onChange={e=>setDnDate(e.target.value)} className="w-full p-1.5 border border-slate-300 rounded text-sm font-bold text-slate-700 focus:border-blue-500 outline-none"/></div>
                                        <div className="col-span-2"><label className="block text-[10px] font-bold text-slate-500 uppercase">Address</label><input value={dnAddr} onChange={e=>setDnAddr(e.target.value)} className="w-full p-1.5 border border-slate-300 rounded text-sm font-bold text-slate-700 focus:border-blue-500 outline-none" placeholder="Enter Delivery Address..."/></div>
                                        <div className="col-span-2"><label className="block text-[10px] font-bold text-slate-500 uppercase">Contact No</label><input value={dnContact} onChange={e=>setDnContact(e.target.value)} className="w-full p-1.5 border border-slate-300 rounded text-sm font-bold text-slate-700 focus:border-blue-500 outline-none" placeholder="Enter Contact No..."/></div>
                                        <div className="col-span-2"><label className="block text-[10px] font-bold text-slate-500 uppercase">Transport Co.</label><input value={dnTransport} onChange={e=>setDnTransport(e.target.value)} className="w-full p-1.5 border border-slate-300 rounded text-sm font-bold text-slate-700 focus:border-blue-500 outline-none" placeholder="Transport Company Name"/></div>
                                        <div><label className="block text-[10px] font-bold text-slate-500 uppercase">Driver Name</label><input value={dnDriver} onChange={e=>setDnDriver(e.target.value)} className="w-full p-1.5 border border-slate-300 rounded text-sm font-bold text-slate-700 focus:border-blue-500 outline-none" placeholder="Driver Name"/></div>
                                        <div><label className="block text-[10px] font-bold text-slate-500 uppercase">Vehicle No</label><input value={dnVehicle} onChange={e=>setDnVehicle(e.target.value)} className="w-full p-1.5 border border-slate-300 rounded text-sm font-bold text-slate-700 focus:border-blue-500 outline-none" placeholder="Plate No"/></div>
                                    </div>
                                    {bulkTypicalMode && (
                                        <div className="bg-purple-50 border-2 border-purple-300 rounded-lg p-3 space-y-2">
                                            <div className="flex items-center gap-2 mb-2"><Icon name="copy" className="text-purple-600" size={16}/><span className="font-bold text-purple-800 text-sm">Bulk Typical Delivery</span></div>
                                            <div className="grid grid-cols-3 gap-2">
                                                <select value={bulkTypicalBase?.id || ''} onChange={e => {
                                                    const el = stockyardElements.find(x => x.id === e.target.value);
                                                    setBulkTypicalBase(el);
                                                }} className="col-span-2 p-2 border border-purple-300 rounded text-sm font-bold bg-white"><option value="">-- Select Typical Element --</option>{stockyardElements.filter(e => e.isTypical).map(e => <option key={e.id} value={e.id}>{e.elementId} - {e.type}</option>)}</select>
                                                <input type="number" min="1" value={bulkTypicalQty} onChange={e => setBulkTypicalQty(e.target.value)} className="p-2 border border-purple-300 rounded text-sm font-bold text-center bg-white" placeholder="Qty"/>
                                            </div>
                                            <button onClick={handleBulkTypicalAdd} disabled={!bulkTypicalBase} className="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-slate-300 text-white px-4 py-2 rounded text-sm font-bold transition">Add {bulkTypicalQty || 1} Typical Element(s)</button>
                                        </div>
                                    )}
                                </div>
                                <div className="flex-1 border rounded-lg overflow-hidden flex flex-col bg-white">
                                    <div className="bg-slate-100 p-2 border-b flex justify-between items-center shadow-sm z-10"><span className="text-xs font-bold text-slate-500 uppercase tracking-wider">Available Stockyard Items</span><div className="flex gap-2"><button onClick={()=>setDnItems(stockyardElements.filter(e => (dnSearch ? String(e.elementId).toLowerCase().includes(dnSearch.toLowerCase()) : true) && (dnmetaSearch ? checkMetaMatch(e, dnmetaSearch) : true)))} className="text-[10px] text-blue-600 font-bold hover:underline">Select All</button><button onClick={()=>setDnItems([])} className="text-[10px] text-red-400 font-bold hover:underline">Clear</button></div></div>
                                    <div className="flex-1 overflow-y-auto p-3">
                                        <div className="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2">
                                            {stockyardElements.filter(e => { 
                                                if (dnSearch && !String(e.elementId).toLowerCase().includes(dnSearch.toLowerCase())) return false; 
                                                if (dnmetaSearch && !checkMetaMatch(e, dnmetaSearch)) return false; 
                                                return true; 
                                            }).map(el => {
                                                const isSelected = dnItems.find(i=>i.id===el.id);
                                                return (
                                                    <div key={el.id} onClick={()=>toggleDnItem(el)} className={`p-2 border rounded cursor-pointer flex flex-col justify-between transition-all duration-100 ${isSelected ? 'btn-primary border-blue-600 shadow-md text-white' : 'bg-white border-slate-200 text-slate-700 hover:border-blue-400'}`}>
                                                        <div className="flex justify-between items-start mb-1">
                                                            <span className="font-bold text-xs truncate mr-1">{el.elementId}</span>
                                                            {isSelected && <Icon name="check" size={10} className="text-white flex-shrink-0"/>}
                                                        </div>
                                                        <div className="flex justify-between items-end text-[10px] opacity-90">
                                                            <span className="truncate max-w-[60px]">{el.type}</span>
                                                            <span className="font-mono">{parseFloat(el.volume||0).toFixed(2)}</span>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                        {stockyardElements.length === 0 && (<div className="flex flex-col items-center justify-center h-full text-slate-400 opacity-50 pb-10"><Icon name="box" size={32} className="mb-2"/><p className="text-sm font-bold">No stockyard items found.</p></div>)}
                                    </div>
                                </div>
                                <div className="mt-2 pt-2 border-t flex justify-between items-center bg-white"><div className="text-xs"><span className="text-slate-500">Selected: </span><span className="font-bold text-slate-900 text-lg ml-1">{dnItems.length}</span><span className="text-slate-300 mx-3">|</span><span className="text-slate-500">Vol: </span><span className="font-bold text-slate-900 text-lg ml-1">{dnItems.reduce((a,b)=>a+parseFloat(b.volume||0),0).toFixed(3)}</span><span className="text-slate-400 text-[10px] ml-1">m³</span></div><div className="flex gap-2"><button onClick={() => handleCreateDN(false)} disabled={dnItems.length===0} className="px-4 py-2 border border-blue-600 text-blue-600 rounded font-bold hover:bg-blue-50 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"><Icon name="save"/> Save & Next</button><button onClick={() => handleCreateDN(true)} disabled={dnItems.length===0} className="btn-primary disabled:opacity-50 disabled:cursor-not-allowed"><Icon name="fileText"/> Generate & Print</button></div></div>
                            </div>
                        </div>
                    )}

                    {histmodal && (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl p-6 h-[80vh] text-slate-900 flex flex-col"><div className="flex justify-between mb-4"><h3 className="font-bold text-xl">Delivery History</h3><button onClick={()=>{setHistmodal(false); setHistSearch(''); setHistProjFilter(''); setHistDateFrom(''); setHistDateTo('');}}><Icon name="x"/></button></div><div className="mb-4 space-y-3"><div className="relative"><Icon name="search" className="absolute left-3 top-2.5 text-slate-400" size={14}/><input type="text" placeholder="Search by Element ID or DN Number..." value={histSearch} onChange={e => setHistSearch(e.target.value)} className="w-full pl-9 p-2 border rounded text-sm bg-slate-50 focus:bg-white focus:border-blue-500 outline-none transition"/></div><div className="grid grid-cols-1 sm:grid-cols-4 gap-2"><select value={histProjFilter} onChange={e => setHistProjFilter(e.target.value)} className="p-2 border rounded text-sm bg-slate-50 focus:bg-white focus:border-blue-500 outline-none transition"><option value="">All Projects</option>{projects.map(p => <option key={p.id} value={p.projectId}>{p.projectId} - {p.name}</option>)}</select><input type="date" placeholder="From Date" value={histDateFrom} onChange={e => setHistDateFrom(e.target.value)} className="p-2 border rounded text-sm bg-slate-50 focus:bg-white focus:border-blue-500 outline-none transition"/><input type="date" placeholder="To Date" value={histDateTo} onChange={e => setHistDateTo(e.target.value)} className="p-2 border rounded text-sm bg-slate-50 focus:bg-white focus:border-blue-500 outline-none transition"/><button onClick={() => { setHistSearch(''); setHistProjFilter(''); setHistDateFrom(''); setHistDateTo(''); }} className="px-3 py-2 bg-slate-100 hover:bg-slate-200 rounded text-sm font-medium text-slate-700 transition">Clear Filters</button></div></div>
                        <div className="flex-1 overflow-auto border rounded-lg">
                            <table className="w-full text-xs text-left">
                                <thead className="bg-slate-100 sticky top-0 shadow-sm">
                                  <tr>
                                    <th className="p-3">
                                      <input type="checkbox" onChange={e => {
                                        if (e.target.checked) {
                                          setSelectedNotes(notes.filter(n => {
                                            // apply current filters
                                            const s = (histSearch || '').toLowerCase().trim();
                                            let match = true;
                                            if (s) {
                                              const dnmatch = (n.dnNumber || '').toLowerCase().includes(s);
                                              const itemmatch = (n.items || []).some(i => String(i.elementId || '').toLowerCase().includes(s));
                                              match = match && (dnmatch || itemmatch);
                                            }
                                            if (histProjFilter && String(n.project) !== String(histProjFilter)) match = false;
                                            if (histDateFrom && n.date < histDateFrom) match = false;
                                            if (histDateTo && n.date > histDateTo) match = false;
                                            return match;
                                          }).map(n => n.id));
                                        } else {
                                          setSelectedNotes([]);
                                        }
                                      }} checked={notes.filter(n => {
                                        // apply current filters
                                        const s = (histSearch || '').toLowerCase().trim();
                                        let match = true;
                                        if (s) {
                                          const dnmatch = (n.dnNumber || '').toLowerCase().includes(s);
                                          const itemmatch = (n.items || []).some(i => String(i.elementId || '').toLowerCase().includes(s));
                                          match = match && (dnmatch || itemmatch);
                                        }
                                        if (histProjFilter && String(n.project) !== String(histProjFilter)) match = false;
                                        if (histDateFrom && n.date < histDateFrom) match = false;
                                        if (histDateTo && n.date > histDateTo) match = false;
                                        return match;
                                      }).every(n => selectedNotes.includes(n.id)) && selectedNotes.length > 0} />
                                    </th>
                                    <th className="p-3">DN #</th>
                                    <th className="p-3">Date</th>
                                    <th className="p-3">Project</th>
                                    <th className="p-3 text-center">Items</th>
                                    <th className="p-3 text-center">Action</th>
                                  </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                  {notes.filter(n => {
                                    // ...existing filter logic...
                                    const s = (histSearch || '').toLowerCase().trim();
                                    let match = true;
                                    if (s) {
                                      const dnmatch = (n.dnNumber || '').toLowerCase().includes(s);
                                      const itemmatch = (n.items || []).some(i => String(i.elementId || '').toLowerCase().includes(s));
                                      match = match && (dnmatch || itemmatch);
                                    }
                                    if (histProjFilter && String(n.project) !== String(histProjFilter)) match = false;
                                    if (histDateFrom && n.date < histDateFrom) match = false;
                                    if (histDateTo && n.date > histDateTo) match = false;
                                    return match;
                                  }).map(n => (
                                    <tr key={n.id} className="hover:bg-blue-50 transition">
                                      <td className="p-3 text-center">
                                        <input type="checkbox" checked={selectedNotes.includes(n.id)} onChange={e => {
                                          if (e.target.checked) {
                                            setSelectedNotes([...selectedNotes, n.id]);
                                          } else {
                                            setSelectedNotes(selectedNotes.filter(id => id !== n.id));
                                          }
                                        }} />
                                      </td>
                                      {/* ...existing columns... */}
                                      <td className="p-3 font-mono font-bold text-slate-700">{n.dnNumber}{histSearch && n.items.some(i => i.elementId.toLowerCase().includes(histSearch.toLowerCase())) && (<span className="block text-[9px] text-emerald-600 font-normal mt-1">Contains "{histSearch}"</span>)}</td>
                                      <td className="p-3">{formatDate(n.date)}</td>
                                      <td className="p-3">{n.project}</td>
                                      <td className="p-3 text-center font-bold">{n.items.length}</td>
                                      <td className="p-3 text-center flex justify-center gap-3">
                                        {/* ...existing action buttons... */}
                                        <button onClick={()=>openDNInPopup(n)} className="text-blue-600 hover:text-blue-800" title="View Note"><Icon name="fileText"/> View</button>
                                        <button onClick={() => setEditDN(n)} className="text-slate-600 hover:text-slate-800" title="Edit Items"><Icon name="list"/></button>
                                        <button onClick={() => handleChangeDNNumber(n.id, n.dnNumber)} className="text-amber-600 hover:text-amber-800" title="Change DN Number"><Icon name="pencil"/></button>
                                        <button onClick={() => handleChangeDNDate(n.id, n.date, n.items)} className="text-purple-600 hover:text-purple-800" title="Change Delivery Date"><Icon name="calendar"/></button>
                                        <button onClick={() => handleDeleteNote(n.id)} className="text-red-400 hover:text-red-600" title="Delete Record"><Icon name="trash"/></button>
                                      </td>
                                    </tr>
                                  ))}
                                </tbody>
                            </table>
                            {/* Print Selected Button */}
                            {selectedNotes.length > 0 && (
                              <div className="flex justify-end mt-2">
                                {histSelected.length > 0 && (
    <div className="flex gap-2">
      {histSelected.length > 0 && (
        <button
          onClick={() => {
            const selectedDNs = notes.filter(n => histSelected.includes(n.id));
            setBulkPrintNotes(selectedDNs);
            setHistmodal(false);
          }}
          className="bg-blue-600 text-white px-3 py-1 rounded text-sm font-bold hover:bg-blue-700 flex items-center gap-2 shadow-sm"
        >
          <Icon name="print"/> Print Selected ({histSelected.length})
        </button>
      )}
      <button onClick={() => setHistSelected([])} className="bg-slate-200 text-slate-700 px-4 py-2 rounded font-bold hover:bg-slate-300 print:hidden">
        Clear Selection
      </button>
    </div>
)}
                              </div>
                            )}
                        </div>
                    </div></div>)}
                    {histmodal && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl p-6 h-[80vh] text-slate-900 flex flex-col">
                                <div className="flex justify-between mb-4">
                                    <h3 className="font-bold text-xl">Delivery History</h3>
                                    <div className="flex gap-2">
                                        {histSelected.length > 0 && (
                                            <button onClick={() => {
                                                const selectedDNs = notes.filter(n => histSelected.includes(n.id));
                                                setBulkPrintNotes(selectedDNs);
                                                setHistmodal(false);
                                            }} className="bg-blue-600 text-white px-3 py-1 rounded text-sm font-bold hover:bg-blue-700 flex items-center gap-2 shadow-sm">
                                                <Icon name="print"/> Print Selected ({histSelected.length})
                                            </button>
                                        )}
                                        <button onClick={()=>{setHistmodal(false); setHistSearch(''); setHistProjFilter(''); setHistDateFrom(''); setHistDateTo(''); setHistSelected([]);}}><Icon name="x"/></button>
                                    </div>
                                </div>
                                <div className="mb-4 space-y-3">
                                    <div className="relative"><Icon name="search" className="absolute left-3 top-2.5 text-slate-400" size={14}/><input type="text" placeholder="Search by Element ID or DN Number..." value={histSearch} onChange={e => setHistSearch(e.target.value)} className="w-full pl-9 p-2 border rounded text-sm bg-slate-50 focus:bg-white focus:border-blue-500 outline-none transition"/></div>
                                    <div className="grid grid-cols-1 sm:grid-cols-4 gap-2"><select value={histProjFilter} onChange={e => setHistProjFilter(e.target.value)} className="p-2 border rounded text-sm bg-slate-50 focus:bg-white focus:border-blue-500 outline-none transition"><option value="">All Projects</option>{projects.map(p => <option key={p.id} value={p.projectId}>{p.projectId} - {p.name}</option>)}</select><input type="date" placeholder="From Date" value={histDateFrom} onChange={e => setHistDateFrom(e.target.value)} className="p-2 border rounded text-sm bg-slate-50 focus:bg-white focus:border-blue-500 outline-none transition"/><input type="date" placeholder="To Date" value={histDateTo} onChange={e => setHistDateTo(e.target.value)} className="p-2 border rounded text-sm bg-slate-50 focus:bg-white focus:border-blue-500 outline-none transition"/><button onClick={() => { setHistSearch(''); setHistProjFilter(''); setHistDateFrom(''); setHistDateTo(''); }} className="px-3 py-2 bg-slate-100 hover:bg-slate-200 rounded text-sm font-medium text-slate-700 transition">Clear Filters</button></div>
                                </div>
                                <div className="flex-1 overflow-auto border rounded-lg">
                                    <table className="w-full text-xs text-left">
                                        <thead className="bg-slate-100 sticky top-0 shadow-sm">
                                            <tr>
                                                <th className="p-3 w-10 text-center"><input type="checkbox" className="w-4 h-4 accent-blue-600" onChange={handleSelectAll} checked={filteredNotes.length > 0 && filteredNotes.every(n => histSelected && histSelected.includes(n.id))} /></th>
                                                <th className="p-3">DN #</th><th className="p-3">Date</th><th className="p-3">Project</th><th className="p-3 text-center">Items</th><th className="p-3 text-center">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {filteredNotes.map(n => (
                                                <tr key={n.id} className={`hover:bg-blue-50 transition ${histSelected && histSelected.includes(n.id) ? 'bg-blue-50' : ''}`}>
                                                    <td className="p-3 text-center"><input type="checkbox" className="w-4 h-4 accent-blue-600" checked={histSelected && histSelected.includes(n.id)} onChange={() => setHistSelected(prev => prev.includes(n.id) ? prev.filter(id => id !== n.id) : [...prev, n.id])} /></td>
                                                    <td className="p-3 font-mono font-bold text-slate-700">{n.dnNumber}{histSearch && n.items.some(i => i.elementId.toLowerCase().includes(histSearch.toLowerCase())) && (<span className="block text-[9px] text-emerald-600 font-normal mt-1">Contains "{histSearch}"</span>)}</td>
                                                    <td className="p-3">{formatDate(n.date)}</td>
                                                    <td className="p-3">{n.project}</td>
                                                    <td className="p-3 text-center font-bold">{n.items.length}</td>
                                                    <td className="p-3 text-center flex justify-center gap-3"><button onClick={()=>openDNInPopup(n)} className="text-blue-600 hover:text-blue-800" title="View Note"><Icon name="fileText"/> View</button><button onClick={() => setEditDN(n)} disabled={!canEdit()} className="text-slate-600 hover:text-slate-800 disabled:text-slate-300 disabled:cursor-not-allowed" title="Edit Items"><Icon name="list"/></button><button onClick={() => handleChangeDNNumber(n.id, n.dnNumber)} disabled={!canEdit()} className="text-amber-600 hover:text-amber-800 disabled:text-amber-200 disabled:cursor-not-allowed" title="Change DN Number"><Icon name="pencil"/></button><button onClick={() => handleChangeDNDate(n.id, n.date, n.items)} disabled={!canEdit()} className="text-purple-600 hover:text-purple-800 disabled:text-purple-200 disabled:cursor-not-allowed" title="Change Delivery Date"><Icon name="calendar"/></button><button onClick={() => handleDeleteNote(n.id)} disabled={!canEdit()} className="text-red-400 hover:text-red-600 disabled:text-red-200 disabled:cursor-not-allowed" title="Delete Record"><Icon name="trash"/></button></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {editDN && (<div className="fixed inset-0 bg-black/60 z-[80] flex items-center justify-center p-4 backdrop-blur-sm"><div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 flex flex-col max-h-[90vh] text-slate-900"><div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg text-slate-800">Edit Items - {editDN.dnNumber}</h3><button onClick={() => { setEditDN(null); setDnSearch(''); }} className="p-1 hover:bg-slate-100 rounded-full"><Icon name="x"/></button></div><div className="bg-blue-50 p-3 rounded text-sm text-blue-800 mb-4 flex gap-2 items-start"><Icon name="info" className="mt-0.5"/><p>Removing an item here will revert its status to <b>Stockyard</b>.<br/>Adding an item will change its status to <b>Shipped</b>.</p></div><div className="flex-1 overflow-auto border rounded-lg mb-4"><table className="w-full text-sm text-left"><thead className="bg-slate-100 sticky top-0"><tr><th className="p-3">Element ID</th><th className="p-3">Type</th><th className="p-3 text-center">Qty</th><th className="p-3 text-right">Action</th></tr></thead><tbody className="divide-y divide-slate-100">{editDN.items.map((item, idx) => (<tr key={idx} className="hover:bg-slate-50"><td className="p-3 font-bold">{item.elementId}</td><td className="p-3">{item.type}</td><td className="p-3 text-center"><div className="flex items-center justify-center gap-1"><button onClick={() => handleUpdateDNItemQty(editDN, item, (item.qty || 1) - 1)} disabled={(item.qty || 1) <= 1} className="w-6 h-6 flex items-center justify-center bg-slate-100 hover:bg-slate-200 disabled:bg-slate-50 disabled:text-slate-300 rounded text-xs font-bold transition">-</button><input type="number" min="1" value={item.qty || 1} onChange={e => handleUpdateDNItemQty(editDN, item, e.target.value)} className="w-14 text-center border rounded px-1 py-0.5 font-bold"/><button onClick={() => handleUpdateDNItemQty(editDN, item, (item.qty || 1) + 1)} className="w-6 h-6 flex items-center justify-center bg-slate-100 hover:bg-slate-200 rounded text-xs font-bold transition">+</button></div></td><td className="p-3 text-right"><button onClick={() => handleRemoveDNItem(editDN, item)} className="text-red-500 hover:text-red-700 font-bold text-xs border border-red-200 bg-red-50 px-2 py-1 rounded hover:bg-red-100 transition">Remove</button></td></tr>))}{editDN.items.length === 0 && (<tr><td colSpan="4" className="p-4 text-center text-slate-400 italic">No items in this note.</td></tr>)}</tbody></table></div><div className="border-t pt-4"><h4 className="font-bold text-sm text-slate-700 mb-2 flex items-center gap-2"><Icon name="plus"/> Add Stockyard Elements</h4><div className="relative mb-2"><Icon name="search" className="absolute left-3 top-2.5 text-slate-400" size={12}/><input type="text" placeholder="Search ID..." value={dnSearch} onChange={e => setDnSearch(e.target.value)} className="w-full pl-8 p-2 border rounded text-xs bg-slate-50 focus:bg-white outline-none"/></div><div className="max-h-32 overflow-y-auto border rounded bg-slate-50 p-2 grid grid-cols-2 sm:grid-cols-3 gap-2">{stockyardElements.filter(e => !dnSearch || e.elementId.toLowerCase().includes(dnSearch.toLowerCase())).map(el => (<button key={el.id} onClick={() => handleAddDNItem(editDN, el)} className="text-left p-2 bg-white border border-slate-200 rounded hover:border-blue-500 hover:shadow-sm transition group"><div className="font-bold text-xs text-slate-800 group-hover:text-blue-700">{el.elementId}</div><div className="text-[10px] text-slate-500">{el.type}</div></button>))}{stockyardElements.length === 0 && <div className="col-span-full text-center text-slate-400 text-xs italic py-2">No stockyard items available.</div>}</div></div><div className="mt-4 flex justify-end"><button onClick={() => { setEditDN(null); setDnSearch(''); }} className="btn-primary">Done</button></div></div></div>)}
                    
                    {/* ADD ELEmENT mODAL */}
                    {isAddOpen && (<div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"><div className="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full"><h3 className="font-bold text-lg text-slate-800 mb-4">New Element</h3><form onSubmit={handleAddElem} className="space-y-4"><select name="proj" className="w-full p-3 border rounded bg-white text-slate-900 font-bold outline-none focus:border-blue-500" required><option value="">Select Project</option>{projects.filter(p => !p.archived).map(p => <option key={p.id} value={p.id}>{p.projectId} - {p.name}</option>)}</select><input name="id" placeholder="Element ID" className="w-full p-3 border rounded bg-white text-slate-900" required /><input name="type" placeholder="Type" className="w-full p-3 border rounded bg-white text-slate-900" /><div className="grid grid-cols-3 gap-2"><input name="len" placeholder="Length" className="w-full p-3 border rounded bg-white text-slate-900 text-sm"/><input name="wh" placeholder="Width" className="w-full p-3 border rounded bg-white text-slate-900 text-sm"/><input name="vol" placeholder="Vol (m³)" className="w-full p-3 border rounded bg-white text-slate-900 text-sm font-bold"/></div><div className="flex justify-end gap-2"><button type="button" onClick={() => setIsAddOpen(false)} className="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded">Cancel</button><button type="submit" className="btn-primary">Add</button></div></form></div></div>)}
                    
                    {/* ADD PROJECT mODAL */}
                    {isProjOpen && (<div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4"><div className="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full transform scale-100 transition-all"><h3 className="font-bold text-xl text-slate-800 mb-6 flex items-center gap-2"><Icon name="folderPlus" className="text-blue-600"/> New Project</h3><form onSubmit={handleAddProj} className="space-y-4"><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Project ID / Number</label><input name="id" placeholder="e.g. 2023-001" className="w-full p-3 border-2 border-slate-200 rounded-lg bg-white text-slate-900 font-bold placeholder-slate-400 focus:border-blue-500 outline-none transition" required autoComplete="off"/></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Project Name</label><input name="name" placeholder="e.g. Skyline Towers" className="w-full p-3 border-2 border-slate-200 rounded-lg bg-white text-slate-900 font-bold placeholder-slate-400 focus:border-blue-500 outline-none transition" required autoComplete="off"/></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Shipping Address</label><input name="address" placeholder="e.g. Plot 45, Dubai Industrial City" className="w-full p-3 border-2 border-slate-200 rounded-lg bg-white text-slate-900 font-bold placeholder-slate-400 focus:border-blue-500 outline-none transition"/></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Contact No</label><input name="contact" placeholder="e.g. +971 50 000 0000" className="w-full p-3 border-2 border-slate-200 rounded-lg bg-white text-slate-900 font-bold placeholder-slate-400 focus:border-blue-500 outline-none transition"/></div><div className="flex justify-end gap-3 mt-6"><button type="button" onClick={() => setIsProjOpen(false)} className="px-5 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg transition">Cancel</button><button type="submit" className="btn-primary text-white px-6 py-2 rounded-lg font-bold shadow-lg transition">Create Project</button></div></form></div></div>)}

                    {editingProj && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full transform scale-100 transition-all">
                                <h3 className="font-bold text-xl text-slate-800 mb-6 flex items-center gap-2"><Icon name="pencil" className="text-blue-600"/> Edit Project</h3>
                                <form onSubmit={handleUpdateProject} className="space-y-4">
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Project ID (Read Only)</label><input value={editingProj.projectId} readOnly className="w-full p-3 border rounded bg-slate-100 text-slate-500 font-bold cursor-not-allowed"/></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Project Name</label><input name="name" defaultValue={editingProj.name} className="w-full p-3 border-2 border-slate-200 rounded-lg bg-white text-slate-900 font-bold placeholder-slate-400 focus:border-blue-500 outline-none transition"/></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Shipping Address</label><input name="address" defaultValue={editingProj.address} className="w-full p-3 border-2 border-slate-200 rounded-lg bg-white text-slate-900 font-bold placeholder-slate-400 focus:border-blue-500 outline-none transition"/></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Contact No</label><input name="contact" defaultValue={editingProj.contactNo} className="w-full p-3 border-2 border-slate-200 rounded-lg bg-white text-slate-900 font-bold placeholder-slate-400 focus:border-blue-500 outline-none transition"/></div>
                                    <div className="flex justify-end gap-3 mt-6"><button type="button" onClick={() => setEditingProj(null)} className="px-5 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg transition">Cancel</button><button type="submit" className="btn-primary text-white px-6 py-2 rounded-lg font-bold shadow-lg transition">Save Changes</button></div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
</body>
</html>
</html>
</body>
</html>
</html>
</body>
</html>
</body>
</html>
</html>
